<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Statistiche Magazzino - Report Dettagliato</title>
  <style>
    @page {
      size: A4;
      margin: 1.2cm;
      @bottom-center {
        content: "Pagina " counter(page) " di " counter(pages);
        font-size: 8pt;
        color: #9ca3af;
      }
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
      font-size: 9pt;
      color: #333;
      line-height: 1.4;
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 3px solid #0056a6;
      padding-bottom: 12px;
      margin-bottom: 15px;
    }
    
    .header-left h1 {
      font-size: 20pt;
      color: #0056a6;
      margin-bottom: 3px;
    }
    
    .header-left .subtitle {
      font-size: 10pt;
      color: #6b7280;
    }
    
    .header-right {
      text-align: right;
      font-size: 8pt;
      color: #6b7280;
      background: #f8fafc;
      padding: 8px 12px;
      border-radius: 6px;
    }
    
    .header-right .label {
      color: #9ca3af;
      font-size: 7pt;
      text-transform: uppercase;
    }
    
    .header-right .value {
      color: #374151;
      font-weight: bold;
    }
    
    /* Sections */
    .section {
      margin-bottom: 18px;
      page-break-inside: avoid;
    }
    
    .section-title {
      font-size: 11pt;
      font-weight: bold;
      color: #0056a6;
      margin-bottom: 10px;
      padding-bottom: 4px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .section-title .icon {
      font-size: 12pt;
    }
    
    /* Summary Box */
    .summary-box {
      background: linear-gradient(135deg, #0056a6 0%, #003d75 100%);
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 18px;
    }
    
    .summary-box h2 {
      font-size: 12pt;
      margin-bottom: 10px;
      opacity: 0.9;
    }
    
    .summary-grid {
      display: flex;
      justify-content: space-between;
    }
    
    .summary-item {
      text-align: center;
      flex: 1;
    }
    
    .summary-value {
      font-size: 22pt;
      font-weight: bold;
    }
    
    .summary-label {
      font-size: 8pt;
      opacity: 0.8;
      margin-top: 2px;
    }
    
    .summary-delta {
      font-size: 8pt;
      margin-top: 3px;
      padding: 2px 6px;
      border-radius: 10px;
      display: inline-block;
    }
    
    .delta-up {
      background: rgba(34, 197, 94, 0.3);
      color: #86efac;
    }
    
    .delta-down {
      background: rgba(239, 68, 68, 0.3);
      color: #fca5a5;
    }
    
    .delta-neutral {
      background: rgba(255, 255, 255, 0.2);
    }
    
    /* KPI Grid */
    .kpi-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .kpi-card {
      flex: 1 1 18%;
      min-width: 90px;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 10px 8px;
      text-align: center;
    }
    
    .kpi-card.highlight {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      border-color: #0056a6;
    }
    
    .kpi-value {
      font-size: 14pt;
      font-weight: bold;
      color: #0056a6;
    }
    
    .kpi-value.green { color: #16a34a; }
    .kpi-value.red { color: #dc2626; }
    .kpi-value.blue { color: #2563eb; }
    .kpi-value.orange { color: #d97706; }
    .kpi-value.purple { color: #7c3aed; }
    
    .kpi-label {
      font-size: 7pt;
      color: #6b7280;
      margin-top: 3px;
      text-transform: uppercase;
    }
    
    .kpi-sublabel {
      font-size: 7pt;
      color: #9ca3af;
      margin-top: 2px;
    }
    
    .kpi-delta {
      font-size: 7pt;
      margin-top: 3px;
      font-weight: bold;
    }
    
    .kpi-delta.positive { color: #16a34a; }
    .kpi-delta.negative { color: #dc2626; }
    
    /* Charts */
    .charts-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .chart-container {
      flex: 1;
      text-align: center;
      background: #fafafa;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    
    .chart-container img {
      max-width: 100%;
      height: auto;
    }
    
    .chart-title {
      font-size: 9pt;
      font-weight: bold;
      color: #374151;
      margin-bottom: 8px;
    }
    
    .chart-caption {
      font-size: 7pt;
      color: #9ca3af;
      margin-top: 6px;
    }
    
    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 8pt;
    }
    
    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      background: #f1f5f9;
      font-weight: bold;
      color: #374151;
      font-size: 7pt;
      text-transform: uppercase;
    }
    
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    
    tbody tr:hover {
      background: #f0f9ff;
    }
    
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .text-green { color: #16a34a; }
    .text-red { color: #dc2626; }
    .text-blue { color: #2563eb; }
    .text-orange { color: #d97706; }
    .text-bold { font-weight: bold; }
    
    /* Rank badge */
    .rank {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      text-align: center;
      line-height: 16px;
      font-size: 7pt;
      font-weight: bold;
      margin-right: 4px;
    }
    
    .rank-1 { background: #fbbf24; color: #78350f; }
    .rank-2 { background: #d1d5db; color: #374151; }
    .rank-3 { background: #f59e0b; color: #78350f; }
    .rank-default { background: #e5e7eb; color: #6b7280; }
    
    /* Progress bar */
    .progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 3px;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 3px;
    }
    
    .progress-green { background: #22c55e; }
    .progress-red { background: #ef4444; }
    .progress-blue { background: #3b82f6; }
    .progress-orange { background: #f59e0b; }
    
    /* Two columns layout */
    .two-cols {
      display: flex;
      gap: 15px;
    }
    
    .col {
      flex: 1;
    }
    
    /* Info boxes */
    .info-box {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 8pt;
    }
    
    .info-box.blue {
      background: #eff6ff;
      border-color: #93c5fd;
    }
    
    .info-box-title {
      font-weight: bold;
      color: #92400e;
      margin-bottom: 4px;
    }
    
    .info-box.blue .info-box-title {
      color: #1e40af;
    }
    
    /* Footer */
    .footer {
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #e5e7eb;
      font-size: 7pt;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
    }
    
    /* Page break */
    .page-break {
      page-break-before: always;
    }
    
    /* Mini stats */
    .mini-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .mini-stat {
      flex: 1;
      background: #f8fafc;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      border-left: 3px solid #0056a6;
    }
    
    .mini-stat-value {
      font-size: 12pt;
      font-weight: bold;
      color: #374151;
    }
    
    .mini-stat-label {
      font-size: 7pt;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>üìä Report Statistiche Magazzino</h1>
      <div class="subtitle">Analisi dettagliata delle operazioni di magazzino</div>
    </div>
    <div class="header-right">
      <div><span class="label">Periodo Analizzato</span></div>
      <div class="value">{{ periodo_inizio }} - {{ periodo_fine }}</div>
      <div style="margin-top: 5px;"><span class="label">Range</span> {{ range_label }}</div>
      <div><span class="label">Generato il</span> {{ generated_at }}</div>
    </div>
  </div>
  
  <!-- Executive Summary -->
  <div class="summary-box">
    <h2>üìã Riepilogo Esecutivo</h2>
    <div class="summary-grid">
      <div class="summary-item">
        <div class="summary-value">{{ kpi.totale_movimenti }}</div>
        <div class="summary-label">Operazioni Totali</div>
        {% if kpi.delta_movimenti != 0 %}
        <div class="summary-delta {{ 'delta-up' if kpi.delta_movimenti > 0 else 'delta-down' }}">
          {{ '+' if kpi.delta_movimenti > 0 else '' }}{{ "%.1f"|format(kpi.delta_movimenti) }}% vs periodo prec.
        </div>
        {% else %}
        <div class="summary-delta delta-neutral">= periodo prec.</div>
        {% endif %}
      </div>
      <div class="summary-item">
        <div class="summary-value" style="color: #86efac;">{{ kpi.totale_carichi }}</div>
        <div class="summary-label">Quantit√† Caricata</div>
        {% if kpi.delta_carichi != 0 %}
        <div class="summary-delta {{ 'delta-up' if kpi.delta_carichi > 0 else 'delta-down' }}">
          {{ '+' if kpi.delta_carichi > 0 else '' }}{{ "%.1f"|format(kpi.delta_carichi) }}%
        </div>
        {% endif %}
      </div>
      <div class="summary-item">
        <div class="summary-value" style="color: #fca5a5;">{{ kpi.totale_scarichi }}</div>
        <div class="summary-label">Quantit√† Scaricata</div>
        {% if kpi.delta_scarichi != 0 %}
        <div class="summary-delta {{ 'delta-up' if kpi.delta_scarichi > 0 else 'delta-down' }}">
          {{ '+' if kpi.delta_scarichi > 0 else '' }}{{ "%.1f"|format(kpi.delta_scarichi) }}%
        </div>
        {% endif %}
      </div>
      <div class="summary-item">
        <div class="summary-value" style="color: #93c5fd;">{{ kpi.totale_trasferimenti }}</div>
        <div class="summary-label">Trasferimenti</div>
      </div>
      <div class="summary-item">
        <div class="summary-value">{{ kpi.prodotti_movimentati }}</div>
        <div class="summary-label">Prodotti Distinti</div>
      </div>
    </div>
  </div>
  
  <!-- KPI Dettagliati -->
  <div class="section">
    <div class="section-title"><span class="icon">üìà</span> Indicatori di Performance (KPI)</div>
    <div class="kpi-grid">
      <div class="kpi-card highlight">
        <div class="kpi-value">{{ kpi.totale_movimenti }}</div>
        <div class="kpi-label">Movimenti</div>
        <div class="kpi-delta {{ 'positive' if kpi.delta_movimenti >= 0 else 'negative' }}">
          {{ '+' if kpi.delta_movimenti >= 0 else '' }}{{ "%.1f"|format(kpi.delta_movimenti) }}%
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value green">{{ kpi.totale_carichi }}</div>
        <div class="kpi-label">Carichi (qta)</div>
        <div class="kpi-delta {{ 'positive' if kpi.delta_carichi >= 0 else 'negative' }}">
          {{ '+' if kpi.delta_carichi >= 0 else '' }}{{ "%.1f"|format(kpi.delta_carichi) }}%
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value red">{{ kpi.totale_scarichi }}</div>
        <div class="kpi-label">Scarichi (qta)</div>
        <div class="kpi-delta {{ 'positive' if kpi.delta_scarichi >= 0 else 'negative' }}">
          {{ '+' if kpi.delta_scarichi >= 0 else '' }}{{ "%.1f"|format(kpi.delta_scarichi) }}%
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value blue">{{ kpi.totale_trasferimenti }}</div>
        <div class="kpi-label">Trasferimenti</div>
        <div class="kpi-delta {{ 'positive' if kpi.delta_trasferimenti >= 0 else 'negative' }}">
          {{ '+' if kpi.delta_trasferimenti >= 0 else '' }}{{ "%.1f"|format(kpi.delta_trasferimenti) }}%
        </div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value purple">{{ kpi.prodotti_movimentati }}</div>
        <div class="kpi-label">Prodotti</div>
        <div class="kpi-sublabel">movimentati</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value orange">{{ "%.1f"|format(kpi.media_giornaliera) }}</div>
        <div class="kpi-label">Media/Giorno</div>
        <div class="kpi-sublabel">movimenti</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">{{ kpi.giorni_attivi }}</div>
        <div class="kpi-label">Giorni Attivi</div>
        <div class="kpi-sublabel">con operazioni</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value">{{ kpi.utenti_attivi }}</div>
        <div class="kpi-label">Utenti Attivi</div>
        <div class="kpi-sublabel">nel periodo</div>
      </div>
    </div>
  </div>
  
  <!-- Grafici -->
  {% if trend_chart or pie_chart %}
  <div class="section">
    <div class="section-title"><span class="icon">üìä</span> Analisi Grafica</div>
    <div class="charts-row">
      {% if trend_chart %}
      <div class="chart-container" style="flex: 2;">
        <div class="chart-title">Trend Movimenti nel Periodo</div>
        <img src="data:image/png;base64,{{ trend_chart }}" alt="Trend">
        <div class="chart-caption">Andamento giornaliero/mensile di carichi e scarichi</div>
      </div>
      {% endif %}
      
      {% if pie_chart %}
      <div class="chart-container">
        <div class="chart-title">Distribuzione per Tipo</div>
        <img src="data:image/png;base64,{{ pie_chart }}" alt="Distribuzione">
        <div class="chart-caption">Ripartizione quantit√† per tipo operazione</div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  <!-- Bar chart se presente -->
  {% if bar_chart %}
  <div class="section">
    <div class="chart-container" style="max-width: 100%;">
      <div class="chart-title">Confronto con Periodo Precedente</div>
      <img src="data:image/png;base64,{{ bar_chart }}" alt="Confronto">
      <div class="chart-caption">Variazione rispetto al periodo precedente ({{ periodo_precedente }})</div>
    </div>
  </div>
  {% endif %}
  
  <!-- Dettaglio per Stato -->
  {% if stati_giacenze %}
  <div class="section">
    <div class="section-title"><span class="icon">üè∑Ô∏è</span> Giacenze per Stato Merce</div>
    <div class="mini-stats">
      {% for stato in stati_giacenze %}
      <div class="mini-stat">
        <div class="mini-stat-value">{{ stato.quantita }}</div>
        <div class="mini-stat-label">{{ stato.stato|replace('_', ' ')|title }}</div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
  
  <!-- Due colonne: Top Prodotti e Utenti -->
  <div class="section">
    <div class="two-cols">
      <!-- Top Prodotti -->
      <div class="col">
        <div class="section-title"><span class="icon">üèÜ</span> Top 10 Prodotti Movimentati</div>
        <table>
          <thead>
            <tr>
              <th style="width: 30px;">#</th>
              <th>Codice</th>
              <th>Nome Prodotto</th>
              <th class="text-right">Mov.</th>
              <th class="text-right">Qta</th>
              <th class="text-right">%</th>
            </tr>
          </thead>
          <tbody>
            {% for p in top_prodotti %}
            <tr>
              <td>
                <span class="rank {% if loop.index == 1 %}rank-1{% elif loop.index == 2 %}rank-2{% elif loop.index == 3 %}rank-3{% else %}rank-default{% endif %}">
                  {{ loop.index }}
                </span>
              </td>
              <td><strong>{{ p.codice }}</strong></td>
              <td>{{ p.nome[:30] }}{% if p.nome|length > 30 %}...{% endif %}</td>
              <td class="text-right">{{ p.movimenti }}</td>
              <td class="text-right text-bold">{{ p.quantita }}</td>
              <td class="text-right">
                <div>{{ "%.1f"|format(p.percentuale) }}%</div>
                <div class="progress-bar">
                  <div class="progress-fill progress-blue" style="width: {{ p.percentuale }}%;"></div>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center" style="color: #9ca3af; padding: 20px;">Nessun dato disponibile</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Utenti -->
      <div class="col">
        <div class="section-title"><span class="icon">üë•</span> Attivit√† per Utente</div>
        <table>
          <thead>
            <tr>
              <th>Utente</th>
              <th class="text-right text-green">Carichi</th>
              <th class="text-right text-red">Scarichi</th>
              <th class="text-right text-blue">Trasf.</th>
              <th class="text-right">Totale</th>
              <th class="text-right">%</th>
            </tr>
          </thead>
          <tbody>
            {% for u in utenti %}
            <tr>
              <td><strong>{{ u.username }}</strong></td>
              <td class="text-right text-green">{{ u.carichi or 0 }}</td>
              <td class="text-right text-red">{{ u.scarichi or 0 }}</td>
              <td class="text-right text-blue">{{ u.trasferimenti or 0 }}</td>
              <td class="text-right text-bold">{{ u.totale }}</td>
              <td class="text-right">
                <div>{{ "%.1f"|format(u.percentuale) }}%</div>
                <div class="progress-bar">
                  <div class="progress-fill progress-orange" style="width: {{ u.percentuale }}%;"></div>
                </div>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-center" style="color: #9ca3af; padding: 20px;">Nessun dato disponibile</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Distribuzione per Magazzino -->
  {% if magazzini %}
  <div class="section">
    <div class="section-title"><span class="icon">üè≠</span> Movimenti per Magazzino</div>
    <table>
      <thead>
        <tr>
          <th>Magazzino</th>
          <th class="text-right">Entrate</th>
          <th class="text-right">Uscite</th>
          <th class="text-right">Saldo</th>
          <th class="text-right">% Attivit√†</th>
        </tr>
      </thead>
      <tbody>
        {% for m in magazzini %}
        <tr>
          <td><strong>{{ m.nome }}</strong></td>
          <td class="text-right text-green">+{{ m.entrate }}</td>
          <td class="text-right text-red">-{{ m.uscite }}</td>
          <td class="text-right text-bold {{ 'text-green' if m.saldo >= 0 else 'text-red' }}">
            {{ '+' if m.saldo >= 0 else '' }}{{ m.saldo }}
          </td>
          <td class="text-right">
            <div>{{ "%.1f"|format(m.percentuale) }}%</div>
            <div class="progress-bar">
              <div class="progress-fill progress-blue" style="width: {{ m.percentuale }}%;"></div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  
  <!-- Ultimi Movimenti (campione) -->
  {% if ultimi_movimenti %}
  <div class="section page-break">
    <div class="section-title"><span class="icon">üìú</span> Ultimi 20 Movimenti Registrati</div>
    <table>
      <thead>
        <tr>
          <th>Data/Ora</th>
          <th>Tipo</th>
          <th>Codice</th>
          <th>Prodotto</th>
          <th class="text-right">Qta</th>
          <th>Da ‚Üí A</th>
          <th>Utente</th>
        </tr>
      </thead>
      <tbody>
        {% for m in ultimi_movimenti %}
        <tr>
          <td>{{ m.data_ora }}</td>
          <td>
            <span class="{% if m.tipo == 'CARICO' %}text-green{% elif m.tipo == 'SCARICO' %}text-red{% else %}text-blue{% endif %} text-bold">
              {{ m.tipo }}
            </span>
          </td>
          <td><strong>{{ m.codice }}</strong></td>
          <td>{{ m.prodotto[:25] }}{% if m.prodotto|length > 25 %}...{% endif %}</td>
          <td class="text-right text-bold">{{ m.quantita }}</td>
          <td>{{ m.da_ubicazione or '-' }} ‚Üí {{ m.a_ubicazione or '-' }}</td>
          <td>{{ m.utente }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  
  <!-- Alert prodotti sotto soglia -->
  {% if prodotti_sotto_soglia %}
  <div class="section">
    <div class="section-title"><span class="icon">‚ö†Ô∏è</span> Prodotti Sotto Soglia Minima</div>
    <div class="info-box">
      <div class="info-box-title">Attenzione: {{ prodotti_sotto_soglia|length }} prodotti richiedono rifornimento</div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Codice</th>
          <th>Nome Prodotto</th>
          <th class="text-right">Giacenza</th>
          <th class="text-right">Soglia Min.</th>
          <th class="text-right">Mancanti</th>
        </tr>
      </thead>
      <tbody>
        {% for p in prodotti_sotto_soglia %}
        <tr>
          <td><strong>{{ p.codice }}</strong></td>
          <td>{{ p.nome }}</td>
          <td class="text-right text-red text-bold">{{ p.giacenza }}</td>
          <td class="text-right">{{ p.soglia }}</td>
          <td class="text-right text-orange text-bold">{{ p.mancanti }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
  
  <!-- Note finali -->
  <div class="info-box blue">
    <div class="info-box-title">‚ÑπÔ∏è Note sul Report</div>
    <ul style="margin-left: 15px; margin-top: 5px;">
      <li>I dati sono aggiornati al momento della generazione del report</li>
      <li>Le variazioni percentuali sono calcolate rispetto al periodo precedente di pari durata</li>
      <li>I valori "Media/Giorno" considerano solo i giorni con almeno un'operazione</li>
    </ul>
  </div>
  
  <!-- Footer -->
  <div class="footer">
    <span>Pharmagest - Sistema Gestione Magazzino</span>
    <span>Report generato automaticamente il {{ generated_at }}</span>
    <span>¬© {{ anno_corrente }} - Tutti i diritti riservati</span>
  </div>
</body>
</html>
