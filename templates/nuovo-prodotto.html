{% extends "base.html" %}

{% block title %}Nuovo Prodotto - Pharmagest{% endblock %}

{% block page_title_full %}Nuovo Prodotto - Pharmagest ({{ app_version }}){% endblock %}
{% block page_title_short %}Nuovo Prodotto{% endblock %}

{% block extra_css %}
<style>
* {
  box-sizing: border-box;
}

/* Form container minimal */
.form-container {
  background: transparent;
  padding: 1rem 0;
}

/* Form title */
.form-title {
  font-size: 1rem;
  font-weight: 600;
  color: #0056a6;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.dark .form-title {
  color: #60a5fa;
}

.form-title i {
  font-size: 1rem;
}

/* Form fields compact */
.compact-form label {
  display: block;
  font-size: 0.75rem;
  font-weight: 500;
  color: #64748b;
  margin-bottom: 0.25rem;
  margin-top: 0.75rem;
}

.dark .compact-form label {
  color: #9ca3af;
}

.compact-form input[type="text"],
.compact-form input[type="number"],
.compact-form select {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #e2e8f0;
  border-radius: 6px;
  background: #fff;
  color: #1e293b;
  font-size: 0.875rem;
  transition: border-color 0.15s ease;
}

.dark .compact-form input[type="text"],
.dark .compact-form input[type="number"],
.dark .compact-form select {
  background: #1a1a1a;
  border-color: #333;
  color: #fff;
}

.compact-form input:focus,
.compact-form select:focus {
  outline: none;
  border-color: #0056a6;
}

.dark .compact-form input:focus,
.dark .compact-form select:focus {
  border-color: #60a5fa;
}

/* Submit button */
.btn-submit {
  width: 100%;
  margin-top: 1.25rem;
  background: #0056a6;
  color: #fff;
  font-weight: 500;
  font-size: 0.875rem;
  border: none;
  border-radius: 6px;
  padding: 0.625rem 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  cursor: pointer;
  transition: background 0.15s ease;
}

.dark .btn-submit {
  background: #2563eb;
}

.btn-submit:hover {
  background: #003d7a;
}

.dark .btn-submit:hover {
  background: #1d4ed8;
}
</style>
{% endblock %}

{% block content %}
<div class="w-full flex flex-col lg:flex-row min-h-screen">
  <!-- Form nuovo prodotto (centro) -->
  <div class="flex-1 flex justify-center items-start py-8 px-4 order-1 bg-gray-50 dark:bg-black">
    <div class="w-full max-w-3xl flex justify-center">
      <div class="form-container w-full" style="max-width: 380px;">
        <div class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg p-5">
          <h2 class="form-title">
            <i class="fas fa-plus"></i>
            Nuovo Prodotto
          </h2>
          <div class="text-xs text-gray-500 dark:text-gray-400" style="margin-top: -0.5rem; margin-bottom: 0.75rem;">
            Crea un articolo e imposta la quantit√† iniziale (ubicazione opzionale)
          </div>
          <form method="POST" action="{{ url_for('nuovo_prodotto') }}" autocomplete="off" class="compact-form">
        <label for="nome_prodotto">Nome Prodotto</label>
        <input type="text" id="nome_prodotto" name="nome_prodotto" required placeholder="Nome prodotto..." />

        <label for="codice_prodotto">Codice Prodotto</label>
        <input type="text" id="codice_prodotto" name="codice_prodotto" required placeholder="Codice prodotto..." />

        <label for="magazzino_id">Magazzino</label>
        <select id="magazzino_id" name="magazzino_id" required>
          <option value="1">Farmacia</option>
          <option value="2">Grossisti</option>
        </select>

        <label for="stato">Stato</label>
        <select id="stato" name="stato" required>
          <option value="in_magazzino">In Magazzino</option>
          <option value="in_arrivo">In Arrivo</option>
          <option value="in_utilizzo">In Utilizzo</option>
          <option value="spedito">Spedito</option>
          <option value="baia_uscita">Baia Uscita</option>
          <option value="in_preparazione">In Preparazione</option>
          <option value="altro">Altro</option>
          <option value="test">Test</option>
          <option value="laboratorio">Laboratorio</option>
        </select>

        <label for="quantita">Quantit√† iniziale</label>
        <input type="number" id="quantita" name="quantita" min="0" required placeholder="Quantit√†..." />

        <label for="ubicazione">Ubicazione</label>
        <input type="text" id="ubicazione" name="ubicazione" placeholder="Ubicazione (opzionale)..." />

        <button type="submit" class="btn-submit">
          <i class="fas fa-check-circle"></i>
          Salva prodotto
        </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista prodotti esistenti (sidebar destra) -->
  <!-- Lista prodotti esistenti (sidebar destra ridimensionabile) -->
  <div id="productsSidebar" class="w-full lg:min-h-screen bg-white dark:bg-gray-900 border-l border-gray-200 dark:border-gray-700 flex flex-col order-2 relative" style="width: 320px; min-width: 200px; max-width: 600px;">
    <!-- Handle per ridimensionare -->
    <div id="resizeHandle" class="hidden lg:block absolute left-0 top-0 bottom-0 w-1 cursor-ew-resize hover:bg-blue-500 active:bg-blue-600 transition-colors z-10" style="margin-left: -2px;"></div>
    
    <div class="p-4 border-b border-gray-200 dark:border-gray-700">
      <h2 class="text-base font-semibold text-gray-800 dark:text-white flex items-center gap-2">
        <i class="fas fa-boxes text-blue-500"></i>
        Prodotti Esistenti
        <span class="text-sm font-normal text-gray-500 dark:text-gray-400">({{ prodotti|length if prodotti else 0 }})</span>
      </h2>
    </div>
    
    <!-- Barra di ricerca -->
    <div class="p-3 border-b border-gray-200 dark:border-gray-700">
      <input type="text" id="search_prodotti" placeholder="Cerca prodotto..." 
             class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500" />
    </div>
    
    <!-- Lista scrollabile -->
    <div class="flex-1 overflow-y-auto p-2 space-y-1" id="prodotti_lista" style="max-height: calc(100vh - 140px);">
      {% if prodotti and prodotti|length > 0 %}
        {% for prodotto in prodotti %}
        <div class="prodotto-item group flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
             data-id="{{ prodotto.id }}" data-nome="{{ prodotto.nome_prodotto|lower }}" data-codice="{{ prodotto.codice_prodotto|lower }}"
             data-nome-originale="{{ prodotto.nome_prodotto }}" data-codice-originale="{{ prodotto.codice_prodotto }}">
          <div class="flex-1 min-w-0">
            <div class="font-medium text-gray-900 dark:text-white truncate text-sm">{{ prodotto.nome_prodotto|format_db_string }}</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">{{ prodotto.codice_prodotto }}</div>
          </div>
          <!-- Pulsanti azioni (visibili su hover) -->
          <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity mr-2">
            <button type="button" onclick="openEditModal({{ prodotto.id }})" 
                    class="p-1 text-blue-500 hover:text-blue-700 hover:bg-blue-100 dark:hover:bg-blue-900 rounded" title="Modifica">
              <i class="fas fa-pencil-alt text-xs"></i>
            </button>
            <button type="button" onclick="openDeleteModal({{ prodotto.id }})" 
                    class="p-1 text-red-500 hover:text-red-700 hover:bg-red-100 dark:hover:bg-red-900 rounded" title="Elimina">
              <i class="fas fa-trash text-xs"></i>
            </button>
          </div>
          <div class="px-2 py-1 rounded-full text-xs font-bold {% if prodotto.quantita_totale > 0 %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300{% else %}bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300{% endif %}">
            {{ prodotto.quantita_totale }}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="text-center text-gray-500 dark:text-gray-400 py-8">
          <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
          <p class="text-sm">Nessun prodotto</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal Modifica Prodotto -->
<div id="editModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <i class="fas fa-pencil-alt text-blue-500"></i>
        Modifica Prodotto
      </h3>
      <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="p-4 overflow-y-auto flex-1">
      <!-- Avviso -->
      <div class="mb-4 p-3 bg-amber-50 dark:bg-amber-900/30 border border-amber-200 dark:border-amber-700 rounded-lg">
        <div class="flex items-start gap-2">
          <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5"></i>
          <div class="text-sm text-amber-700 dark:text-amber-300">
            <strong>Attenzione:</strong> La modifica di questo prodotto avr√† effetto su tutte le giacenze associate.
          </div>
        </div>
      </div>
      
      <!-- Form modifica -->
      <div class="space-y-3 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome Prodotto</label>
          <input type="text" id="edit_nome_prodotto" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Codice Prodotto</label>
          <input type="text" id="edit_codice_prodotto" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm" />
        </div>
      </div>
      
      <!-- Giacenze interessate -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
          <i class="fas fa-layer-group text-gray-400"></i>
          Giacenze che verranno aggiornate:
        </h4>
        <div id="edit_giacenze_list" class="max-h-40 overflow-y-auto space-y-1 text-sm">
          <div class="text-gray-500 dark:text-gray-400 text-center py-2">Caricamento...</div>
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
      <button onclick="closeEditModal()" class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
        Annulla
      </button>
      <button onclick="saveEdit()" class="px-4 py-2 text-sm bg-blue-600 text-white hover:bg-blue-700 rounded-lg flex items-center gap-2">
        <i class="fas fa-save"></i>
        Salva Modifiche
      </button>
    </div>
  </div>
</div>

<!-- Modal Elimina Prodotto -->
<div id="deleteModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[90vh] overflow-hidden flex flex-col">
    <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <i class="fas fa-trash text-red-500"></i>
        Elimina Prodotto
      </h3>
      <button onclick="closeDeleteModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="p-4 overflow-y-auto flex-1">
      <!-- Avviso -->
      <div class="mb-4 p-3 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-lg">
        <div class="flex items-start gap-2">
          <i class="fas fa-exclamation-triangle text-red-500 mt-0.5"></i>
          <div class="text-sm text-red-700 dark:text-red-300">
            <strong>Attenzione:</strong> Stai per eliminare definitivamente questo prodotto e <strong>tutte le sue giacenze</strong>. Questa azione √® irreversibile!
          </div>
        </div>
      </div>
      
      <!-- Info prodotto -->
      <div class="mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <div class="text-sm">
          <div class="font-medium text-gray-900 dark:text-white" id="delete_nome_prodotto">-</div>
          <div class="text-gray-500 dark:text-gray-400" id="delete_codice_prodotto">-</div>
        </div>
      </div>
      
      <!-- Giacenze che verranno eliminate -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-3">
        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 flex items-center gap-2">
          <i class="fas fa-layer-group text-red-400"></i>
          Giacenze che verranno eliminate:
        </h4>
        <div id="delete_giacenze_list" class="max-h-40 overflow-y-auto space-y-1 text-sm">
          <div class="text-gray-500 dark:text-gray-400 text-center py-2">Caricamento...</div>
        </div>
      </div>
    </div>
    <div class="p-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-2">
      <button onclick="closeDeleteModal()" class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
        Annulla
      </button>
      <button onclick="confirmDelete()" class="px-4 py-2 text-sm bg-red-600 text-white hover:bg-red-700 rounded-lg flex items-center gap-2">
        <i class="fas fa-trash"></i>
        Elimina Definitivamente
      </button>
    </div>
  </div>
</div>

<!-- Mobile Menu (hidden by default) -->
<div class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-black shadow-lg z-10">
  <div class="flex justify-around">
    <a href="{{ url_for('index') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
      <i class="fas fa-boxes text-lg"></i>
      <span class="text-xs mt-1">Magazzino</span>
    </a>
    <a href="{{ url_for('movimento') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
      <i class="fas fa-exchange-alt text-lg"></i>
      <span class="text-xs mt-1">Movimento</span>
    </a>
    <a href="{{ url_for('carico_merci') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
      <i class="fas fa-arrow-up text-lg"></i>
      <span class="text-xs mt-1">Carico</span>
    </a>
    <a href="{{ url_for('scaricomerce') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'scaricomerce' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
      <i class="fas fa-arrow-down text-lg"></i>
      <span class="text-xs mt-1">Scarico</span>
    </a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEditId = null;
let currentDeleteId = null;

document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search_prodotti');
  const prodottiItems = document.querySelectorAll('.prodotto-item');
  
  if (searchInput) {
    searchInput.addEventListener('input', function() {
      const query = this.value.toLowerCase().trim();
      
      prodottiItems.forEach(item => {
        const nome = item.getAttribute('data-nome') || '';
        const codice = item.getAttribute('data-codice') || '';
        
        if (nome.includes(query) || codice.includes(query)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
  }
  
  // Chiudi modal con ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeEditModal();
      closeDeleteModal();
    }
  });
});

// Funzioni per Modal Modifica
function openEditModal(prodottoId) {
  currentEditId = prodottoId;
  const modal = document.getElementById('editModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  // Recupera dati prodotto dal DOM
  const item = document.querySelector(`.prodotto-item[data-id="${prodottoId}"]`);
  if (item) {
    document.getElementById('edit_nome_prodotto').value = item.dataset.nomeOriginale || '';
    document.getElementById('edit_codice_prodotto').value = item.dataset.codiceOriginale || '';
  }
  
  // Carica giacenze
  loadGiacenze(prodottoId, 'edit_giacenze_list');
}

function closeEditModal() {
  const modal = document.getElementById('editModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  currentEditId = null;
}

async function saveEdit() {
  if (!currentEditId) return;
  
  const nome = document.getElementById('edit_nome_prodotto').value.trim();
  const codice = document.getElementById('edit_codice_prodotto').value.trim();
  
  if (!nome || !codice) {
    alert('Nome e codice prodotto sono obbligatori');
    return;
  }
  
  try {
    const response = await fetch(`/api/prodotto/${currentEditId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nome_prodotto: nome, codice_prodotto: codice })
    });
    
    const data = await response.json();
    
    if (response.ok && data.success) {
      closeEditModal();
      location.reload();
    } else {
      alert(data.error || 'Errore durante la modifica');
    }
  } catch (err) {
    alert('Errore di connessione: ' + err.message);
  }
}

// Funzioni per Modal Elimina
function openDeleteModal(prodottoId) {
  currentDeleteId = prodottoId;
  const modal = document.getElementById('deleteModal');
  modal.classList.remove('hidden');
  modal.classList.add('flex');
  
  // Recupera dati prodotto dal DOM
  const item = document.querySelector(`.prodotto-item[data-id="${prodottoId}"]`);
  if (item) {
    document.getElementById('delete_nome_prodotto').textContent = item.dataset.nomeOriginale || '-';
    document.getElementById('delete_codice_prodotto').textContent = item.dataset.codiceOriginale || '-';
  }
  
  // Carica giacenze
  loadGiacenze(prodottoId, 'delete_giacenze_list');
}

function closeDeleteModal() {
  const modal = document.getElementById('deleteModal');
  modal.classList.add('hidden');
  modal.classList.remove('flex');
  currentDeleteId = null;
}

async function confirmDelete() {
  if (!currentDeleteId) return;
  
  try {
    const response = await fetch(`/api/prodotto/${currentDeleteId}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (response.ok && data.success) {
      closeDeleteModal();
      location.reload();
    } else {
      alert(data.error || 'Errore durante l\'eliminazione');
    }
  } catch (err) {
    alert('Errore di connessione: ' + err.message);
  }
}

// Funzione per caricare le giacenze
async function loadGiacenze(prodottoId, containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-2">Caricamento...</div>';
  
  try {
    const response = await fetch(`/api/prodotto/${prodottoId}/giacenze`);
    const data = await response.json();
    
    if (response.ok && data.giacenze) {
      if (data.giacenze.length === 0) {
        container.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center py-2 italic">Nessuna giacenza associata</div>';
      } else {
        container.innerHTML = data.giacenze.map(g => `
          <div class="flex items-center justify-between p-2 bg-gray-100 dark:bg-gray-700 rounded text-xs">
            <div class="flex-1">
              <span class="font-medium">${g.stato || 'N/D'}</span>
              ${g.ubicazione ? `<span class="text-gray-500 dark:text-gray-400 ml-2">üìç ${g.ubicazione}</span>` : ''}
              ${g.magazzino_nome ? `<span class="text-gray-500 dark:text-gray-400 ml-2">üè™ ${g.magazzino_nome}</span>` : ''}
            </div>
            <div class="font-bold ${g.quantita > 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
              ${g.quantita}
            </div>
          </div>
        `).join('');
      }
    } else {
      container.innerHTML = '<div class="text-red-500 text-center py-2">Errore nel caricamento</div>';
    }
  } catch (err) {
    container.innerHTML = '<div class="text-red-500 text-center py-2">Errore di connessione</div>';
  }
}

// Resize sidebar
(function() {
  const sidebar = document.getElementById('productsSidebar');
  const handle = document.getElementById('resizeHandle');
  if (!sidebar || !handle) return;
  
  // Carica larghezza salvata
  const savedWidth = localStorage.getItem('productsSidebarWidth');
  if (savedWidth) {
    sidebar.style.width = savedWidth + 'px';
  }
  
  let isResizing = false;
  let startX, startWidth;
  
  handle.addEventListener('mousedown', function(e) {
    isResizing = true;
    startX = e.clientX;
    startWidth = sidebar.offsetWidth;
    document.body.style.cursor = 'ew-resize';
    document.body.style.userSelect = 'none';
    e.preventDefault();
  });
  
  document.addEventListener('mousemove', function(e) {
    if (!isResizing) return;
    
    // Calcola nuova larghezza (trascinando verso sinistra aumenta)
    const diff = startX - e.clientX;
    let newWidth = startWidth + diff;
    
    // Limiti min/max
    newWidth = Math.max(200, Math.min(600, newWidth));
    
    sidebar.style.width = newWidth + 'px';
  });
  
  document.addEventListener('mouseup', function() {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = '';
      document.body.style.userSelect = '';
      // Salva la larghezza
      localStorage.setItem('productsSidebarWidth', sidebar.offsetWidth);
    }
  });
})();
</script>
{% endblock %}
