{% extends "base.html" %}

{% block title %}Riconciliazione Magazzino - Pharmagest{% endblock %}

{% block extra_css %}
<style>
:root {
  --bg-primary: rgba(255, 255, 255, 0.95);
  --bg-secondary: rgba(243, 244, 246, 0.9);
  --border-light: rgba(150, 150, 150, 0.25);
  --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --accent-color: #0056a6;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
}

.dark {
  --bg-primary: rgba(0, 0, 0, 0.98);
  --bg-secondary: rgba(0, 0, 0, 0.95);
  --border-light: rgba(40, 40, 40, 0.8);
  --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
  --accent-color: #60a5fa;
  --text-primary: #ffffff;
  --text-secondary: #d1d5db;
}

.upload-area {
  border: 2px dashed var(--accent-color);
  border-radius: 1rem;
  background: var(--bg-primary);
  backdrop-filter: blur(20px);
  padding: 2rem;
  text-align: center;
  margin-bottom: 1.5rem;
  transition: all 0.3s ease;
  cursor: pointer;
  box-shadow: var(--shadow-light);
}

.upload-area:hover {
  border-color: var(--accent-color);
  background: var(--bg-secondary);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
}

.dark .upload-area:hover {
  box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.8);
}

.file-info {
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  padding: 1rem;
  border-radius: 0.5rem;
  margin-top: 1rem;
  border: 1px solid var(--border-light);
}

.stat-card {
  background: linear-gradient(135deg, var(--accent-color) 0%, #003d7a 100%);
  color: white;
  border-radius: 1rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-light);
  backdrop-filter: blur(20px);
}

.dark .stat-card {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(37, 99, 235, 0.5) 100%);
  border: 1px solid var(--border-light);
}

.reconciliation-card {
  background: var(--bg-primary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-light);
  border-radius: 1rem;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-light);
  transition: all 0.3s ease;
}

.reconciliation-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
}

.dark .reconciliation-card:hover {
  box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.8);
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-color) 0%, #003d7a 100%);
  border: none;
  border-radius: 0.75rem;
  padding: 0.75rem 1.5rem;
  color: white;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px 0 rgba(0, 86, 166, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px 0 rgba(0, 86, 166, 0.4);
  background: linear-gradient(135deg, #003d7a 0%, var(--accent-color) 100%);
}

.dark .btn-primary {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8) 0%, rgba(37, 99, 235, 0.9) 100%);
  box-shadow: 0 4px 16px 0 rgba(37, 99, 235, 0.3);
}

.dark .btn-primary:hover {
  box-shadow: 0 8px 24px 0 rgba(37, 99, 235, 0.4);
}

.table-container {
  background: var(--bg-primary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-light);
  border-radius: 1rem;
  overflow: hidden;
  box-shadow: var(--shadow-light);
}

.table th {
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-weight: 600;
  padding: 1rem;
  border: none;
}

.table td {
  color: var(--text-primary);
  padding: 0.75rem 1rem;
  border: none;
  border-bottom: 1px solid var(--border-light);
}

.table tbody tr:hover {
  background: var(--bg-secondary);
  transform: scale(1.01);
  transition: all 0.2s ease;
}

.section-title {
  color: var(--text-primary);
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.section-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: linear-gradient(135deg, #e3f2fd 0%, #00a8e8 100%);
  color: var(--accent-color);
  font-size: 1.25rem;
}

.dark .section-icon {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(37, 99, 235, 0.5) 100%);
  color: var(--accent-color);
}

.progress {
  margin: 1.5rem 0;
  display: none;
  background: var(--bg-secondary);
  border-radius: 1rem;
  overflow: hidden;
  height: 0.5rem;
}

.progress-bar {
  background: linear-gradient(90deg, var(--accent-color) 0%, #00a8e8 100%);
  transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-black dark:to-gray-800 py-8 page-content">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header Section -->
        <div class="text-center mb-12">
            <div class="section-title justify-center">
                <div class="section-icon">
                    <i class="fas fa-warehouse"></i>
                </div>
                <h1 class="text-4xl font-bold">Confronto Magazzino AS400</h1>
            </div>
            <p class="text-xl text-gray-600 dark:text-gray-300 mt-4">
                Sistema automatico di confronto AS400 vs WebApp
            </p>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Upload Section -->
            <div class="lg:col-span-2">
                
                <!-- Main Upload Form -->
                <div class="reconciliation-card">
                    <div class="section-title">
                        <div class="section-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <h3>Caricamento File</h3>
                    </div>
                    
                    <form id="reconciliation-form" enctype="multipart/form-data" class="space-y-6">
                        
                        <!-- Magazzino 27 Upload -->
                        <div class="space-y-3">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-file-alt text-blue-500"></i>
                                    Magazzino 27 (AS400 - Grossisti)
                                    <span class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">
                                        Opzionale
                                    </span>
                                </div>
                            </label>
                            <div class="upload-area" onclick="document.getElementById('magazzino_27').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-medium text-gray-600 dark:text-gray-300 mb-2">
                                    Clicca per selezionare il file
                                </p>
                                <input type="file" name="magazzino_27" id="magazzino_27" 
                                       class="hidden" accept=".txt,.csv">
                                <small class="text-gray-500 dark:text-gray-400">File .txt dal sistema AS400</small>
                            </div>
                            <div id="info_magazzino_27" class="file-info hidden"></div>
                        </div>

                        <!-- Magazzino 28 Upload -->
                        <div class="space-y-3">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-file-alt text-blue-500"></i>
                                    Magazzino 28 (AS400 - Deposito)
                                    <span class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">
                                        Opzionale
                                    </span>
                                </div>
                            </label>
                            <div class="upload-area" onclick="document.getElementById('magazzino_28').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-medium text-gray-600 dark:text-gray-300 mb-2">
                                    Clicca per selezionare il file
                                </p>
                                <input type="file" name="magazzino_28" id="magazzino_28" 
                                       class="hidden" accept=".txt,.csv">
                                <small class="text-gray-500 dark:text-gray-400">File .txt dal sistema AS400</small>
                            </div>
                            <div id="info_magazzino_28" class="file-info hidden"></div>
                        </div>

                        <!-- Export WebApp Upload -->
                        <div class="space-y-3">
                            <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-file-export text-green-500"></i>
                                    Export WebApp
                                    <span class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 rounded-full">
                                        Obbligatorio
                                    </span>
                                </div>
                            </label>
                            <div class="upload-area" onclick="document.getElementById('webapp_export').click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                                <p class="text-lg font-medium text-gray-600 dark:text-gray-300 mb-2">
                                    Clicca per selezionare il file
                                </p>
                                <input type="file" name="webapp_export" id="webapp_export" 
                                       class="hidden" accept=".txt,.csv" required>
                                <small class="text-gray-500 dark:text-gray-400">File export dalla WebApp magazzino</small>
                            </div>
                            <div id="info_webapp_export" class="file-info hidden"></div>
                        </div>

                        <!-- Progress Bar -->
                        <div class="progress">
                            <div class="progress-bar" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>

                        <!-- Submit Button -->
                        <div class="pt-4">
                            <button type="submit" 
                                    class="btn-primary w-full py-4 text-lg font-semibold inline-flex items-center justify-center gap-3" 
                                    id="submit-btn">
                                <i class="fas fa-play text-xl"></i>
                                Avvia Confronto
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar with Info -->
            <div class="lg:col-span-1">
                <div class="reconciliation-card">
                    <div class="section-title">
                        <div class="section-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <h3>Informazioni</h3>
                    </div>
                    
                    <div class="space-y-4 text-sm text-gray-600 dark:text-gray-300">
                        <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <h4 class="font-semibold text-blue-800 dark:text-blue-300 mb-2">
                                <i class="fas fa-lightbulb mr-2"></i>Come funziona
                            </h4>
                            <ul class="space-y-2">
                                <li>• Carica i file AS400 e WebApp</li>
                                <li>• Il sistema confronta automaticamente le quantità</li>
                                <li>• Vengono evidenziate le differenze</li>
                                <li>• Scarica il report dettagliato</li>
                            </ul>
                        </div>
                        
                        <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800">
                            <h4 class="font-semibold text-green-800 dark:text-green-300 mb-2">
                                <i class="fas fa-check-circle mr-2"></i>Formati supportati
                            </h4>
                            <ul class="space-y-1">
                                <li>• File .txt da AS400</li>
                                <li>• Export .csv da WebApp</li>
                                <li>• Encoding automatico</li>
                            </ul>
                        </div>
                        
                        <div class="p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg border border-amber-200 dark:border-amber-800">
                            <h4 class="font-semibold text-amber-800 dark:text-amber-300 mb-2">
                                <i class="fas fa-exclamation-triangle mr-2"></i>Note importanti
                            </h4>
                            <ul class="space-y-1">
                                <li>• Almeno un file AS400 è richiesto</li>
                                <li>• Il file WebApp è sempre obbligatorio</li>
                                <li>• I risultati sono salvati automaticamente</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-container hidden mt-12" id="results-container">
            
            <!-- Statistics Cards -->
            <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="stat-card text-center">
                    <i class="fas fa-boxes text-3xl mb-4 opacity-80"></i>
                    <h3 class="text-3xl font-bold mb-2" id="total-products">0</h3>
                    <p class="text-lg opacity-90">Prodotti Totali</p>
                </div>
                <div class="stat-card text-center">
                    <i class="fas fa-check-circle text-3xl mb-4 opacity-80"></i>
                    <h3 class="text-3xl font-bold mb-2" id="aligned-products">0</h3>
                    <p class="text-lg opacity-90">Allineati</p>
                </div>
                <div class="stat-card text-center">
                    <i class="fas fa-percentage text-3xl mb-4 opacity-80"></i>
                    <h3 class="text-3xl font-bold mb-2" id="alignment-percentage">0%</h3>
                    <p class="text-lg opacity-90">Allineamento</p>
                </div>
                <div class="stat-card text-center">
                    <i class="fas fa-exclamation-triangle text-3xl mb-4 opacity-80"></i>
                    <h3 class="text-3xl font-bold mb-2" id="differences-count">0</h3>
                    <p class="text-lg opacity-90">Differenze</p>
                </div>
            </div>

            <!-- Results Tables -->
            <div class="space-y-8">
                
                <!-- WebApp Higher Products -->
                <div class="reconciliation-card">
                    <div class="section-title text-yellow-600 dark:text-yellow-400">
                        <div class="section-icon bg-gradient-to-br from-yellow-100 to-yellow-200 dark:from-yellow-900 dark:to-yellow-800 text-yellow-600 dark:text-yellow-400">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <div>
                            <h3>ECCEDENZA in WebApp</h3>
                            <span class="px-3 py-1 text-xs bg-gray-800 text-white rounded-full ml-2">WebApp > AS400</span>
                        </div>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">
                        Questi prodotti hanno più unità nella WebApp. 
                                        </p>
                    
                    <div class="table-container">
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr class="bg-yellow-50 dark:bg-yellow-900/20">
                                        <th class="text-left">Codice</th>
                                        <th class="text-left">Descrizione</th>
                                        <th class="text-center"><i class="fas fa-server mr-1"></i> AS400</th>
                                        <th class="text-center"><i class="fas fa-globe mr-1"></i> WebApp</th>
                                        <th class="text-center"><i class="fas fa-plus-circle text-yellow-600 mr-1"></i> Eccedenza</th>
                                        <th class="text-left">Stato</th>
                                        <th class="text-left">Note</th>
                                    </tr>
                                </thead>
                                <tbody id="webapp-higher-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- AS400 Higher Products -->
                <div class="reconciliation-card">
                    <div class="section-title text-red-600 dark:text-red-400">
                        <div class="section-icon bg-gradient-to-br from-red-100 to-red-200 dark:from-red-900 dark:to-red-800 text-red-600 dark:text-red-400">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <div>
                            <h3>ECCEDENZA in AS400</h3>
                            <span class="px-3 py-1 text-xs bg-gray-800 text-white rounded-full ml-2">AS400 > WebApp</span>
                        </div>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">
                        Questi prodotti hanno più unità in AS400.
                    </p>
                    
                    <div class="table-container">
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr class="bg-red-50 dark:bg-red-900/20">
                                        <th class="text-left">Codice</th>
                                        <th class="text-left">Descrizione</th>
                                        <th class="text-center"><i class="fas fa-server mr-1"></i> AS400</th>
                                        <th class="text-center"><i class="fas fa-globe mr-1"></i> WebApp</th>
                                        <th class="text-center"><i class="fas fa-minus-circle text-red-600 mr-1"></i> Differenza</th>
                                        <th class="text-left">Stato</th>
                                        <th class="text-left">Note</th>
                                    </tr>
                                </thead>
                                <tbody id="as400-higher-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Aligned Products -->
                <div class="reconciliation-card">
                    <div class="section-title text-green-600 dark:text-green-400">
                        <div class="section-icon bg-gradient-to-br from-green-100 to-green-200 dark:from-green-900 dark:to-green-800 text-green-600 dark:text-green-400">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <h3>Prodotti Allineati</h3>
                            <span class="px-3 py-1 text-xs bg-green-600 text-white rounded-full ml-2">AS400 = WebApp</span>
                        </div>
                    </div>
                    <p class="text-gray-600 dark:text-gray-300 mb-6">
                        Questi prodotti hanno quantità identiche in entrambi i magazzini.
                    </p>
                    
                    <div class="table-container">
                        <div class="overflow-x-auto">
                            <table class="table w-full">
                                <thead>
                                    <tr class="bg-green-50 dark:bg-green-900/20">
                                        <th class="text-left">Codice</th>
                                        <th class="text-left">Descrizione</th>
                                        <th class="text-center"><i class="fas fa-equals text-green-600 mr-1"></i> Quantità</th>
                                        <th class="text-left">Stato</th>
                                        <th class="text-left">Note</th>
                                    </tr>
                                </thead>
                                <tbody id="aligned-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Section -->
            <div class="text-center mt-12">
                <button class="btn-primary inline-flex items-center gap-3 text-lg px-8 py-4" 
                        onclick="downloadResults()" id="download-btn" style="display: none;">
                    <i class="fas fa-download text-xl"></i>
                    Scarica Report Completo
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentResults = null;

document.getElementById('reconciliation-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const magazzino27 = document.getElementById('magazzino_27').files[0];
    const magazzino28 = document.getElementById('magazzino_28').files[0];
    const webappExport = document.getElementById('webapp_export').files[0];
    
    if (!webappExport) {
        alert('Il file Export WebApp è obbligatorio!');
        return;
    }
    
    if (!magazzino27 && !magazzino28) {
        alert('Almeno un file AS400 è richiesto!');
        return;
    }
    
    if (magazzino27) formData.append('magazzino_27', magazzino27);
    if (magazzino28) formData.append('magazzino_28', magazzino28);
    formData.append('webapp_export', webappExport);
    
    // Show progress
    document.querySelector('.progress').style.display = 'block';
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Elaborazione in corso...';
    
    fetch('/api/reconcile-warehouse', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentResults = data;
            displayResults(data);
            document.getElementById('results-container').classList.remove('hidden');
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore durante l\'elaborazione: ' + error.message);
    })
    .finally(() => {
        document.querySelector('.progress').style.display = 'none';
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-play mr-2"></i>Avvia Riconciliazione';
    });
});

function displayResults(data) {
    // Update statistics
    document.getElementById('total-products').textContent = data.summary.total_products;
    document.getElementById('aligned-products').textContent = data.summary.products_aligned;
    document.getElementById('alignment-percentage').textContent = data.summary.alignment_percentage + '%';
    document.getElementById('differences-count').textContent = data.summary.products_with_differences;
    
    // Display tables
    populateTable('webapp-higher-tbody', data.details.webapp_higher, ['Codice', 'Descrizione', 'Quantita_AS400', 'Quantita_WebApp', 'Differenza', 'Stato', 'Note']);
    populateTable('as400-higher-tbody', data.details.as400_higher, ['Codice', 'Descrizione', 'Quantita_AS400', 'Quantita_WebApp', 'Differenza', 'Stato', 'Note']);
    populateTable('aligned-tbody', data.details.aligned_products, ['Codice', 'Descrizione', 'Quantita_AS400', 'Stato', 'Note']);
    
    // Show download button
    document.getElementById('download-btn').style.display = 'inline-flex';
}

function populateTable(tableBodyId, products, columns) {
    const tbody = document.getElementById(tableBodyId);
    tbody.innerHTML = '';
    
    if (products.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = columns.length;
        cell.className = 'text-center text-gray-500 dark:text-gray-400 py-8';
        cell.textContent = 'Nessun prodotto in questa categoria';
        return;
    }
    
    products.forEach(product => {
        const row = tbody.insertRow();
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200';
        
        columns.forEach(col => {
            const cell = row.insertCell();
            const value = product[col] !== undefined && product[col] !== null ? product[col] : '';
            
            if (col === 'Differenza') {
                const diff = parseInt(value);
                if (diff > 0) {
                    cell.innerHTML = `<span class="text-yellow-600 font-semibold">+${diff}</span>`;
                } else if (diff < 0) {
                    cell.innerHTML = `<span class="text-red-600 font-semibold">${diff}</span>`;
                } else {
                    cell.innerHTML = `<span class="text-green-600 font-semibold">=</span>`;
                }
            } else if (['Quantita_AS400', 'Quantita_WebApp'].includes(col)) {
                cell.className = 'text-center font-mono';
                cell.textContent = value;
            } else {
                cell.textContent = value;
            }
        });
    });
}

function downloadResults() {
    if (currentResults && currentResults.audit_file) {
        window.open(`/download/${currentResults.audit_file}`, '_blank');
    } else {
        alert('Nessun risultato disponibile per il download');
    }
}

// File upload handling
['magazzino_27', 'magazzino_28', 'webapp_export'].forEach(id => {
    document.getElementById(id).addEventListener('change', function(e) {
        const file = e.target.files[0];
        const infoDiv = document.getElementById(`info_${id}`);
        
        if (file) {
            infoDiv.innerHTML = `<i class="fas fa-file-alt mr-2"></i><strong>${file.name}</strong> (${(file.size/1024).toFixed(1)} KB)`;
            infoDiv.classList.remove('hidden');
        } else {
            infoDiv.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}