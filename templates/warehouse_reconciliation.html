{% extends "base.html" %}

{% block title %}Riconciliazione Magazzino - Pharmagest{% endblock %}

{% block extra_css %}
<style>
:root {
  --bg-primary: rgba(255, 255, 255, 0.95);
  --bg-secondary: rgba(243, 244, 246, 0.9);
  --border-light: rgba(150, 150, 150, 0.25);
  --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --accent-color: #0056a6;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
}

.dark {
  --bg-primary: rgba(0, 0, 0, 0.98);
  --bg-secondary: rgba(0, 0, 0, 0.95);
  --border-light: rgba(40, 40, 40, 0.8);
  --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
  --accent-color: #60a5fa;
  --text-primary: #ffffff;
  --text-secondary: #d1d5db;
}

.upload-area {
  border: 2px dashed var(--accent-color);
  border-radius: 1rem;
  background: var(--bg-primary);
  backdrop-filter: blur(20px);
  padding: 1.5rem;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
  box-shadow: var(--shadow-light);
  min-height: 200px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.upload-area:hover {
  border-color: var(--accent-color);
  background: var(--bg-secondary);
  transform: translateY(-2px);
  box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
}

.upload-area.drag-over {
  border-color: #00a8e8;
  background: linear-gradient(135deg, rgba(0, 168, 232, 0.1) 0%, rgba(0, 86, 166, 0.15) 100%);
  transform: scale(1.02);
}

.dark .upload-area:hover {
  box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.8);
}

.dark .upload-area.drag-over {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.15) 0%, rgba(37, 99, 235, 0.2) 100%);
}

.file-info {
  background: var(--bg-secondary);
  backdrop-filter: blur(20px);
  padding: 0.75rem;
  border-radius: 0.5rem;
  margin-top: 0.75rem;
  border: 1px solid var(--border-light);
  font-size: 0.85rem;
  word-break: break-word;
}

.stat-card {
  background: linear-gradient(135deg, var(--accent-color) 0%, #003d7a 100%);
  color: white;
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: var(--shadow-light);
  backdrop-filter: blur(20px);
}

.dark .stat-card {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(37, 99, 235, 0.5) 100%);
  border: 1px solid var(--border-light);
}

.reconciliation-card {
  background: var(--bg-primary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-light);
  border-radius: 1rem;
  padding: 1.5rem;
  box-shadow: var(--shadow-light);
  transition: all 0.3s ease;
}

.reconciliation-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.2);
}

.dark .reconciliation-card:hover {
  box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.8);
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-color) 0%, #003d7a 100%);
  border: none;
  border-radius: 0.75rem;
  padding: 0.75rem 1.5rem;
  color: white;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 4px 16px 0 rgba(0, 86, 166, 0.3);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px 0 rgba(0, 86, 166, 0.4);
  background: linear-gradient(135deg, #003d7a 0%, var(--accent-color) 100%);
}

.dark .btn-primary {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.8) 0%, rgba(37, 99, 235, 0.9) 100%);
  box-shadow: 0 4px 16px 0 rgba(37, 99, 235, 0.3);
}

.dark .btn-primary:hover {
  box-shadow: 0 8px 24px 0 rgba(37, 99, 235, 0.4);
}

.table-container {
  background: var(--bg-primary);
  backdrop-filter: blur(20px);
  border: 1px solid var(--border-light);
  border-radius: 1rem;
  overflow: hidden;
  box-shadow: var(--shadow-light);
  max-height: 400px;
  overflow-y: auto;
}

.table th {
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-weight: 600;
  padding: 0.75rem;
  border: none;
  position: sticky;
  top: 0;
  z-index: 10;
}

.table td {
  color: var(--text-primary);
  padding: 0.5rem 0.75rem;
  border: none;
  border-bottom: 1px solid var(--border-light);
}

.table tbody tr:hover {
  background: var(--bg-secondary);
  transition: all 0.2s ease;
}

.section-title {
  color: var(--text-primary);
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.section-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: linear-gradient(135deg, #e3f2fd 0%, #00a8e8 100%);
  color: var(--accent-color);
  font-size: 1.25rem;
}

.dark .section-icon {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(37, 99, 235, 0.5) 100%);
  color: var(--accent-color);
}

.progress {
  margin: 1.5rem 0;
  display: none;
  background: var(--bg-secondary);
  border-radius: 1rem;
  overflow: hidden;
  height: 0.5rem;
}

.progress-bar {
  background: linear-gradient(90deg, var(--accent-color) 0%, #00a8e8 100%);
  transition: width 0.3s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-black dark:to-gray-800 py-8 page-content">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header Section -->
        <div class="text-center mb-8">
            <div class="section-title justify-center">
                <div class="section-icon">
                    <i class="fas fa-warehouse"></i>
                </div>
                <h1 class="text-4xl font-bold">Confronto Magazzino AS400</h1>
            </div>
            <p class="text-xl text-gray-600 dark:text-gray-300 mt-4">
                Sistema automatico di confronto AS400 vs WebApp
            </p>
        </div>

        <!-- Upload Section - Horizontal Grid -->
        <form id="reconciliation-form" enctype="multipart/form-data">
            <div class="grid md:grid-cols-3 gap-6 mb-8">
                
                <!-- Magazzino 27 Upload -->
                <div class="reconciliation-card">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <div class="flex items-center justify-center gap-2">
                            <i class="fas fa-file-alt text-blue-500"></i>
                            Magazzino 27
                            <span class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">
                                Opzionale
                            </span>
                        </div>
                    </label>
                    <div class="upload-area" data-input="magazzino_27">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">
                            Trascina qui o clicca
                        </p>
                        <input type="file" name="magazzino_27" id="magazzino_27" 
                               class="hidden" accept=".txt,.csv">
                        <small class="text-gray-500 dark:text-gray-400 text-xs">AS400 - Grossisti</small>
                    </div>
                    <div id="info_magazzino_27" class="file-info hidden"></div>
                </div>

                <!-- Magazzino 28 Upload -->
                <div class="reconciliation-card">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <div class="flex items-center justify-center gap-2">
                            <i class="fas fa-file-alt text-blue-500"></i>
                            Magazzino 28
                            <span class="px-2 py-1 text-xs bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded-full">
                                Opzionale
                            </span>
                        </div>
                    </label>
                    <div class="upload-area" data-input="magazzino_28">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">
                            Trascina qui o clicca
                        </p>
                        <input type="file" name="magazzino_28" id="magazzino_28" 
                               class="hidden" accept=".txt,.csv">
                        <small class="text-gray-500 dark:text-gray-400 text-xs">AS400 - Deposito</small>
                    </div>
                    <div id="info_magazzino_28" class="file-info hidden"></div>
                </div>

                <!-- Export WebApp Upload -->
                <div class="reconciliation-card">
                    <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
                        <div class="flex items-center justify-center gap-2">
                            <i class="fas fa-file-export text-green-500"></i>
                            Export WebApp
                            <span class="px-2 py-1 text-xs bg-red-100 dark:bg-red-900 text-red-600 dark:text-red-300 rounded-full">
                                Obbligatorio
                            </span>
                        </div>
                    </label>
                    <div class="upload-area" data-input="webapp_export">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-3"></i>
                        <p class="text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">
                            Trascina qui o clicca
                        </p>
                        <input type="file" name="webapp_export" id="webapp_export" 
                               class="hidden" accept=".txt,.csv" required>
                        <small class="text-gray-500 dark:text-gray-400 text-xs">File WebApp magazzino</small>
                    </div>
                    <div id="info_webapp_export" class="file-info hidden"></div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress">
                <div class="progress-bar" 
                     role="progressbar" style="width: 0%"></div>
            </div>

            <!-- Submit Button -->
            <div class="text-center mb-8">
                <button type="submit" 
                        class="btn-primary py-3 px-8 text-lg font-semibold inline-flex items-center justify-center gap-3" 
                        id="submit-btn">
                    <i class="fas fa-play text-xl"></i>
                    Avvia Confronto
                </button>
            </div>
        </form>

        <!-- Statistics Cards -->
        <div class="grid md:grid-cols-4 gap-6 mb-8 hidden" id="stats-section">
            <div class="stat-card text-center">
                <i class="fas fa-boxes text-3xl mb-4 opacity-80"></i>
                <h3 class="text-3xl font-bold mb-2" id="total-products">0</h3>
                <p class="text-lg opacity-90">Prodotti Totali</p>
            </div>
            <div class="stat-card text-center">
                <i class="fas fa-check-circle text-3xl mb-4 opacity-80"></i>
                <h3 class="text-3xl font-bold mb-2" id="aligned-products">0</h3>
                <p class="text-lg opacity-90">Allineati</p>
            </div>
            <div class="stat-card text-center">
                <i class="fas fa-percentage text-3xl mb-4 opacity-80"></i>
                <h3 class="text-3xl font-bold mb-2" id="alignment-percentage">0%</h3>
                <p class="text-lg opacity-90">Allineamento</p>
            </div>
            <div class="stat-card text-center">
                <i class="fas fa-exclamation-triangle text-3xl mb-4 opacity-80"></i>
                <h3 class="text-3xl font-bold mb-2" id="differences-count">0</h3>
                <p class="text-lg opacity-90">Differenze</p>
            </div>
        </div>

        <!-- Results Section - 3 Column Grid -->
        <div class="results-container hidden" id="results-container">
            <div class="grid lg:grid-cols-3 gap-6 mb-8">
                
                <!-- WebApp Higher Products -->
                <div class="reconciliation-card">
                    <div class="text-center mb-4">
                        <div class="section-icon mx-auto mb-3 bg-gradient-to-br from-yellow-100 to-yellow-200 dark:from-yellow-900 dark:to-yellow-800 text-yellow-600 dark:text-yellow-400">
                            <i class="fas fa-arrow-up"></i>
                        </div>
                        <h3 class="text-lg font-bold text-yellow-600 dark:text-yellow-400 mb-2">ECCEDENZA WebApp</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Più unità in WebApp
                        </p>
                    </div>
                    
                    <div class="table-container">
                        <table class="table w-full text-sm">
                            <thead>
                                <tr class="bg-yellow-50 dark:bg-yellow-900/20">
                                    <th class="text-left text-xs">Codice</th>
                                    <th class="text-center text-xs">AS400</th>
                                    <th class="text-center text-xs">WebApp</th>
                                    <th class="text-center text-xs">Diff</th>
                                </tr>
                            </thead>
                            <tbody id="webapp-higher-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- AS400 Higher Products -->
                <div class="reconciliation-card">
                    <div class="text-center mb-4">
                        <div class="section-icon mx-auto mb-3 bg-gradient-to-br from-red-100 to-red-200 dark:from-red-900 dark:to-red-800 text-red-600 dark:text-red-400">
                            <i class="fas fa-arrow-down"></i>
                        </div>
                        <h3 class="text-lg font-bold text-red-600 dark:text-red-400 mb-2">ECCEDENZA AS400</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Più unità in AS400
                        </p>
                    </div>
                    
                    <div class="table-container">
                        <table class="table w-full text-sm">
                            <thead>
                                <tr class="bg-red-50 dark:bg-red-900/20">
                                    <th class="text-left text-xs">Codice</th>
                                    <th class="text-center text-xs">AS400</th>
                                    <th class="text-center text-xs">WebApp</th>
                                    <th class="text-center text-xs">Diff</th>
                                </tr>
                            </thead>
                            <tbody id="as400-higher-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Aligned Products -->
                <div class="reconciliation-card">
                    <div class="text-center mb-4">
                        <div class="section-icon mx-auto mb-3 bg-gradient-to-br from-green-100 to-green-200 dark:from-green-900 dark:to-green-800 text-green-600 dark:text-green-400">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3 class="text-lg font-bold text-green-600 dark:text-green-400 mb-2">Prodotti Allineati</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-300">
                            Quantità identiche
                        </p>
                    </div>
                    
                    <div class="table-container">
                        <table class="table w-full text-sm">
                            <thead>
                                <tr class="bg-green-50 dark:bg-green-900/20">
                                    <th class="text-left text-xs">Codice</th>
                                    <th class="text-center text-xs">Quantità</th>
                                    <th class="text-left text-xs">Stato</th>
                                </tr>
                            </thead>
                            <tbody id="aligned-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Download Section -->
            <div class="text-center">
                <button class="btn-primary inline-flex items-center gap-3 text-lg px-8 py-4" 
                        onclick="downloadResults()" id="download-btn" style="display: none;">
                    <i class="fas fa-download text-xl"></i>
                    Scarica Report Completo
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentResults = null;

// Drag and drop functionality
function setupDragAndDrop() {
    const uploadAreas = document.querySelectorAll('.upload-area');
    
    uploadAreas.forEach(area => {
        const inputId = area.getAttribute('data-input');
        const input = document.getElementById(inputId);
        
        // Click to upload
        area.addEventListener('click', (e) => {
            if (e.target !== input) {
                input.click();
            }
        });
        
        // Drag and drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            area.addEventListener(eventName, () => {
                area.classList.add('drag-over');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            area.addEventListener(eventName, () => {
                area.classList.remove('drag-over');
            }, false);
        });
        
        area.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            
            if (files.length > 0) {
                input.files = files;
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            }
        }, false);
    });
}

setupDragAndDrop();

document.getElementById('reconciliation-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const magazzino27 = document.getElementById('magazzino_27').files[0];
    const magazzino28 = document.getElementById('magazzino_28').files[0];
    const webappExport = document.getElementById('webapp_export').files[0];
    
    if (!webappExport) {
        alert('Il file Export WebApp è obbligatorio!');
        return;
    }
    
    if (!magazzino27 && !magazzino28) {
        alert('Almeno un file AS400 è richiesto!');
        return;
    }
    
    if (magazzino27) formData.append('magazzino_27', magazzino27);
    if (magazzino28) formData.append('magazzino_28', magazzino28);
    formData.append('webapp_export', webappExport);
    
    // Show progress
    document.querySelector('.progress').style.display = 'block';
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Elaborazione in corso...';
    
    fetch('/api/reconcile-warehouse', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentResults = data;
            displayResults(data);
            document.getElementById('results-container').classList.remove('hidden');
        } else {
            alert('Errore: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Errore durante l\'elaborazione: ' + error.message);
    })
    .finally(() => {
        document.querySelector('.progress').style.display = 'none';
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').innerHTML = '<i class="fas fa-play mr-2"></i>Avvia Confronto';
    });
});

function displayResults(data) {
    // Update statistics
    document.getElementById('total-products').textContent = data.summary.total_products;
    document.getElementById('aligned-products').textContent = data.summary.products_aligned;
    document.getElementById('alignment-percentage').textContent = data.summary.alignment_percentage + '%';
    document.getElementById('differences-count').textContent = data.summary.products_with_differences;
    
    // Show statistics section
    document.getElementById('stats-section').classList.remove('hidden');
    
    // Display tables with compact columns
    populateTable('webapp-higher-tbody', data.details.webapp_higher, ['Codice', 'Quantita_AS400', 'Quantita_WebApp', 'Differenza']);
    populateTable('as400-higher-tbody', data.details.as400_higher, ['Codice', 'Quantita_AS400', 'Quantita_WebApp', 'Differenza']);
    populateTable('aligned-tbody', data.details.aligned_products, ['Codice', 'Quantita_AS400', 'Stato']);
    
    // Show download button
    document.getElementById('download-btn').style.display = 'inline-flex';
}

function populateTable(tableBodyId, products, columns) {
    const tbody = document.getElementById(tableBodyId);
    tbody.innerHTML = '';
    
    if (products.length === 0) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = columns.length;
        cell.className = 'text-center text-gray-500 dark:text-gray-400 py-6 text-xs';
        cell.textContent = 'Nessun prodotto';
        return;
    }
    
    // Limit to first 50 products for better performance in compact view
    const displayProducts = products.slice(0, 50);
    
    displayProducts.forEach(product => {
        const row = tbody.insertRow();
        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-200';
        
        columns.forEach(col => {
            const cell = row.insertCell();
            const value = product[col] !== undefined && product[col] !== null ? product[col] : '';
            
            if (col === 'Differenza') {
                const diff = parseInt(value);
                cell.className = 'text-center';
                if (diff > 0) {
                    cell.innerHTML = `<span class="text-yellow-600 font-bold">+${diff}</span>`;
                } else if (diff < 0) {
                    cell.innerHTML = `<span class="text-red-600 font-bold">${diff}</span>`;
                } else {
                    cell.innerHTML = `<span class="text-green-600 font-bold">=</span>`;
                }
            } else if (['Quantita_AS400', 'Quantita_WebApp'].includes(col)) {
                cell.className = 'text-center font-mono font-semibold';
                cell.textContent = value;
            } else if (col === 'Codice') {
                cell.className = 'font-mono text-xs';
                cell.textContent = value;
            } else {
                cell.className = 'text-xs';
                cell.textContent = value;
            }
        });
    });
    
    // Add "more results" indicator if truncated
    if (products.length > 50) {
        const row = tbody.insertRow();
        const cell = row.insertCell();
        cell.colSpan = columns.length;
        cell.className = 'text-center text-gray-500 dark:text-gray-400 py-3 text-xs italic';
        cell.textContent = `... e altri ${products.length - 50} prodotti (vedi CSV completo)`;
    }
}

function downloadResults() {
    if (currentResults && currentResults.audit_file) {
        window.open(`/download/${currentResults.audit_file}`, '_blank');
    } else {
        alert('Nessun risultato disponibile per il download');
    }
}

// File upload handling
['magazzino_27', 'magazzino_28', 'webapp_export'].forEach(id => {
    document.getElementById(id).addEventListener('change', function(e) {
        const file = e.target.files[0];
        const infoDiv = document.getElementById(`info_${id}`);
        
        if (file) {
            infoDiv.innerHTML = `<i class="fas fa-file-alt mr-2"></i><strong>${file.name}</strong> (${(file.size/1024).toFixed(1)} KB)`;
            infoDiv.classList.remove('hidden');
        } else {
            infoDiv.classList.add('hidden');
        }
    });
});
</script>
{% endblock %}
