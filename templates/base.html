<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Gestione Magazzino - Pharmagest{% endblock %}</title>
  
  <!-- Script per applicare immediatamente il tema senza flash -->
  <script>
    (function() {
      const savedTheme = localStorage.getItem('appTheme') || 'default';
      document.documentElement.setAttribute('data-theme', savedTheme);

      let storedDark = localStorage.getItem('darkMode');
      if (savedTheme === 'minimal' && storedDark === null) {
        storedDark = 'true';
        localStorage.setItem('darkMode', 'true');
      }

      const isDark = storedDark === 'true';
      document.documentElement.classList.toggle('dark', isDark);

      const bgColor = savedTheme === 'minimal'
        ? (isDark ? '#15100C' : '#FAF8F5')
        : (isDark ? '#000000' : '#f8fafc');

      document.documentElement.style.setProperty('background-color', bgColor, 'important');

      const criticalStyle = document.createElement('style');
      criticalStyle.id = 'dark-mode-critical';
      criticalStyle.textContent = `
        html, body, html body, body.bg-gray-50 {
          background-color: ${bgColor} !important;
          transition: none !important;
        }
        html[data-theme="minimal"].dark {
          --minimal-bg: #15100C;
        }
      `;
      document.head.appendChild(criticalStyle);
    })();
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            phg: {
              primary: '#0056a6',
              secondary: '#e3f2fd',
              accent: '#00a8e8',
              dark: '#003d7a',
              light: '#f0f8ff'
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    /* Critical inline CSS only. Full theme & component styles moved to static/optimized.css for caching & performance. */
    body, html { margin:0 !important; padding:0 !important; }
    body { font-family:'Inter', sans-serif; background-color:#f8fafc; }
    :root { --bg-primary:#ffffff; --bg-secondary:#f9fafb; --bg-tertiary:#f3f4f6; --text-primary:#111827; --text-secondary:#6b7280; --border-color:#e5e7eb; --shadow:rgba(0,0,0,0.1); }
    .dark { --bg-primary:#0a0a0a; --bg-secondary:#000000; --bg-tertiary:#1a1a1a; --text-primary:#ffffff; --text-secondary:#a0a0a0; --border-color:#2a2a2a; --shadow:rgba(0,0,0,0.8); }
    .dark body { background-color:#000000 !important; color:var(--text-primary) !important; }
    .glass-card { background:linear-gradient(120deg,#e3f2fd 0%,#f0f8ff 100%); border:1px solid rgba(0,86,166,0.15); box-shadow:0 2px 8px rgba(0,86,166,0.08); border-radius:1.25rem; padding:2.5rem 2rem; position:relative; width:100%; min-width:0; box-sizing:border-box; transition:border-color 0.2s ease,box-shadow 0.2s ease; } .glass-card:hover { border-color:rgba(0,86,166,0.3); box-shadow:0 4px 12px rgba(0,86,166,0.12); }
    .dark .glass-card { background:linear-gradient(120deg,rgba(227,242,253,0.15) 0%, rgba(240,248,255,0.1) 100%) !important; border:1px solid rgba(227,242,253,0.2) !important; box-shadow:0 2px 8px rgba(0,0,0,0.4) !important; transition:border-color 0.2s ease,box-shadow 0.2s ease; } .dark .glass-card:hover { border-color:rgba(96,165,250,0.4) !important; box-shadow:0 4px 12px rgba(96,165,250,0.15) !important; }
    .main-content-area { margin-left:256px; margin-right:0; margin-top:0 !important; width:calc(100vw - 256px); max-width:none; min-width:0; transition:none; }
    @media (max-width:1024px){ .main-content-area { margin-left:0; margin-top:0 !important; width:100vw; max-width:100vw; } }
    .main-content-area > [x-data] > div:first-child.px-2.md\:px-6 { padding:0 .5rem 1rem .5rem !important; }
    @media (min-width:768px){ .main-content-area > [x-data] > div:first-child.px-2.md\:px-6 { padding:0 1.5rem 1.5rem 1.5rem !important; } }
    /* End critical inline */
  </style>
  <!-- Preconnect & Preload Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" as="style">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap">
  <!-- External optimized stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='optimized.css') }}">
{% block extra_css %}{% endblock %}
    <script>
    // Apply theme on page load
    (function() {
      const savedTheme = localStorage.getItem('appTheme') || 'default';
      document.documentElement.setAttribute('data-theme', savedTheme);
    })();
    
    document.addEventListener('DOMContentLoaded', function() {
      const mainContent = document.querySelector('.main-content-area');
      const stickyNav = mainContent.querySelector('.sticky');
      const nextElement = stickyNav.nextElementSibling;
      
      if (nextElement) {
        nextElement.style.marginTop = '0';
        nextElement.style.paddingTop = '0';
      }
      
      // Watch for theme changes in localStorage
      window.addEventListener('storage', function(e) {
        if (e.key === 'appTheme') {
          document.documentElement.setAttribute('data-theme', e.newValue || 'default');
        }
      });
    });
    </script>
</head>
<body x-data="{ 
        darkMode: localStorage.getItem('darkMode') === 'true', 
        sidebarOpen: false,
        currentTheme: localStorage.getItem('appTheme') || 'default'
      }" 
      x-init="
        const getBgColor = (theme, isDark) => {
          const activeTheme = theme || 'default';
          if (activeTheme === 'minimal') {
            return isDark ? '#15100C' : '#FAF8F5';
          }
          return isDark ? '#000000' : '#f8fafc';
        };

        const applyThemeState = (theme, isDark) => {
          const bg = getBgColor(theme, isDark);
          document.documentElement.classList.toggle('dark', isDark);
          document.body.classList.toggle('dark', isDark);
          document.documentElement.style.setProperty('background-color', bg, 'important');
          document.body.style.setProperty('background-color', bg, 'important');
        };

        applyThemeState(currentTheme, darkMode);

        $watch('darkMode', value => { 
          localStorage.setItem('darkMode', value.toString()); 
          applyThemeState(currentTheme, value);
        });

        $watch('currentTheme', value => {
          applyThemeState(value, darkMode);
        });

        const criticalStyle = document.getElementById('dark-mode-critical');
        if (criticalStyle) {
          setTimeout(() => criticalStyle.remove(), 150);
        }
      "
      @storage.window="if ($event.key === 'appTheme') currentTheme = $event.newValue || 'default'"
      @theme-changed="currentTheme = $event.detail"
      :class="{ 'dark': darkMode }"
      class="bg-gray-50 dark:bg-black min-h-screen overflow-x-hidden">
  
  <!-- Theme Selector Modal -->
  <div x-data="{
         themeSelectorOpen: false,
         currentThemeIndex: 0,
         previewTheme: 'default',
         themes: [
           { id: 'default', name: 'Pharmagest', primary: '#0056a6', secondary: '#00a8e8', glow: 'theme-glow-blue' },
           { id: 'neubrutalism', name: 'Neubrutalism', primary: '#FFD60A', secondary: '#7C3AED', glow: 'theme-glow-neubrutalism' },
           { id: 'minimal', name: 'Minimal', primary: '#C47B5A', secondary: '#E5B299', glow: 'theme-glow-minimal' }
         ],
         get currentTheme() {
           return this.themes[this.currentThemeIndex];
         },
         applyThemePreview() {
           // Apply theme in real-time for preview
           localStorage.setItem('appTheme', this.currentTheme.id);
           document.documentElement.setAttribute('data-theme', this.currentTheme.id);
           this.previewTheme = this.currentTheme.id;
         },
         nextTheme() {
           this.currentThemeIndex = (this.currentThemeIndex + 1) % this.themes.length;
           this.applyThemePreview();
         },
         prevTheme() {
           this.currentThemeIndex = (this.currentThemeIndex - 1 + this.themes.length) % this.themes.length;
           this.applyThemePreview();
         },
         confirmTheme() {
           localStorage.setItem('appTheme', this.currentTheme.id);
           $dispatch('theme-changed', this.currentTheme.id);
           this.themeSelectorOpen = false;
         },
         openSettings() {
           this.themeSelectorOpen = false;
           setTimeout(() => {
             document.querySelector('[\\@click*=settingsOpen]').click();
           }, 400);
         }
       }"
       @open-theme-selector.window="themeSelectorOpen = true; 
                                      const saved = localStorage.getItem('appTheme') || 'default';
                                      currentThemeIndex = themes.findIndex(t => t.id === saved);
                                      previewTheme = themes[currentThemeIndex].id;"
       x-show="themeSelectorOpen"
       class="fixed inset-0 z-[9999] flex items-end justify-center pointer-events-none"
       style="display: none;">
    
    <!-- Theme Selector Bar -->
    <div class="relative mb-6 w-full max-w-4xl mx-4 pointer-events-auto"
         x-transition:enter="theme-selector-enter"
         x-transition:leave="theme-selector-leave">
      
      <!-- Glow effect with local blur -->
      <div class="absolute inset-0 rounded-full transition-all duration-500 blur-2xl opacity-60"
           :class="currentTheme.glow"></div>
      
      <!-- Main content -->
      <div class="relative bg-white/95 dark:bg-gray-900/95 backdrop-blur-xl rounded-full shadow-2xl border border-gray-200 dark:border-gray-700 px-6 py-3">
        
        <!-- Compact horizontal layout -->
        <div class="flex items-center justify-between gap-4">
          <!-- Back button -->
          <button @click="openSettings()"
                  class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors flex-shrink-0"
                  title="Torna alle impostazioni">
            <i class="fas fa-arrow-left text-gray-600 dark:text-gray-400 text-sm"></i>
          </button>
          
          <!-- Previous button -->
          <button @click="prevTheme()"
                  class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all transform hover:scale-110 flex-shrink-0">
            <i class="fas fa-chevron-left" 
               :style="`color: ${currentTheme.primary}`"></i>
          </button>
          
          <!-- Theme preview (compact) -->
          <div class="flex items-center gap-3 flex-1 min-w-0">
            <div class="flex gap-2 flex-shrink-0">
              <div class="w-8 h-8 rounded-full transition-all duration-500"
                   :style="`background: ${currentTheme.primary}; box-shadow: 0 2px 10px ${currentTheme.primary}40`"></div>
              <div class="w-8 h-8 rounded-full transition-all duration-500"
                   :style="`background: ${currentTheme.secondary}; box-shadow: 0 2px 10px ${currentTheme.secondary}40`"></div>
            </div>
            <div class="flex-1 min-w-0">
              <h4 class="text-base font-semibold text-gray-900 dark:text-gray-100 truncate"
                  x-text="currentTheme.name"></h4>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <span x-text="currentThemeIndex + 1"></span> / <span x-text="themes.length"></span>
              </p>
            </div>
          </div>
          
          <!-- Next button -->
          <button @click="nextTheme()"
                  class="p-2 rounded-full bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-all transform hover:scale-110 flex-shrink-0">
            <i class="fas fa-chevron-right"
               :style="`color: ${currentTheme.primary}`"></i>
          </button>
          
          <!-- Confirm button -->
          <button @click="confirmTheme()"
                  class="px-4 py-2 rounded-full font-semibold text-white text-sm transition-all transform hover:scale-105 shadow-lg flex-shrink-0"
                  :style="`background: linear-gradient(135deg, ${currentTheme.primary} 0%, ${currentTheme.secondary} 100%)`">
            <i class="fas fa-check mr-1"></i>
            OK
          </button>
          
          <!-- Close button -->
          <button @click="themeSelectorOpen = false"
                  class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition-colors flex-shrink-0"
                  title="Chiudi">
            <i class="fas fa-times text-gray-600 dark:text-gray-400 text-sm"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications Manager Modal -->
  <div x-data="{
         notifManagerOpen: false,
         showAddModal: false,
         editMode: false,
         thresholdId: null,
         selectedProduct: '',
         productName: '',
         threshold: 10,
         active: true,
         soglie: [],
         prodotti: [],
         loadData() {
           fetch('/api/soglie_data')
             .then(r => r.json())
             .then(data => {
               this.soglie = data.soglie;
               this.prodotti = data.prodotti;
             });
         },
         openAddModal() {
           this.editMode = false;
           this.thresholdId = null;
           this.selectedProduct = '';
           this.productName = '';
           this.threshold = 10;
           this.active = true;
           this.showAddModal = true;
         },
         editThreshold(soglia) {
           this.editMode = true;
           this.thresholdId = soglia.id;
           this.selectedProduct = soglia.codice_prodotto;
           this.productName = soglia.nome_prodotto;
           this.threshold = soglia.soglia_minima;
           this.active = soglia.notifica_attiva;
           this.showAddModal = true;
         },
         submitForm(event) {
           const form = event.target;
           const formData = new FormData(form);
           fetch(form.action, {
             method: 'POST',
             body: formData
           }).then(response => {
             if(response.redirected) {
               this.showAddModal = false;
               this.loadData();
               window.refreshNotifications();
             }
             return response.text();
           });
         },
         toggleThreshold(id) {
           const formData = new FormData();
           formData.append('threshold_id', id);
           fetch('/toggle_threshold', {
             method: 'POST',
             body: formData
           }).then(() => {
             this.loadData();
             window.refreshNotifications();
           });
         },
         deleteThreshold(id) {
           if(confirm('Sei sicuro di voler eliminare questa soglia?')) {
             const formData = new FormData();
             formData.append('threshold_id', id);
             fetch('/delete_threshold', {
               method: 'POST',
               body: formData
             }).then(() => {
               this.loadData();
               window.refreshNotifications();
             });
           }
         }
       }"
       @open-notifications-manager.window="notifManagerOpen = true; loadData();"
       x-show="notifManagerOpen"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       class="fixed inset-0 bg-black bg-opacity-50 z-[9998] flex items-center justify-center p-4"
       style="display: none;">
    
    <div @click.away="notifManagerOpen = false"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0 transform scale-95"
         x-transition:enter-end="opacity-100 transform scale-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100 transform scale-100"
         x-transition:leave-end="opacity-0 transform scale-95"
         class="glass-card rounded-xl p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto bg-white dark:bg-gray-800">
      
      <!-- Header -->
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
          <i class="fas fa-bell mr-2" style="color: #2256a7;"></i>
          Gestione Soglie Notifiche
        </h2>
        <button @click="notifManagerOpen = false" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <p class="text-gray-600 dark:text-gray-400 mb-6">
        Imposta le soglie minime per ricevere notifiche quando un prodotto scende sotto una certa quantità
      </p>
      
      <!-- Pulsante Aggiungi -->
      <button @click="openAddModal()" 
              class="gradient-btn px-6 py-3 rounded-lg font-medium flex items-center text-white mb-6">
        <i class="fas fa-plus mr-2"></i>
        Aggiungi Nuova Soglia
      </button>
      
      <!-- Lista Soglie -->
      <div class="space-y-4">
        <template x-if="soglie.length === 0">
          <div class="text-center py-12">
            <i class="fas fa-bell-slash text-5xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">Nessuna Soglia Configurata</h3>
            <p class="text-gray-500 dark:text-gray-400">Aggiungi la tua prima soglia per iniziare a ricevere notifiche</p>
          </div>
        </template>
        
        <template x-for="soglia in soglie" :key="soglia.id">
          <div class="glass-card rounded-lg p-4 border border-gray-200 dark:border-gray-600 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-start justify-between mb-2">
                  <div>
                    <h3 class="font-semibold text-gray-900 dark:text-white" x-text="soglia.nome_prodotto"></h3>
                    <p class="text-xs text-gray-500 dark:text-gray-400" x-text="soglia.codice_prodotto"></p>
                  </div>
                  <span class="px-3 py-1 rounded-full text-xs font-semibold"
                        :class="soglia.notifica_attiva ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300'"
                        x-text="soglia.notifica_attiva ? 'Attiva' : 'Disattivata'"></span>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mt-3">
                  <div class="flex items-center text-sm">
                    <i class="fas fa-chart-line mr-2 text-gray-400"></i>
                    <span class="text-gray-600 dark:text-gray-400">Soglia:</span>
                    <span class="ml-2 font-bold" style="color: #2256a7;" x-text="soglia.soglia_minima"></span>
                  </div>
                  <div class="flex items-center text-sm">
                    <i class="fas fa-box mr-2 text-gray-400"></i>
                    <span class="text-gray-600 dark:text-gray-400">Attuale:</span>
                    <span class="ml-2 font-bold"
                          :class="soglia.quantita_attuale <= soglia.soglia_minima ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"
                          x-text="soglia.quantita_attuale"></span>
                  </div>
                </div>
              </div>
              
              <div class="flex space-x-2 ml-4">
                <button @click="editThreshold(soglia)"
                        class="px-3 py-2 text-xs font-medium rounded-lg text-white"
                        style="background: linear-gradient(135deg, #2256a7, #1e4d96);">
                  <i class="fas fa-edit"></i>
                </button>
                <button @click="toggleThreshold(soglia.id)"
                        class="px-3 py-2 text-xs font-medium rounded-lg text-white bg-gray-500 hover:bg-gray-600">
                  <i :class="soglia.notifica_attiva ? 'fas fa-pause' : 'fas fa-play'"></i>
                </button>
                <button @click="deleteThreshold(soglia.id)"
                        class="px-3 py-2 text-xs font-medium rounded-lg text-white bg-red-500 hover:bg-red-600">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>
      
      <!-- Modal Aggiungi/Modifica interno -->
      <div x-show="showAddModal"
           x-transition
           class="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4"
           style="display: none;">
        <div @click.away="showAddModal = false"
             class="glass-card rounded-xl p-6 max-w-md w-full bg-white dark:bg-gray-800">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold dark:text-white" style="color: #2256a7;">
              <i class="fas fa-bell mr-2"></i>
              <span x-text="editMode ? 'Modifica Soglia' : 'Aggiungi Nuova Soglia'"></span>
            </h3>
            <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          
          <form :action="editMode ? '/update_threshold' : '/add_threshold'" method="POST" @submit.prevent="submitForm($event)">
            <input type="hidden" name="threshold_id" x-model="thresholdId">
            
            <div class="mb-4" x-show="!editMode">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="fas fa-box mr-1"></i>Prodotto
              </label>
              <select name="codice_prodotto" x-model="selectedProduct" required
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-white">
                <option value="">-- Seleziona un prodotto --</option>
                <template x-for="prod in prodotti" :key="prod.codice_prodotto">
                  <option :value="prod.codice_prodotto" x-text="`${prod.codice_prodotto} - ${prod.nome_prodotto}`"></option>
                </template>
              </select>
            </div>
            
            <div x-show="editMode" class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prodotto</label>
              <input type="text" x-model="productName" readonly
                     class="w-full px-3 py-2 border rounded-lg bg-gray-100 dark:bg-gray-700 dark:text-white">
              <input type="hidden" name="codice_prodotto" x-model="selectedProduct">
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                <i class="fas fa-chart-line mr-1"></i>Soglia Minima
              </label>
              <input type="number" name="soglia_minima" x-model="threshold" min="0" required
                     class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 dark:text-white">
            </div>
            
            <div class="mb-6">
              <label class="flex items-center cursor-pointer">
                <input type="checkbox" name="notifica_attiva" x-model="active" value="true"
                       class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                <span class="ml-2 text-sm font-medium text-gray-700 dark:text-gray-300">
                  <i class="fas fa-bell mr-1"></i>Notifica attiva
                </span>
              </label>
            </div>
            
            <div class="flex space-x-3">
              <button type="button" @click="showAddModal = false"
                      class="flex-1 px-4 py-2 border rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                Annulla
              </button>
              <button type="submit"
                      class="flex-1 px-4 py-2 text-white rounded-lg font-medium"
                      style="background: linear-gradient(135deg, #2256a7, #1e4d96);">
                <span x-text="editMode ? 'Aggiorna' : 'Aggiungi'"></span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 mx-4 rounded text-sm flex items-center gap-3
          {% if category == 'success' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200
          {% elif category == 'error' or category == 'danger' %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200
          {% else %}bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200{% endif %}">
          <span>{{ message }}</span>
          {% if category == 'success' and request.endpoint == 'movimento' %}
            <a href="{{ url_for('index') }}" class="text-xs font-semibold px-2 py-1 rounded bg-white/70 dark:bg-black/40 border border-current hover:underline">
              Vai al Magazzino
            </a>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Sidebar Navigation -->
  <div class="sidebar-container fixed inset-y-0 left-0 w-64 bg-white dark:bg-black shadow-lg z-20 hidden md:block">
    <div class="sidebar-header flex items-center justify-center h-16 px-4">
      <img src="https://raw.githubusercontent.com/emilianpr/phg-img/refs/heads/main/HEAD_Pharmagest.png" 
           alt="Pharmagest Logo" 
           class="h-10 mx-auto">
    </div>
    <nav class="mt-8 px-4 space-y-1">
      <a href="{{ url_for('index') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'index' %}active{% endif %}">
        <i class="fas fa-boxes mr-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Gestione Magazzino
      </a>
      <a href="{{ url_for('movimento') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'movimento' %}active{% endif %}">
        <i class="fas fa-exchange-alt mr-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Movimento
      </a>
      <a href="{{ url_for('movimento_multiplo') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'movimento_multiplo' %}active{% endif %}">
        <i class="fas fa-layer-group mr-3 {% if request.endpoint == 'movimento_multiplo' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Movimento Multiplo
        <span class="ml-auto text-xs bg-amber-500 text-white px-1.5 py-0.5 rounded font-semibold">BETA</span>
      </a>
      <a href="{{ url_for('logmovimenti') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'logmovimenti' %}active{% endif %}">
        <i class="fas fa-file-invoice mr-3 {% if request.endpoint == 'logmovimenti' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Log Movimenti
      </a>
      <a href="{{ url_for('statistics.statistiche') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'statistics.statistiche' %}active{% endif %}">
        <i class="fas fa-chart-line mr-3 {% if request.endpoint == 'statistiche' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Statistiche
      </a>
      <div x-data="{ open: false }" class="relative">
        <a href="#" @click.prevent="open = !open"
           class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}active{% endif %}">
          <i class="fas fa-arrow-down mr-3 {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
          Scarico Merci
          <i class="fas fa-chevron-down ml-auto text-xs"></i>
        </a>
     <div x-show="open" @click.away="open = false"
       class="absolute left-0 mt-1 w-full border border-gray-200 dark:border-gray-600 rounded-md shadow-lg z-30 sidebar-dropdown"
             x-transition>
          <a href="{{ url_for('scaricomerce') }}"
             class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-phg-secondary dark:hover:bg-gray-700 {% if request.endpoint == 'scaricomerce' %}font-bold text-phg-primary{% endif %}">
            Scarico da Magazzino
          </a>
          <a href="{{ url_for('scarico_merce_non_in_magazzino') }}"
             class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-phg-secondary dark:hover:bg-gray-700 {% if request.endpoint == 'scarico_merce_non_in_magazzino' %}font-bold text-phg-primary{% endif %}">
            Scarico NON in Magazzino
          </a>
        </div>
      </div>
      <a href="{{ url_for('carico_merci') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'carico_merci' %}active{% endif %}">
        <i class="fas fa-arrow-up mr-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Carico Merci
      </a>
      <a href="{{ url_for('warehouse_reconciliation') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'warehouse_reconciliation' %}active{% endif %}">
        <i class="fas fa-balance-scale mr-3 {% if request.endpoint == 'warehouse_reconciliation' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Confronto AS400
      </a>
      <a href="{{ url_for('rientro_merce') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'rientro_merce' %}active{% endif %}">
        <i class="fas fa-undo mr-3 {% if request.endpoint == 'rientro_merce' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Rientro Merce
      </a> 
      
      {% if session.get('is_admin') %}

      <a href="{{ url_for('auth.register') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'auth.register' %}active{% endif %}">
        <i class="fas fa-users-cog mr-3 {% if request.endpoint == 'register' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Gestione Utenti
      </a>
      {% endif %}
    </nav>
  <div class="sidebar-footer absolute bottom-0 left-0 right-0 p-4">
      <div class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-600">
        <a href="https://github.com/emilianpr/magazzino_webapp/issues" target="_blank" rel="noopener" class="bug-btn group flex items-center w-full px-4 py-2 text-sm font-medium rounded-md">
          <i class="fas fa-bug text-red-500 mr-2"></i>
          <span class="flex-grow text-left">Segnala Bug</span>
          <i class="fas fa-up-right-from-square text-xs text-gray-400 group-hover:text-red-500 transition-colors"></i>
        </a>
      </div>
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-white dark:bg-gray-700 rounded-full border border-gray-200 dark:border-gray-600 flex items-center justify-center h-10 w-10">
          <i class="fas fa-user text-gray-700 dark:text-gray-300"></i>
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ username }}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {% if session.get('is_admin') %}
              Amministratore
            {% else %}
              Utente
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay md:hidden" 
       :class="{ 'active': sidebarOpen }" 
       @click="sidebarOpen = false"></div>

  <!-- Mobile Sidebar -->
  <div class="sidebar-container fixed inset-y-0 left-0 w-64 bg-white dark:bg-black shadow-lg z-20 md:hidden mobile-sidebar"
       :class="{ 'open': sidebarOpen }">
    <div class="sidebar-header flex items-center justify-center h-16 px-4">
      <img src="https://raw.githubusercontent.com/emilianpr/phg-img/refs/heads/main/HEAD_Pharmagest.png" 
           alt="Pharmagest Logo" 
           class="h-10 mx-auto">
    </div>
    <nav class="mt-8 px-4 space-y-1">
      <a href="{{ url_for('index') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'index' %}active{% endif %}">
        <i class="fas fa-boxes mr-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Gestione Magazzino
      </a>
      <a href="{{ url_for('movimento') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'movimento' %}active{% endif %}">
        <i class="fas fa-exchange-alt mr-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Movimento
      </a>
      <a href="{{ url_for('movimento_multiplo') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'movimento_multiplo' %}active{% endif %}">
        <i class="fas fa-layer-group mr-3 {% if request.endpoint == 'movimento_multiplo' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Mov. Multiplo
        <span class="ml-auto text-xs bg-amber-500 text-white px-1.5 py-0.5 rounded font-semibold">BETA</span>
      </a>
      <a href="{{ url_for('logmovimenti') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logmovimenti' %}active{% endif %}">
        <i class="fas fa-file-invoice mr-3 {% if request.endpoint == 'logmovimenti' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Movimenti
      </a>
      <a href="{{ url_for('statistics.statistiche') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'statistics.statistiche' %}active{% endif %}">
        <i class="fas fa-chart-line mr-3 {% if request.endpoint == 'statistics.statistiche' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Statistiche
      </a>
      <div x-data="{ open: false }" class="relative">
        <a href="#" @click.prevent="open = !open"
           class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}active{% endif %}">>
          <i class="fas fa-arrow-down mr-3 {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
          Scarico Merci
          <i class="fas fa-chevron-down ml-auto text-xs"></i>
        </a>
        <div x-show="open" @click.away="open = false"
             class="absolute left-0 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg z-30"
             x-transition>
          <a href="{{ url_for('scaricomerce') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scaricomerce' %}font-bold text-phg-primary{% endif %}">
            Scarico da Magazzino
          </a>
          <a href="{{ url_for('scarico_merce_non_in_magazzino') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scarico_merce_non_in_magazzino' %}font-bold text-phg-primary{% endif %}">
            Scarico NON in Magazzino
          </a>
        </div>
      </div>
      <a href="{{ url_for('carico_merci') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'carico_merci' %}active{% endif %}">
        <i class="fas fa-arrow-up mr-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Carico Merci
      </a>
      <a href="{{ url_for('warehouse_reconciliation') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'warehouse_reconciliation' %}active{% endif %}">
        <i class="fas fa-balance-scale mr-3 {% if request.endpoint == 'warehouse_reconciliation' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Riconciliazione Magazzino
      </a>
      <a href="{{ url_for('nuovo_prodotto') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'nuovo_prodotto' %}active{% endif %}">
        <i class="fas fa-plus mr-3 {% if request.endpoint == 'nuovo_prodotto' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Nuovo Prodotto
      </a>
      <a href="{{ url_for('rientro_merce') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'rientro_merce' %}active{% endif %}">
        <i class="fas fa-undo mr-3 {% if request.endpoint == 'rientro_merce' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Rientro Merce
      </a>

      {% if session.get('is_admin') %}

      <a href="{{ url_for('auth.register') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'auth.register' %}active{% endif %}">
        <i class="fas fa-users-cog mr-3 {% if request.endpoint == 'auth.register' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Gestione Utenti
      </a>
      {% endif %}
    </nav>
  </div>

  <!-- Main Content -->

  <div class="md:ml-64 main-content-area">
    <!-- Top Navigation (sticky, dentro main-content-area) -->
    <div class="sticky top-0 z-10 bg-white dark:bg-black shadow-sm overflow-visible">
      <div class="flex items-center justify-between h-16 px-4">
        <div class="flex items-center">
          <!-- Mobile hamburger menu -->
          <button class="md:hidden mr-3 hamburger-menu" 
                  :class="{ 'active': sidebarOpen }"
                  @click="sidebarOpen = !sidebarOpen">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </button>
          <h1 class="text-lg md:text-xl font-bold text-phg-primary">
            <span class="hidden md:inline">{% block page_title_full %}Gestione Magazzino - Pharmagest ({{ app_version }}){% endblock %}</span>
            <span class="md:hidden">{% block page_title_short %}Magazzino{% endblock %}</span>
          </h1>
        </div>
        <div class="flex items-center gap-4" x-data="{ settingsOpen: false }">
          <!-- Dark Mode Toggle -->
          <button id="dark-mode-toggle" 
                  @click="console.log('Toggle clicked, current darkMode:', darkMode); darkMode = !darkMode; console.log('New darkMode:', darkMode);"
                  class="topbar-icon" 
                  title="Toggle Dark Mode"
                  aria-label="Attiva/Disattiva modalità scura">
            <i class="fas text-lg" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
          </button>
          <!-- Icona Admin Panel (solo per admin) -->
          {% if session.get('is_admin') %}
          <a href="{{ url_for('admin_panel') }}" 
             class="topbar-icon" 
             title="Pannello Admin"
             aria-label="Pannello amministratore">
            <i class="fas fa-user-shield text-lg"></i>
          </a>
          {% endif %}
          
          <!-- Icona Changelog -->
          <a href="{{ url_for('changelogs') }}" 
             class="topbar-icon" 
             title="Changelog"
             aria-label="Visualizza changelog">
            <i class="fas fa-code-branch text-lg"></i>
          </a>
          
          <!-- Notifications Bell -->
          <div class="relative" x-data="{
                 notificationsOpen: false,
                 notificationCount: 0,
                 notifications: [],
                 fetchNotifications() {
                   fetch('/notifications')
                     .then(response => response.json())
                     .then(data => {
                       this.notificationCount = data.count;
                       this.notifications = data.notifications;
                     })
                     .catch(error => console.error('Errore nel caricamento notifiche:', error));
                 },
                 markAsRead(notificationId) {
                   fetch(`/mark_notification_read/${notificationId}`, {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' }
                   })
                   .then(response => response.json())
                   .then(data => {
                     if (data.success) {
                       this.notifications = this.notifications.filter(n => n.id !== notificationId);
                       this.notificationCount = this.notifications.length;
                     }
                   })
                   .catch(error => console.error('Errore:', error));
                 },
                 markAllRead() {
                   fetch('/mark_all_notifications_read', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' }
                   })
                   .then(response => response.json())
                   .then(data => {
                     if (data.success) {
                       this.notifications = [];
                       this.notificationCount = 0;
                     }
                   })
                   .catch(error => console.error('Errore:', error));
                 },
                 formatDate(dateString) {
                   const date = new Date(dateString);
                   const now = new Date();
                   const diff = now - date;
                   const minutes = Math.floor(diff / 60000);
                   const hours = Math.floor(diff / 3600000);
                   const days = Math.floor(diff / 86400000);
                   
                   if (minutes < 1) return 'Adesso';
                   if (minutes < 60) return minutes + ' min fa';
                   if (hours < 24) return hours + ' ore fa';
                   if (days < 7) return days + ' giorni fa';
                   
                   return date.toLocaleDateString('it-IT', { 
                     day: '2-digit', 
                     month: '2-digit', 
                     year: 'numeric',
                     hour: '2-digit',
                     minute: '2-digit'
                   });
                 }
               }"
               x-init="fetchNotifications(); setInterval(() => fetchNotifications(), 30000)">
            <button @click="notificationsOpen = !notificationsOpen"
                    class="topbar-icon relative" 
                    title="Notifiche"
                    aria-label="Visualizza notifiche">
              <i class="fas fa-bell text-lg"></i>
              <span x-show="notificationCount > 0" 
                    class="absolute top-0 right-0 bg-red-500 rounded-full h-2 w-2"></span>
            </button>
            
            <!-- Notifications Dropdown -->
            <div x-show="notificationsOpen" 
                 @click.away="notificationsOpen = false"
                 x-transition:enter="transition ease-out duration-200"
                 x-transition:enter-start="opacity-0 transform scale-95"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-150"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-95"
                 class="fixed right-4 mt-2 w-96 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 max-h-[500px] overflow-y-auto"
                 style="display: none; z-index: 9999; top: 4rem;">
              <!-- Header -->
              <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center sticky top-0 bg-white dark:bg-gray-800">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                  <i class="fas fa-bell mr-2 text-phg-primary"></i>
                  Notifiche <span x-show="notificationCount > 0" class="text-sm text-gray-500" x-text="'(' + notificationCount + ')'"></span>
                </h3>
                <button @click="markAllRead()" 
                        x-show="notificationCount > 0"
                        class="text-xs text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
                  Segna tutte come lette
                </button>
              </div>
              
              <!-- Notifications List -->
              <div class="divide-y divide-gray-200 dark:divide-gray-700">
                <template x-if="notifications.length === 0">
                  <div class="p-6 text-center">
                    <i class="fas fa-bell-slash text-4xl text-gray-300 dark:text-gray-600 mb-2"></i>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">Nessuna notifica</p>
                  </div>
                </template>
                
                <template x-for="notif in notifications" :key="notif.id">
                  <div class="p-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <div class="flex justify-between items-start">
                      <div class="flex-1">
                        <p class="text-sm font-semibold text-gray-900 dark:text-white" x-text="notif.nome_prodotto"></p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                          <span x-text="notif.codice_prodotto"></span>
                        </p>
                        <div class="mt-2 space-y-1">
                          <p class="text-xs text-red-600 dark:text-red-400">
                            <i class="fas fa-exclamation-triangle mr-1"></i>
                            Quantità attuale: <strong x-text="notif.quantita_attuale"></strong>
                          </p>
                          <p class="text-xs text-gray-600 dark:text-gray-400">
                            <i class="fas fa-chart-line mr-1"></i>
                            Soglia minima: <strong x-text="notif.soglia_minima"></strong>
                          </p>
                          <p class="text-xs text-gray-500 dark:text-gray-400">
                            <i class="far fa-clock mr-1"></i>
                            <span x-text="formatDate(notif.data_notifica)"></span>
                          </p>
                        </div>
                      </div>
                      <button @click="markAsRead(notif.id)" 
                              class="ml-2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400"
                              title="Segna come letta">
                        <i class="fas fa-check"></i>
                      </button>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
          
          <!-- Settings Tab Toggle -->
          <div class="relative">
            <button @click="settingsOpen = !settingsOpen"
                    class="topbar-icon" 
                    title="Impostazioni"
                    aria-label="Apri impostazioni">
              <i class="fas fa-cog text-lg"></i>
            </button>
            
            <!-- Settings Dropdown Panel -->
            <div x-show="settingsOpen" 
                 @click.away="settingsOpen = false"
                 x-transition:enter="settings-panel-enter"
                 x-transition:leave="settings-panel-leave"
                 class="fixed right-4 mt-2 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700"
                 style="display: none; z-index: 9999; top: 4rem;">
              <!-- Header -->
              <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                  <i class="fas fa-cog mr-2 text-phg-primary"></i>
                  Impostazioni
                </h3>
              </div>
              
              <!-- Settings Content -->
              <div class="p-4 space-y-4">
                <!-- User Info -->
                <div class="pb-3 border-b border-gray-200 dark:border-gray-700">
                  <div class="flex items-center">
                    <div class="flex-shrink-0 bg-gray-100 dark:bg-gray-700 rounded-full border border-gray-200 dark:border-gray-600 flex items-center justify-center h-12 w-12">
                      <i class="fas fa-user text-gray-700 dark:text-gray-300 text-xl"></i>
                    </div>
                    <div class="ml-3">
                      <p class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ username }}</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400">
                        {% if session.get('is_admin') %}
                          <i class="fas fa-shield-alt mr-1"></i>Amministratore
                        {% else %}
                          <i class="fas fa-user mr-1"></i>Utente
                        {% endif %}
                      </p>
                    </div>
                  </div>
                </div>
                
                <!-- Settings Options -->
                <div class="space-y-2">
                  <!-- Dark Mode Setting -->
                  <div class="flex items-center justify-between p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">
                    <div class="flex items-center">
                      <i class="fas fa-moon text-gray-500 dark:text-gray-400 mr-3"></i>
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Modalità Scura</span>
                    </div>
                    <button @click="darkMode = !darkMode"
                            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none"
                            :class="darkMode ? 'bg-phg-primary' : 'bg-gray-300 dark:bg-gray-600'">
                      <span class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"
                            :class="darkMode ? 'translate-x-6' : 'translate-x-1'"></span>
                    </button>
                  </div>
                  
                  <!-- Theme Selector Button -->
                  <button @click="settingsOpen = false; $dispatch('open-theme-selector')"
                          class="flex items-center w-full p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-palette text-gray-500 dark:text-gray-400 mr-3"></i>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Tema Applicazione</span>
                    <i class="fas fa-chevron-right ml-auto text-gray-400 text-xs"></i>
                  </button>
                  
                  <!-- Gestisci Notifiche -->
                  <button @click="settingsOpen = false; $dispatch('open-notifications-manager')"
                          class="flex items-center w-full p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <i class="fas fa-bell text-gray-500 dark:text-gray-400 mr-3"></i>
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Gestisci notifiche</span>
                    <i class="fas fa-chevron-right ml-auto text-gray-400 text-xs"></i>
                  </button>
                  
                  <!-- Version Info -->
                  <div class="flex items-center justify-between p-2 rounded-md">
                    <div class="flex items-center">
                      <i class="fas fa-info-circle text-gray-500 dark:text-gray-400 mr-3"></i>
                      <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Versione</span>
                    </div>
                    <span class="text-xs text-gray-500 dark:text-gray-400 font-mono">{{ app_version }}</span>
                  </div>
                  
                  <!-- Logout -->
                  <a href="{{ url_for('auth.logout') }}"
                     class="flex items-center p-2 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    <span class="text-sm font-medium">Esci</span>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    {% block content %}{% endblock %}
  </div>

  <!-- Mobile Menu (hidden by default) -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-black shadow-lg z-10">
    <div class="flex justify-around">
      <a href="{{ url_for('index') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-boxes text-lg"></i>
        <span class="text-xs mt-1">Magazzino</span>
      </a>
      <a href="{{ url_for('movimento') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-exchange-alt text-lg"></i>
        <span class="text-xs mt-1">Movimento</span>
      </a>
      <a href="{{ url_for('carico_merci') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-arrow-up text-lg"></i>
        <span class="text-xs mt-1">Carico</span>
      </a>
      {% if session.get('is_admin') %}
      <a href="{{ url_for('rientro_merce') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'rientro_merce' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-undo text-lg"></i>
        <span class="text-xs mt-1">Rientro</span>
      </a>
      {% endif %}
    </div>
  </div>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <script>
    // Fallback e debugging per il dark mode toggle
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, localStorage darkMode:', localStorage.getItem('darkMode'));
      console.log('Body classes:', document.body.classList.toString());
      console.log('DocumentElement classes:', document.documentElement.classList.toString());
      
      const toggleButton = document.getElementById('dark-mode-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          console.log('Fallback click listener triggered');
          // Verifica lo stato del localStorage dopo il click
          setTimeout(() => {
            const currentMode = localStorage.getItem('darkMode');
            const hasBodyDark = document.body.classList.contains('dark');
            const hasHtmlDark = document.documentElement.classList.contains('dark');
            console.log('Dopo click - localStorage:', currentMode, 'body.dark:', hasBodyDark, 'html.dark:', hasHtmlDark);
            
            // Se c'è inconsistenza, correggi
            if (currentMode === 'true' && (!hasBodyDark || !hasHtmlDark)) {
              console.log('Correzione: attivando dark mode');
              document.body.classList.add('dark');
              document.documentElement.classList.add('dark');
              const theme = localStorage.getItem('appTheme') || 'default';
              const bg = theme === 'minimal' ? '#15100C' : '#000000';
              document.body.style.setProperty('background-color', bg, 'important');
              document.documentElement.style.setProperty('background-color', bg, 'important');
            } else if (currentMode === 'false' && (hasBodyDark || hasHtmlDark)) {
              console.log('Correzione: disattivando dark mode');
              document.body.classList.remove('dark');
              document.documentElement.classList.remove('dark');
              document.body.style.backgroundColor = '';
              document.documentElement.style.backgroundColor = '';
            }
          }, 50);
        });
      }
    });
  </script>
  
  <script>
    // Funzione globale per aggiornare le notifiche da altri componenti
    window.refreshNotifications = function() {
      const notifElement = document.querySelector('[x-data*="notificationsOpen"]');
      if (notifElement && notifElement.__x) {
        const component = Alpine.$data(notifElement);
        if (component && typeof component.fetchNotifications === 'function') {
          component.fetchNotifications();
        }
      }
    };
  </script>

  
  {% block extra_js %}{% endblock %}
</body>
</html>
