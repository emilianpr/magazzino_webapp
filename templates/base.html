<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Gestione Magazzino - Pharmagest{% endblock %}</title>
  
  <!-- Script per applicare immediatamente la dark mode senza flash -->
  <script>
    (function() {
      const darkMode = localStorage.getItem('darkMode');
      if (darkMode === 'true') {
        document.documentElement.classList.add('dark');
        document.documentElement.style.backgroundColor = '#000000';
        // Assicuriamoci che il body mantenga l'altezza corretta
        document.documentElement.style.minHeight = '100vh';
      }
    })();
  </script>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            phg: {
              primary: '#0056a6',
              secondary: '#e3f2fd',
              accent: '#00a8e8',
              dark: '#003d7a',
              light: '#f0f8ff'
            }
          },
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    /* Reset base margins */
    body, html {
      margin: 0 !important;
      padding: 0 !important;
    }

    
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f8fafc;
    }
    
    .glass-card {
      background: linear-gradient(120deg, #e3f2fd 0%, #f0f8ff 100%);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
      border-radius: 1.25rem;
      padding: 2.5rem 2rem;
      position: relative;
      width: 100%;
      min-width: 0;
      box-sizing: border-box;
      transition: background 0.3s ease, border-color 0.3s ease;
    }
    
    .glass-card > * {
      position: relative;
      z-index: 1;
    }
    
    .glass-card::before {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 1.25rem;
      background: transparent;
      opacity: 0;
      z-index: 0;
    }

    /* Dark mode styles */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow: rgba(0, 0, 0, 0.1);
    }



    .dark {
      --bg-primary: #0a0a0a; /* Quasi nero per le card */
      --bg-secondary: #000000; /* Nero puro AMOLED per lo sfondo */
      --bg-tertiary: #1a1a1a; /* Grigio molto scuro per elementi hover */
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --border-color: #2a2a2a;
      --shadow: rgba(0, 0, 0, 0.8);
    }

    .dark body {
      background-color: #000000 !important; /* Nero puro AMOLED */
      color: var(--text-primary) !important;
    }

    .dark .glass-card {
      background: linear-gradient(120deg, rgba(227, 242, 253, 0.15) 0%, rgba(240, 248, 255, 0.1) 100%) !important;
      border: 1px solid rgba(227, 242, 253, 0.2) !important;
      backdrop-filter: blur(10px);
    }

    .dark .bg-white {
      background-color: #0a0a0a !important; /* Quasi nero per uniformità AMOLED */
    }

    .dark .bg-gray-50 {
      background-color: #000000 !important; /* Nero puro */
    }

    .dark .bg-gray-100 {
      background-color: #0a0a0a !important; /* Quasi nero */
    }

    .dark .text-gray-900 {
      color: var(--text-primary) !important;
    }

    .dark .text-gray-700 {
      color: var(--text-primary) !important;
    }

    .dark .text-gray-500 {
      color: var(--text-secondary) !important;
    }

    .dark .border-gray-200 {
      border-color: var(--border-color) !important;
    }

    .dark .border-gray-300 {
      border-color: var(--border-color) !important;
    }
    .main-content-area {
      margin-left: 256px;
      margin-right: 0;
      margin-top: 0 !important;
      width: calc(100vw - 256px);
      max-width: none;
      min-width: 0;
      transition: none;
    }
    @media (max-width: 1024px) {
      .main-content-area {
        margin-left: 0;
        margin-top: 0 !important;
        width: 100vw;
        max-width: 100vw;
      }
    }
    .main-content-area > [x-data] > div:first-child.px-2.md\:px-6 {
      padding: 0 0.5rem 1rem 0.5rem !important; /* mobile */
    }

    @media (min-width: 768px) {
      .main-content-area > [x-data] > div:first-child.px-2.md\:px-6 {
        padding: 0 1.5rem 1.5rem 1.5rem !important; /* desktop */
      }
    }
    
    /* Reset completo per contenuto principale */
    .nav-pill {
      transition: all 0.3s ease;
    }
    .nav-pill:hover {
      background-color: rgba(0, 86, 166, 0.1);
    }
    .dark .nav-pill:hover {
      background-color: var(--bg-tertiary);
    }
    .nav-pill.active {
      background-color: rgba(0, 86, 166, 0.2);
      border-left: 3px solid #0056a6;
    }
    .dark .nav-pill.active {
      background-color: var(--bg-tertiary);
    }
    
    /* Dark mode toggle button */
    .dark-mode-toggle {
      transition: all 0.3s ease;
    }
    .dark-mode-toggle {
      transition: all 0.3s ease;
    }
    
    /* Rimuovi margini dalla navigazione principale */
    .main-content-area > .sticky {
      margin-top: 0 !important;
      padding-top: 0 !important;
      border-top: none !important;
    }
    
    /* Forza eliminazione completa di qualsiasi gap superiore */
    body, html {
      margin: 0 !important;
      padding: 0 !important;
    }
    
    body > * {
      margin-top: 0 !important;
    }
    
    /* Stili per input e form elements in dark mode */
    .dark input[type="text"],
    .dark input[type="number"],
    .dark input[type="email"],
    .dark input[type="password"],
    .dark select,
    .dark textarea {
      background-color: #0a0a0a !important;
      border-color: #2a2a2a !important;
      color: var(--text-primary) !important;
    }

    .dark input[type="text"]:focus,
    .dark input[type="number"]:focus,
    .dark input[type="email"]:focus,
    .dark input[type="password"]:focus,
    .dark select:focus,
    .dark textarea:focus {
      background-color: #1a1a1a !important;
      border-color: #3a3a3a !important;
    }

    /* Stili per button in dark mode */
    .dark .bg-blue-600 {
      background-color: #1e40af !important;
    }

    .dark .bg-blue-600:hover {
      background-color: #1d4ed8 !important;
    }

    .dark .bg-red-600 {
      background-color: #dc2626 !important;
    }

    .dark .bg-red-600:hover {
      background-color: #b91c1c !important;
    }

    .dark .bg-green-600 {
      background-color: #059669 !important;
    }

    .dark .bg-green-600:hover {
      background-color: #047857 !important;
    }

    /* Stili per shadow in dark mode */
    .dark .shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.8), 0 4px 6px -2px rgba(0, 0, 0, 0.4) !important;
    }

    .dark .shadow-xl {
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.8), 0 10px 10px -5px rgba(0, 0, 0, 0.4) !important;
    }

    /* Stili per table in dark mode */
    .dark table {
      background-color: #0a0a0a !important;
    }

    .dark th {
      background-color: #1a1a1a !important;
      color: var(--text-primary) !important;
    }

    .dark td {
      background-color: #0a0a0a !important;
      color: var(--text-primary) !important;
      border-color: #2a2a2a !important;
    }

    .dark tr:hover td {
      background-color: #1a1a1a !important;
    }

    /* Mobile responsive fixes */
    @media (max-width: 768px) {
      .glass-card {
        padding: 1.5rem 1rem;
        margin: 0.5rem;
      }
    }

    /* Force sidebar header to be clean */
    .sidebar-header,
    .sidebar-header::before,
    .sidebar-header::after {
      background: #ffffff !important;
      background-color: #ffffff !important;
      background-image: none !important;
      background-size: auto !important;
      background-repeat: no-repeat !important;
      background-position: 0 0 !important;
      background-attachment: scroll !important;
    }

    .dark .sidebar-header,
    .dark .sidebar-header::before,
    .dark .sidebar-header::after {
      background: #000000 !important;
      background-color: #000000 !important;
      background-image: none !important;
      background-size: auto !important;
      background-repeat: no-repeat !important;
      background-position: 0 0 !important;
      background-attachment: scroll !important;
    }

    /* Mantieni il logo con i suoi colori originali in dark mode */
    .dark .sidebar-header img {
      background: transparent !important;
      /* Rimosso mix-blend-mode per mantenere i colori originali */
    }

    /* Assicura che non ci siano sfondi su tutto il contenitore del logo */
    .dark .sidebar-header {
      background: transparent !important;
    }

    /* Navigation styles for dark mode */
    .dark .nav-pill {
      color: #d1d5db !important;
    }

    .dark .nav-pill .text-gray-500 {
      color: #9ca3af !important;
    }

    .dark .nav-pill:hover {
      background-color: rgba(55, 65, 81, 0.5) !important;
    }

    .dark .nav-pill.active {
      background-color: rgba(55, 65, 81, 0.7) !important;
    }

    /* Dark mode text colors - rendere i testi blu più chiari */
    .dark .text-phg-primary {
      color: #ffffff !important; /* Azzurro più chiaro */
    }

    /* Assicurarsi che lo sfondo del body sia nero */
    .dark {
      background-color: #000000 !important;
    }

    /* Mobile sidebar styles */
    .mobile-sidebar {
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }
    
    .mobile-sidebar.open {
      transform: translateX(0);
    }
    
    .mobile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 19;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .mobile-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    /* Hamburger menu styles */
    .hamburger-menu {
      display: flex;
      flex-direction: column;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* Global icon-circle centralizzata */
    .icon-circle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 3.5rem;
      height: 3.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #e3f2fd 0%, #00a8e8 100%);
      color: #0056a6;
      font-size: 2rem;
      margin: 0 auto 1.2rem auto;
      box-shadow: 0 2px 8px rgba(0,86,166,0.08);
      transition: all 0.2s ease;
    }
    .dark .icon-circle {
      background: linear-gradient(135deg, #1a1a1a 0%, #2563eb 100%);
      color: #60a5fa;
      box-shadow: 0 2px 8px rgba(96, 165, 250, 0.2);
    }
    .icon-circle.small-icon { width: 2.75rem; height: 2.75rem; font-size: 1.35rem; margin: 0; }

    /* Gradient button riutilizzabile */
    .gradient-btn {
      background: linear-gradient(135deg, #0056a6 0%, #00a8e8 100%);
      color: #ffffff;
      transition: all .3s ease;
      box-shadow: 0 10px 15px -3px rgba(0,86,166,.3), 0 4px 6px -2px rgba(0,86,166,.1);
    }
    .gradient-btn:hover { transform: translateY(-2px); box-shadow: 0 20px 25px -5px rgba(0,86,166,.3),0 10px 10px -5px rgba(0,86,166,.1); }
    .dark .gradient-btn { background: linear-gradient(135deg,#1e40af 0%,#2563eb 100%); box-shadow: 0 4px 16px 0 rgba(37,99,235,.3); }
    .dark .gradient-btn:hover { box-shadow: 0 4px 12px rgba(29,78,216,.4); }

    /* Bug button */
    .bug-btn {
      background: transparent;
      color: #374151; /* gray-700 */
      transition: background .25s ease, color .25s ease;
    }
    .bug-btn:hover {
      background: rgba(239,68,68,0.12); /* soft red tint */
      color: #991b1b; /* red-800 for text change subtle */
    }
    .dark .bug-btn { color: #d1d5db; /* gray-300 */ }
    .dark .bug-btn:hover { background: rgba(239,68,68,0.18); color: #fca5a5; }
    
    .hamburger-line {
      width: 100%;
      height: 2px;
      background-color: #0056a6;
      margin: 2px 0;
      transition: 0.3s;
    }
    
    .dark .hamburger-line {
      background-color: #60a5fa !important;
    }
    
    .hamburger-menu.active .hamburger-line:nth-child(1) {
      transform: rotate(-45deg) translate(-4px, 4px);
    }
    
    .hamburger-menu.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }

    /* Elimina gap tra sticky nav e contenuto - DISABLED per permettere spacing corretto */
    /*
    .main-content-area > .sticky + * {
    margin-top: 0 !important;
    padding-top: 0 !important;
}
    */

    /* Override padding-top generato con pt-16 in index.html */
    .main-content-area .pt-16 {
    padding-top: 0 !important;
    margin-top: 0 !important;
}

    /* Standard top spacing for all pages - solves topbar overlap issue */
    .page-content {
      padding-top: 5rem !important; /* 80px spacing after sticky topbar */
    }
    
    /* Special case for index page which already handles its own spacing */
    .page-content.index-page {
      padding-top: 0 !important;
    }

    
    

    /* DISABLED - troppo aggressivo per spacing pagine */
    /*
    .main-content-area > .sticky + * > div {
    padding-top: 0 !important;
    margin-top: 0 !important;
  }
    */
    
    .hamburger-menu.active .hamburger-line:nth-child(3) {
      transform: rotate(45deg) translate(-4px, -4px);
    } 
    
    /* Break margin collapse on sticky to avoid top gap */
    
      .sticky {
    overflow: auto !important;
    border-top: 1px solid transparent !important;
  }
  .sticky h1 {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
    
    /* Scrollbar pulita cross-browser */
    :root {
      --scrollbar-bg: #f1f5f9; /* slate-100 */
      --scrollbar-thumb: #cbd5e1; /* slate-300 */
      --scrollbar-thumb-hover: #94a3b8; /* slate-400 */
      --scrollbar-thumb-active: #64748b; /* slate-500 */
    }
    .dark :root, .dark {
      --scrollbar-bg: #0f0f0f;
      --scrollbar-thumb: #2d2d2d;
      --scrollbar-thumb-hover: #3a3a3a;
      --scrollbar-thumb-active: #4b4b4b;
    }
    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: var(--scrollbar-thumb) var(--scrollbar-bg);
    }
    /* WebKit */
    *::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    *::-webkit-scrollbar-track {
      background: var(--scrollbar-bg);
    }
    *::-webkit-scrollbar-thumb {
      background: var(--scrollbar-thumb);
      border-radius: 999px;
      border: 2px solid var(--scrollbar-bg);
      transition: background .2s ease, border-color .2s ease;
    }
    *::-webkit-scrollbar-thumb:hover {
      background: var(--scrollbar-thumb-hover);
    }
    *::-webkit-scrollbar-thumb:active {
      background: var(--scrollbar-thumb-active);
    }
    /* Evita che su elementi rotondi la scrollbar rompa il design */
    .glass-card::-webkit-scrollbar {
      width: 8px;
    }
    .glass-card {
      scrollbar-width: thin;
    }
    /* Nascondi scrollbar orizzontali indesiderate */
    body, .main-content-area {
      overflow-x: hidden;
    }
    
   

</style>
{% block extra_css %}{% endblock %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
      const mainContent = document.querySelector('.main-content-area');
      const stickyNav = mainContent.querySelector('.sticky');
      const nextElement = stickyNav.nextElementSibling;
      
      if (nextElement) {
        nextElement.style.marginTop = '0';
        nextElement.style.paddingTop = '0';
      }
    });
    </script>
</head>
<body x-data="{ darkMode: localStorage.getItem('darkMode') === 'true', sidebarOpen: false }" 
      x-init="
        console.log('Inizializzazione - darkMode dal localStorage:', localStorage.getItem('darkMode'), 'parsed:', darkMode);
        $watch('darkMode', value => { 
          console.log('Watch triggered - nuovo valore darkMode:', value);
          localStorage.setItem('darkMode', value.toString()); 
          if (value) {
            document.body.classList.add('dark');
            document.documentElement.classList.add('dark');
            document.body.style.backgroundColor = '#000000';
            document.documentElement.style.backgroundColor = '#000000';
          } else {
            document.body.classList.remove('dark');
            document.documentElement.classList.remove('dark'); 
            document.body.style.backgroundColor = '';
            document.documentElement.style.backgroundColor = '';
          }
        }); 
        // Lo stato iniziale è già applicato dallo script inline nel head
        if (darkMode) {
          console.log('Conferma stato iniziale: dark mode già applicato');
          document.body.classList.add('dark');
          document.body.style.backgroundColor = '#000000';
        }
      "
      :class="{ 'dark': darkMode }"
      class="bg-gray-50 dark:bg-black min-h-screen overflow-x-hidden"
      :style="darkMode ? 'background-color: #000000 !important;' : ''">
  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 mx-4 rounded text-sm flex items-center gap-3
          {% if category == 'success' %}bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200
          {% elif category == 'error' or category == 'danger' %}bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200
          {% else %}bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200{% endif %}">
          <span>{{ message }}</span>
          {% if category == 'success' and request.endpoint == 'movimento' %}
            <a href="{{ url_for('index') }}" class="text-xs font-semibold px-2 py-1 rounded bg-white/70 dark:bg-black/40 border border-current hover:underline">
              Vai al Magazzino
            </a>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Sidebar Navigation -->
  <div class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-black shadow-lg z-20 hidden md:block">
    <div class="sidebar-header flex items-center justify-center h-16 px-4">
      <img src="https://raw.githubusercontent.com/emilianpr/phg-img/refs/heads/main/HEAD_Pharmagest.png" 
           alt="Pharmagest Logo" 
           class="h-10 mx-auto">
    </div>
    <nav class="mt-8 px-4 space-y-1">
      <a href="{{ url_for('index') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'index' %}active{% endif %}">
        <i class="fas fa-boxes mr-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Gestione Magazzino
      </a>
      <a href="{{ url_for('movimento') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'movimento' %}active{% endif %}">
        <i class="fas fa-exchange-alt mr-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Movimento
      </a>
      <a href="{{ url_for('logmovimenti') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'logmovimenti' %}active{% endif %}">
        <i class="fas fa-file-invoice mr-3 {% if request.endpoint == 'logmovimenti' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Log Movimenti
      </a>
      <a href="{{ url_for('logscarico') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'logscarico' %}active{% endif %}">
        <i class="fas fa-file-arrow-down mr-3 {% if request.endpoint == 'logscarico' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Log Scarichi
      </a>
      <div x-data="{ open: false }" class="relative">
        <a href="#" @click.prevent="open = !open"
           class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}active{% endif %}">
          <i class="fas fa-arrow-down mr-3 {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
          Scarico Merci
          <i class="fas fa-chevron-down ml-auto text-xs"></i>
        </a>
        <div x-show="open" @click.away="open = false"
             class="absolute left-0 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md shadow-lg z-30"
             x-transition>
          <a href="{{ url_for('scaricomerce') }}"
             class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-phg-secondary dark:hover:bg-gray-700 {% if request.endpoint == 'scaricomerce' %}font-bold text-phg-primary{% endif %}">
            Scarico da Magazzino
          </a>
          <a href="{{ url_for('scarico_merce_non_in_magazzino') }}"
             class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-phg-secondary dark:hover:bg-gray-700 {% if request.endpoint == 'scarico_merce_non_in_magazzino' %}font-bold text-phg-primary{% endif %}">
            Scarico NON in Magazzino
          </a>
        </div>
      </div>
      <a href="{{ url_for('carico_merci') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'carico_merci' %}active{% endif %}">
        <i class="fas fa-arrow-up mr-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Carico Merci
      </a>
      <a href="{{ url_for('warehouse_reconciliation') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'warehouse_reconciliation' %}active{% endif %}">
        <i class="fas fa-balance-scale mr-3 {% if request.endpoint == 'warehouse_reconciliation' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Confronto AS400
      </a>
      <a href="{{ url_for('rientro_merce') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'rientro_merce' %}active{% endif %}">
        <i class="fas fa-undo mr-3 {% if request.endpoint == 'rientro_merce' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Rientro Merce
      </a> 
      
      {% if session.get('is_admin') %}

      <a href="{{ url_for('register') }}" class="flex items-center px-4 py-3 text-sm font-medium text-gray-700 dark:text-gray-300 rounded-md nav-pill {% if request.endpoint == 'register' %}active{% endif %}">
        <i class="fas fa-user-plus mr-3 {% if request.endpoint == 'register' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}"></i>
        Nuovo Utente
      </a>
      {% endif %}
    </nav>
    <div class="absolute bottom-0 left-0 right-0 p-4">
      <div class="mb-4 pb-4 border-b border-gray-200 dark:border-gray-600">
        <a href="https://github.com/emilianpr/magazzino_webapp/issues" target="_blank" rel="noopener" class="bug-btn group flex items-center w-full px-4 py-2 text-sm font-medium rounded-md">
          <i class="fas fa-bug text-red-500 mr-2"></i>
          <span class="flex-grow text-left">Segnala Bug</span>
          <i class="fas fa-up-right-from-square text-xs text-gray-400 group-hover:text-red-500 transition-colors"></i>
        </a>
      </div>
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-white dark:bg-gray-700 rounded-full border border-gray-200 dark:border-gray-600">
          <img class="h-10 w-10 rounded-full" src="https://raw.githubusercontent.com/emilianpr/phg-img/main/user-128.svg" alt="User profile" />
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-gray-900 dark:text-gray-100">{{ username }}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            {% if session.get('is_admin') %}
              Amministratore
            {% else %}
              Utente
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay md:hidden" 
       :class="{ 'active': sidebarOpen }" 
       @click="sidebarOpen = false"></div>

  <!-- Mobile Sidebar -->
  <div class="fixed inset-y-0 left-0 w-64 bg-white dark:bg-black shadow-lg z-20 md:hidden mobile-sidebar"
       :class="{ 'open': sidebarOpen }">
    <div class="sidebar-header flex items-center justify-center h-16 px-4">
      <img src="https://raw.githubusercontent.com/emilianpr/phg-img/refs/heads/main/HEAD_Pharmagest.png" 
           alt="Pharmagest Logo" 
           class="h-10 mx-auto">
    </div>
    <nav class="mt-8 px-4 space-y-1">
      <a href="{{ url_for('index') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'index' %}active{% endif %}">
        <i class="fas fa-boxes mr-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Gestione Magazzino
      </a>
      <a href="{{ url_for('movimento') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'movimento' %}active{% endif %}">
        <i class="fas fa-exchange-alt mr-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Movimento
      </a>
      <a href="{{ url_for('logmovimenti') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logmovimenti' %}active{% endif %}">
        <i class="fas fa-file-invoice mr-3 {% if request.endpoint == 'logmovimenti' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Movimenti
      </a>
      <a href="{{ url_for('logscarico') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logscarico' %}active{% endif %}">
        <i class="fas fa-file-arrow-down mr-3 {% if request.endpoint == 'logscarico' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Scarichi
      </a>
      <div x-data="{ open: false }" class="relative">
        <a href="#" @click.prevent="open = !open"
           class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}active{% endif %}">
          <i class="fas fa-arrow-down mr-3 {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
          Scarico Merci
          <i class="fas fa-chevron-down ml-auto text-xs"></i>
        </a>
        <div x-show="open" @click.away="open = false"
             class="absolute left-0 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg z-30"
             x-transition>
          <a href="{{ url_for('scaricomerce') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scaricomerce' %}font-bold text-phg-primary{% endif %}">
            Scarico da Magazzino
          </a>
          <a href="{{ url_for('scarico_merce_non_in_magazzino') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scarico_merce_non_in_magazzino' %}font-bold text-phg-primary{% endif %}">
            Scarico NON in Magazzino
          </a>
        </div>
      </div>
      <a href="{{ url_for('carico_merci') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'carico_merci' %}active{% endif %}">
        <i class="fas fa-arrow-up mr-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Carico Merci
      </a>
      <a href="{{ url_for('warehouse_reconciliation') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'warehouse_reconciliation' %}active{% endif %}">
        <i class="fas fa-balance-scale mr-3 {% if request.endpoint == 'warehouse_reconciliation' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Riconciliazione Magazzino
      </a>
      <a href="{{ url_for('nuovo_prodotto') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'nuovo_prodotto' %}active{% endif %}">
        <i class="fas fa-plus mr-3 {% if request.endpoint == 'nuovo_prodotto' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Nuovo Prodotto
      </a>
      <a href="{{ url_for('rientro_merce') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'rientro_merce' %}active{% endif %}">
        <i class="fas fa-undo mr-3 {% if request.endpoint == 'rientro_merce' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Rientro Merce
      </a>

      {% if session.get('is_admin') %}

      <a href="{{ url_for('register') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'register' %}active{% endif %}">
        <i class="fas fa-user-plus mr-3 {% if request.endpoint == 'register' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Nuovo Utente
      </a>
      {% endif %}
    </nav>
  </div>

  <!-- Main Content -->

  <div class="md:ml-64 main-content-area">
    <!-- Top Navigation (sticky, dentro main-content-area) -->
    <div class="sticky top-0 z-10 bg-white dark:bg-black shadow-sm">
      <div class="flex items-center justify-between h-16 px-4">
        <div class="flex items-center">
          <!-- Mobile hamburger menu -->
          <button class="md:hidden mr-3 hamburger-menu" 
                  :class="{ 'active': sidebarOpen }"
                  @click="sidebarOpen = !sidebarOpen">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </button>
          <h1 class="text-lg md:text-xl font-bold text-phg-primary">
            <span class="hidden md:inline">{% block page_title_full %}Gestione Magazzino - Pharmagest ({{ app_version }}){% endblock %}</span>
            <span class="md:hidden">{% block page_title_short %}Magazzino{% endblock %}</span>
          </h1>
        </div>
        <div class="flex items-center gap-2">
          <!-- Dark Mode Toggle -->
          <button id="dark-mode-toggle" 
                  @click="console.log('Toggle clicked, current darkMode:', darkMode); darkMode = !darkMode; console.log('New darkMode:', darkMode);"
                  class="p-2 text-gray-500 hover:text-phg-primary hover:bg-phg-secondary dark:text-gray-400 dark:hover:text-yellow-400 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200" 
                  title="Toggle Dark Mode">
            <i class="fas fa-sun text-lg" x-show="darkMode"></i>
            <i class="fas fa-moon text-lg" x-show="!darkMode"></i>
          </button>
          <!-- Icona Changelog -->
          <a href="{{ url_for('changelogs') }}" 
             class="p-2 text-gray-500 hover:text-phg-primary hover:bg-phg-secondary dark:text-gray-400 dark:hover:text-phg-primary dark:hover:bg-gray-700 rounded-lg transition-colors duration-200" 
             title="Changelog">
            <i class="fas fa-code-branch text-lg"></i>
          </a>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    {% block content %}{% endblock %}
  </div>

  <!-- Mobile Menu (hidden by default) -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-black shadow-lg z-10">
    <div class="flex justify-around">
      <a href="{{ url_for('index') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-boxes text-lg"></i>
        <span class="text-xs mt-1">Magazzino</span>
      </a>
      <a href="{{ url_for('movimento') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-exchange-alt text-lg"></i>
        <span class="text-xs mt-1">Movimento</span>
      </a>
      <a href="{{ url_for('carico_merci') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-arrow-up text-lg"></i>
        <span class="text-xs mt-1">Carico</span>
      </a>
      {% if session.get('is_admin') %}
      <a href="{{ url_for('rientro_merce') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'rientro_merce' %}text-phg-primary{% else %}text-gray-500 dark:text-gray-400{% endif %}">
        <i class="fas fa-undo text-lg"></i>
        <span class="text-xs mt-1">Rientro</span>
      </a>
      {% endif %}
    </div>
  </div>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  
  <script>
    // Fallback e debugging per il dark mode toggle
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, localStorage darkMode:', localStorage.getItem('darkMode'));
      console.log('Body classes:', document.body.classList.toString());
      console.log('DocumentElement classes:', document.documentElement.classList.toString());
      
      const toggleButton = document.getElementById('dark-mode-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          console.log('Fallback click listener triggered');
          // Verifica lo stato del localStorage dopo il click
          setTimeout(() => {
            const currentMode = localStorage.getItem('darkMode');
            const hasBodyDark = document.body.classList.contains('dark');
            const hasHtmlDark = document.documentElement.classList.contains('dark');
            console.log('Dopo click - localStorage:', currentMode, 'body.dark:', hasBodyDark, 'html.dark:', hasHtmlDark);
            
            // Se c'è inconsistenza, correggi
            if (currentMode === 'true' && (!hasBodyDark || !hasHtmlDark)) {
              console.log('Correzione: attivando dark mode');
              document.body.classList.add('dark');
              document.documentElement.classList.add('dark');
              document.body.style.backgroundColor = '#000000';
              document.documentElement.style.backgroundColor = '#000000';
            } else if (currentMode === 'false' && (hasBodyDark || hasHtmlDark)) {
              console.log('Correzione: disattivando dark mode');
              document.body.classList.remove('dark');
              document.documentElement.classList.remove('dark');
              document.body.style.backgroundColor = '';
              document.documentElement.style.backgroundColor = '';
            }
          }, 50);
        });
      }
    });
  </script>
  
  {% block extra_js %}{% endblock %}
</body>
</html>
