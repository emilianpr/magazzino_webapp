{% extends "base.html" %}

{% block title %}Gestione Magazzino - Pharmagest{% endblock %}

{% block extra_css %}
    .dashboard-card-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 4.5rem;
      height: 4.5rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #e3f2fd 0%, #00a8e8 100%);
      color: #0056a6;
      font-size: 2.5rem;
      margin-bottom: 1.2rem;
      box-shadow: 0 2px 8px rgba(0,86,166,0.08);
    }
    
    .dark .dashboard-card-icon {
      background: linear-gradient(135deg, rgba(227, 242, 253, 0.2) 0%, rgba(0, 168, 232, 0.4) 100%);
      color: #60a5fa;
    }
    
    .floating-btn {
      box-shadow: 0 10px 15px -3px rgba(0, 86, 166, 0.3), 0 4px 6px -2px rgba(0, 86, 166, 0.1);
      transition: all 0.3s ease;
    }
    .floating-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 25px -5px rgba(0, 86, 166, 0.3), 0 10px 10px -5px rgba(0, 86, 166, 0.1);
    }
    .table-row-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 86, 166, 0.1), 0 2px 4px -1px rgba(0, 86, 166, 0.06);
      background: #e3f2fd;
      border-radius: 1rem;
    }
    
    .dark .table-row-hover:hover {
      background: rgba(55, 65, 81, 0.5);
    }
    .filter-toggle {
      transition: all 0.3s ease;
    }
    .filter-toggle.active {
      background-color: #0056a6;
      color: white;
    }
    .badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
    }
    .status-active {
      background-color: #e3f2fd;
      color: #0056a6;
    }
    .status-inactive {
      background-color: #fef3c7;
      color: #92400e;
    }
    .status-warning {
      background-color: #fee2e2;
      color: #b91c1c;
    }
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
    @media (max-width: 600px) {
      .glass-card {
        padding: 1.2rem 0.5rem;
      }
      form button[type="submit"] {
        width: 100%;
        justify-content: center;
      }
    }
    .edit-form {
      display: none;
    }
    .edit-form.active {
      display: table-row;
    }
    .edit-input {
      width: 100%;
      padding: 0.375rem 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.375rem;
      font-size: 0.875rem;
    }
    .edit-input:focus {
      outline: none;
      border-color: #0056a6;
      box-shadow: 0 0 0 2px rgba(0, 86, 166, 0.2);
    }
    .edit-buttons {
      display: flex;
      gap: 0.5rem;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      max-width: 90%;
      max-height: 80%;
      overflow-y: auto;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .ubicazione-option {
      padding: 1rem;
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 0.75rem;
    }
    .ubicazione-option:hover {
      border-color: #0056a6;
      background-color: #e3f2fd;
    }
    .ubicazione-option.selected {
      border-color: #0056a6;
      background-color: #e3f2fd;
    }
    
    /* Mobile improvements - AGGIUNGO TUTTI GLI STILI MANCANTI */
    .mobile-sidebar {
      transform: translateX(-100%);
      transition: transform 0.3s ease-in-out;
    }
    
    .mobile-sidebar.open {
      transform: translateX(0);
    }
    
    .mobile-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 19;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .mobile-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .mobile-table-card {
      background: white;
      border-radius: 12px;
      margin-bottom: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #0056a6;
    }
    
    .mobile-table-card:hover {
      box-shadow: 0 4px 12px rgba(0, 86, 166, 0.15);
      transform: translateY(-1px);
    }
    
    .mobile-table-header {
      font-size: 14px;
      font-weight: 600;
      color: #0056a6;
      margin-bottom: 8px;
    }
    
    .mobile-table-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 14px;
    }
    
    .mobile-table-item {
      display: flex;
      flex-direction: column;
    }
    
    .mobile-table-label {
      font-size: 11px;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 500;
      margin-bottom: 2px;
    }
    
    .mobile-table-value {
      color: #374151;
      font-weight: 500;
    }
    
    .mobile-actions {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .mobile-fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #0056a6, #00a8e8);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
      box-shadow: 0 4px 12px rgba(0, 86, 166, 0.3);
      z-index: 15;
      transition: all 0.3s ease;
    }
    
    .mobile-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 86, 166, 0.4);
    }
    
    .mobile-filters {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .mobile-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .mobile-stat-card {
      background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      border: 1px solid rgba(0, 86, 166, 0.1);
    }
    
    .mobile-stat-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0056a6, #00a8e8);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 8px;
      font-size: 16px;
    }
    
    .mobile-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #0056a6;
      margin-bottom: 4px;
    }
    
    .mobile-stat-label {
      font-size: 12px;
      color: #6b7280;
      font-weight: 500;
    }
    
    .hamburger-menu {
      display: flex;
      flex-direction: column;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .hamburger-line {
      width: 100%;
      height: 2px;
      background-color: #0056a6;
      margin: 2px 0;
      transition: 0.3s;
    }
    
    .hamburger-menu.active .hamburger-line:nth-child(1) {
      transform: rotate(-45deg) translate(-4px, 4px);
    }
    
    .hamburger-menu.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }
    
    .hamburger-menu.active .hamburger-line:nth-child(3) {
      transform: rotate(45deg) translate(-4px, -4px);
    }
    
    /* Desktop layout */
    @media (min-width: 769px) {
      .main-content-area {
        margin-left: 16rem !important; /* 256px per sidebar w-64 */
        width: calc(100vw - 16rem) !important;
      }
    }
    
    @media (max-width: 768px) {
      .main-content-area {
        margin-left: 0;
        width: 100vw;
        max-width: 100vw;
      }
      
      .desktop-table {
        display: none;
      }
      
      .mobile-view {
        display: block;
      }
      
      .glass-card {
        margin: 12px;
        padding: 16px;
        border-radius: 12px;
      }
      
      .dashboard-card-icon {
        width: 32px;
        height: 32px;
        font-size: 16px;
        margin-bottom: 8px;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-view {
        display: none;
      }
      
      .desktop-table {
        display: block;
      }
    }

    /* Dark mode styles */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --border-color: #e5e7eb;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    .dark {
      --bg-primary: #0a0a0a; /* Quasi nero per le card */
      --bg-secondary: #000000; /* Nero puro AMOLED per lo sfondo */
      --bg-tertiary: #1a1a1a; /* Grigio molto scuro per elementi hover */
      --text-primary: #ffffff;
      --text-secondary: #a0a0a0;
      --border-color: #2a2a2a;
      --shadow: rgba(0, 0, 0, 0.8);
    }

    .dark body {
      background-color: #000000 !important; /* Nero puro AMOLED */
      color: var(--text-primary) !important;
    }

    .dark .glass-card {
      background: rgba(10, 10, 10, 0.95) !important; /* Quasi nero per le card */
      border: 1px solid #1a1a1a !important;
      backdrop-filter: blur(10px);
    }

    .dark .mobile-table-card {
      background: #0a0a0a !important; /* Quasi nero */
      border: 1px solid #1a1a1a !important;
    }

    .dark .mobile-table-header {
      color: var(--text-primary) !important;
    }

    .dark .mobile-table-label {
      color: var(--text-secondary) !important;
    }

    .dark .mobile-table-value {
      color: var(--text-primary) !important;
    }

    .dark .bg-white {
      background-color: #0a0a0a !important; /* Quasi nero per uniformità AMOLED */
    }


    .dark .bg-gray-50 {
      background-color: #000000 !important; /* Nero puro */
    }

    .dark .bg-gray-100 {
      background-color: #0a0a0a !important; /* Quasi nero */
    }

    .dark .text-gray-900 {
      color: var(--text-primary) !important;
    }

    .dark .text-gray-700 {
      color: var(--text-secondary) !important;
    }

    .dark .text-gray-500 {
      color: var(--text-secondary) !important;
    }

    .dark .text-gray-600 {
      color: var(--text-secondary) !important;
    }

    .dark .border-gray-200 {
      border-color: var(--border-color) !important;
    }

    .dark .border-gray-300 {
      border-color: var(--border-color) !important;
    }

    .dark .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
      border-color: var(--border-color) !important;
    }

    .dark .shadow-lg {
      box-shadow: 0 10px 15px -3px var(--shadow), 0 4px 6px -2px var(--shadow) !important;
    }

    .dark .shadow-sm {
      box-shadow: 0 1px 2px 0 var(--shadow) !important;
    }

    .dark table {
      background-color: #0a0a0a !important; /* Quasi nero per le tabelle */
    }

    .dark thead {
      background-color: #1a1a1a !important; /* Grigio molto scuro per header */
    }

    .dark .bg-phg-secondary {
      background-color: rgba(59, 130, 246, 0.1) !important;
    }

    .dark .bg-phg-light {
      background-color: #1a1a1a !important; /* Grigio molto scuro */
    }

    .dark .hover\\:bg-gray-50:hover {
      background-color: #1a1a1a !important; /* Grigio molto scuro per hover */
    }

    .dark .hover\\:bg-phg-secondary:hover {
      background-color: rgba(59, 130, 246, 0.15) !important;
    }

    .dark input, .dark select, .dark textarea {
      background-color: #0a0a0a !important; /* Quasi nero per input */
      border-color: #2a2a2a !important;
      color: var(--text-primary) !important;
    }

    .dark input:focus, .dark select:focus, .dark textarea:focus {
      background-color: #0a0a0a !important;
      border-color: #3b82f6 !important;
    }

    .dark .modal-overlay {
      background-color: rgba(0, 0, 0, 0.7) !important;
    }

    .dark .modal-content {
      background-color: #0a0a0a !important; /* Quasi nero per modal */
      border-color: #2a2a2a !important;
      color: var(--text-primary) !important;
    }

    .dark .ubicazione-option {
      background-color: #0a0a0a !important; /* Quasi nero */
      border-color: #2a2a2a !important;
      color: var(--text-primary) !important;
    }

    .dark .ubicazione-option:hover {
      background-color: #1a1a1a !important; /* Grigio molto scuro per hover */
    }

    .dark .ubicazione-option.selected {
      background-color: rgba(59, 130, 246, 0.2) !important;
      border-color: #3b82f6 !important;
    }

    .dark .edit-form {
      background-color: #000000 !important; /* Nero puro per form editing */
    }

    .dark .table-row-hover:hover {
      background-color: #1a1a1a !important; /* Grigio molto scuro per hover righe */
    }

    .dark .mobile-stats {
      background-color: #000000 !important; /* Nero puro */
    }

    .dark .mobile-stat-card {
      background: #0a0a0a !important; /* Quasi nero */
      border: 1px solid #2a2a2a !important;
    }

    .dark .mobile-filters {
      background-color: #0a0a0a !important; /* Quasi nero */
    }

    .dark .nav-pill {
      color: var(--text-secondary) !important;
    }

    .dark .nav-pill:hover {
      background-color: #1a1a1a !important; /* Grigio molto scuro per hover nav */
    }

    .dark .nav-pill.active {
      background-color: rgba(59, 130, 246, 0.15) !important; /* Blu molto sottile */
      color: #3b82f6 !important;
    }

    /* Miglioramenti per la leggibilità dei testi blu in dark mode */
    .dark .text-phg-primary {
      color: #ffffff !important; /* Bianco per tutti i testi blu primari */
    }

    .dark h1, .dark h2, .dark h3 {
      color: #ffffff !important; /* Bianco per i titoli */
    }

    .dark .phg-gradient {
      background: linear-gradient(135deg, #1f2937 0%, #374151 100%) !important;
    }

    .dark .dashboard-card-icon {
      background: linear-gradient(135deg, #374151 0%, #60a5fa 100%) !important;
      color: #ffffff !important;
    }

    .dark .mobile-stat-icon {
      background: linear-gradient(135deg, #60a5fa, #93c5fd) !important;
      color: #1f2937 !important;
    }

    .dark .mobile-stat-value {
      color: #ffffff !important;
    }

    .dark .mobile-table-header {
      color: #ffffff !important;
    }

    .dark .status-active {
      background-color: rgba(96, 165, 250, 0.2) !important;
      color: #ffffff !important;
    }

    .dark .badge {
      color: var(--text-primary) !important;
    }

    .dark .hamburger-line {
      background-color: #ffffff !important;
    }

    .dark .floating-btn {
      box-shadow: 0 10px 15px -3px rgba(96, 165, 250, 0.3), 0 4px 6px -2px rgba(96, 165, 250, 0.1) !important;
    }

    .dark .mobile-fab {
      background: linear-gradient(135deg, #60a5fa, #93c5fd) !important;
    }

    /* Fix per i link della sidebar in dark mode */
    .dark .nav-pill i {
      color: var(--text-secondary) !important;
    }

    .dark .nav-pill.active i {
      color: #ffffff !important;
    }

    .dark .nav-pill:hover i {
      color: #ffffff !important;
    }

    .dark .nav-pill.active {
      background-color: rgba(96, 165, 250, 0.2) !important;
      color: #ffffff !important;
    }

    /* Titoli e testi importanti in bianco */
    .dark .text-phg-dark {
      color: #ffffff !important;
    }

    .dark .font-bold.text-phg-primary {
      color: #ffffff !important;
    }

    /* Miglioramenti per i badge di stato in dark mode */
    .dark .status-active {
      background-color: #065f46 !important; /* Verde scuro */
      color: #d1fae5 !important; /* Verde chiaro */
      border: 1px solid #10b981 !important;
    }

    .dark .status-inactive {
      background-color: #92400e !important; /* Arancione scuro */
      color: #fef3c7 !important; /* Giallo chiaro */
      border: 1px solid #f59e0b !important;
    }

    .dark .status-warning {
      background-color: #7f1d1d !important; /* Rosso scuro */
      color: #fecaca !important; /* Rosso chiaro */
      border: 1px solid #ef4444 !important;
    }

    /* Header della tabella in dark mode */
    .dark thead th {
      color: #ffffff !important;
      background-color: var(--bg-tertiary) !important;
    }

    .dark .bg-phg-secondary th {
      background-color: var(--bg-tertiary) !important;
    }
    
    /* Forza il logo a essere trasparente in dark mode */
    .dark .sidebar-header img {
      background: transparent !important;
      mix-blend-mode: screen;
      filter: brightness(0) saturate(100%) invert(100%);
    }

    /* Assicura che non ci siano sfondi su tutto il contenitore del logo */
    .dark .sidebar-header {
      background: transparent !important;
    }
{% endblock %}

{% block content %}
<div x-data="{ 
  sidebarOpen: false,
  filtersOpen: false,
  editingRow: null,
  compensazioneData: null,
  ubicazioneSelezionata: null
}">" 

  <!-- Inizio Contenuto Principale -->
    {% if messages %}
      <div class="w-full max-w-2xl mx-auto mt-4">
        {% for category, message in messages %}
          <div class="px-4 py-2 rounded text-sm mb-2
            {% if category == 'success' %}bg-green-100 text-green-800
            {% elif category == 'error' or category == 'danger' %}bg-red-100 text-red-800
            {% else %}bg-gray-100 text-gray-800{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  
  <!-- Mobile Overlay -->
  <div class="mobile-overlay md:hidden" 
       :class="{ 'active': sidebarOpen }" 
       @click="sidebarOpen = false"></div>

  <!-- Sidebar Navigation -->
  <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-20 hidden md:block">
    <div class="flex items-center justify-center h-16 px-4 phg-gradient">
      <img src="https://raw.githubusercontent.com/emilianpr/phg-img/refs/heads/main/HEAD_Pharmagest.png" 
           alt="Pharmagest Logo" 
           class="h-10 mx-auto">
    </div>
    <nav class="mt-8 px-4 space-y-1">
      <a href="{{ url_for('index') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'index' %}active{% endif %}">
        <i class="fas fa-boxes mr-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Gestione Magazzino
      </a>
      <a href="{{ url_for('movimento') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'movimento' %}active{% endif %}">
        <i class="fas fa-exchange-alt mr-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Movimento
      </a>
      <a href="{{ url_for('logmovimenti') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logmovimenti' %}active{% endif %}">
        <i class="fas fa-file-invoice mr-3 {% if request.endpoint == 'logmovimenti' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Movimenti
      </a>
      <a href="{{ url_for('logscarico') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logscarico' %}active{% endif %}">
        <i class="fas fa-file-arrow-down mr-3 {% if request.endpoint == 'logscarico' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Scarichi
      </a>
      <div x-data="{ open: false }" class="relative">
        <a href="#" @click.prevent="open = !open"
           class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}active{% endif %}">
          <i class="fas fa-arrow-down mr-3 {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
          Scarico Merci
          <i class="fas fa-chevron-down ml-auto text-xs"></i>
        </a>
        <div x-show="open" @click.away="open = false"
             class="absolute left-0 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg z-30"
             x-transition>
          <a href="{{ url_for('scaricomerce') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scaricomerce' %}font-bold text-phg-primary{% endif %}">
            Scarico da Magazzino
          </a>
          <a href="{{ url_for('scarico_merce_non_in_magazzino') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scarico_merce_non_in_magazzino' %}font-bold text-phg-primary{% endif %}">
            Scarico NON in Magazzino
          </a>
        </div>
      </div>
      <a href="{{ url_for('carico_merci') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'carico_merci' %}active{% endif %}">
        <i class="fas fa-arrow-up mr-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Carico Merci
      </a>
      {% if session.get('is_admin') %}
      <a href="{{ url_for('register') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'register' %}active{% endif %}">
        <i class="fas fa-user-plus mr-3 {% if request.endpoint == 'register' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Nuovo Utente
      </a>
      {% endif %}
    </nav>
    <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200">
      <div class="flex items-center">
        <div class="flex-shrink-0 bg-white rounded-full border border-gray-200">
          <img class="h-10 w-10 rounded-full" src="https://raw.githubusercontent.com/emilianpr/phg-img/main/user-128.svg" alt="User profile" />
        </div>
        <div class="ml-3">
          <p class="text-sm font-medium text-gray-900">{{ username }}</p>
          <p class="text-sm text-gray-500">
            {% if session.get('is_admin') %}
              Amministratore
            {% else %}
              Utente
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Sidebar -->
  <div class="fixed inset-y-0 left-0 w-64 bg-white shadow-lg z-20 md:hidden mobile-sidebar"
       :class="{ 'open': sidebarOpen }">
    <div class="flex items-center justify-center h-16 px-4 phg-gradient">
      <img src="https://raw.githubusercontent.com/emilianpr/phg-img/refs/heads/main/HEAD_Pharmagest.png" 
           alt="Pharmagest Logo" 
           class="h-10 mx-auto">
    </div>
    <nav class="mt-8 px-4 space-y-1">
      <a href="{{ url_for('index') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'index' %}active{% endif %}">
        <i class="fas fa-boxes mr-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Gestione Magazzino
      </a>
      <a href="{{ url_for('movimento') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'movimento' %}active{% endif %}">
        <i class="fas fa-exchange-alt mr-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Movimento
      </a>
      <a href="{{ url_for('logmovimenti') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logmovimenti' %}active{% endif %}">
        <i class="fas fa-file-invoice mr-3 {% if request.endpoint == 'logmovimenti' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Movimenti
      </a>
      <a href="{{ url_for('logscarico') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'logscarico' %}active{% endif %}">
        <i class="fas fa-file-arrow-down mr-3 {% if request.endpoint == 'logscarico' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Log Scarichi
      </a>
      <div x-data="{ open: false }" class="relative">
        <a href="#" @click.prevent="open = !open"
           class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}active{% endif %}">
          <i class="fas fa-arrow-down mr-3 {% if request.endpoint in ['scaricomerce', 'scarico_merce_non_in_magazzino'] %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
          Scarico Merci
          <i class="fas fa-chevron-down ml-auto text-xs"></i>
        </a>
        <div x-show="open" @click.away="open = false"
             class="absolute left-0 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg z-30"
             x-transition>
          <a href="{{ url_for('scaricomerce') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scaricomerce' %}font-bold text-phg-primary{% endif %}">
            Scarico da Magazzino
          </a>
          <a href="{{ url_for('scarico_merce_non_in_magazzino') }}"
             class="block px-4 py-2 text-sm text-gray-700 hover:bg-phg-secondary {% if request.endpoint == 'scarico_merce_non_in_magazzino' %}font-bold text-phg-primary{% endif %}">
            Scarico NON in Magazzino
          </a>
        </div>
      </div>
      <a href="{{ url_for('carico_merci') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'carico_merci' %}active{% endif %}">
        <i class="fas fa-arrow-up mr-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Carico Merci
      </a>
      {% if session.get('is_admin') %}
      <a href="{{ url_for('register') }}" class="flex items-center px-4 py-3 text-sm font-medium rounded-md nav-pill {% if request.endpoint == 'register' %}active{% endif %}">
        <i class="fas fa-user-plus mr-3 {% if request.endpoint == 'register' %}text-phg-primary{% else %}text-gray-500{% endif %}"></i>
        Nuovo Utente
      </a>
      {% endif %}
    </nav>
  </div>

  <!-- Main Content -->
  <div class="main-content-area">
    <!-- Top Navigation -->
    <div class="sticky top-0 z-10 bg-white shadow-sm">
      <div class="flex items-center justify-between h-16 px-4">
        <div class="flex items-center">
          <!-- Mobile hamburger menu -->
          <button class="md:hidden mr-3 hamburger-menu" 
                  :class="{ 'active': sidebarOpen }"
                  @click="sidebarOpen = !sidebarOpen">
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
            <div class="hamburger-line"></div>
          </button>
          <h1 class="text-lg md:text-xl font-bold text-phg-primary">
            <span class="hidden md:inline">Gestione Magazzino - Pharmagest (Alpha v3.0)</span>
            <span class="md:hidden">Magazzino</span>
          </h1>
        </div>
        <div class="flex items-center gap-2">
          <!-- Dark Mode Toggle -->
          <button id="dark-mode-toggle" 
                  @click="console.log('Toggle clicked, current darkMode:', darkMode); darkMode = !darkMode; console.log('New darkMode:', darkMode);"
                  class="p-2 text-gray-500 hover:text-phg-primary hover:bg-phg-secondary dark:text-gray-400 dark:hover:text-yellow-400 dark:hover:bg-gray-700 rounded-lg transition-colors duration-200" 
                  title="Toggle Dark Mode">
            <i class="fas fa-sun text-lg" x-show="darkMode"></i>
            <i class="fas fa-moon text-lg" x-show="!darkMode"></i>
          </button>
          <!-- Icona Changelog -->
          <a href="{{ url_for('changelogs') }}" 
             class="p-2 text-gray-500 hover:text-phg-primary hover:bg-phg-secondary dark:text-gray-400 dark:hover:text-phg-primary dark:hover:bg-gray-700 rounded-lg transition-colors duration-200" 
             title="Changelog">
            <i class="fas fa-code-branch text-lg"></i>
          </a>
          <!-- Pulsanti esportazione SOLO per mobile -->
          <div class="flex gap-2 md:hidden">
            <a href="{{ url_for('esporta_magazzino') }}" class="px-3 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
              <i class="fas fa-download mr-2"></i>
              <span class="hidden md:inline">Esporta TXT</span>
              <span class="md:hidden">TXT</span>
            </a>
            <a href="{{ url_for('esporta_magazzino_xlsx') }}" class="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700">
              <i class="fas fa-file-excel mr-2"></i>
              <span class="hidden md:inline">Esporta XLSX</span>
              <span class="md:hidden">XLSX</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="px-2 md:px-4 py-4 md:py-6 max-w-7xl mx-auto">
      <!-- Mobile Stats Cards -->
      <div class="mobile-stats md:hidden">
        <div class="mobile-stat-card">
          <div class="mobile-stat-icon">
            <i class="fas fa-box-open"></i>
          </div>
          <div class="mobile-stat-value">{{ total_products }}</div>
          <div class="mobile-stat-label">Prodotti</div>
        </div>
        <div class="mobile-stat-card">
          <div class="mobile-stat-icon">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <div class="mobile-stat-value">{{ movements_today }}</div>
          <div class="mobile-stat-label">Mov. Oggi</div>
        </div>
      </div>

      <!-- Desktop Stats Cards -->
      <div class="hidden md:flex flex-col md:flex-row gap-6 mb-8 w-full">
        <div class="glass-card flex-1 rounded-xl p-10 flex flex-col items-center justify-center w-full">
          <div class="dashboard-card-icon">
            <i class="fas fa-box-open"></i>
          </div>
          <p class="text-base font-medium text-gray-500 text-center">Prodotti Totali</p>
          <p class="mt-2 text-4xl font-bold text-phg-dark text-center">{{ total_products }}</p>
        </div>
        <div class="glass-card flex-1 rounded-xl p-10 flex flex-col items-center justify-center w-full">
          <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #e3f2fd 0%, #a7f3d0 100%); color: #059669;">
            <i class="fas fa-exchange-alt"></i>
          </div>
          <p class="text-base font-medium text-gray-500 text-center">Movimenti Oggi</p>
          <p class="mt-2 text-4xl font-bold text-phg-dark text-center">{{ movements_today }}</p>
        </div>
      </div>

      <!-- Mobile Filters -->
      <div class="md:hidden">
        <div class="mobile-filters">
          <button @click="filtersOpen = !filtersOpen" 
                  class="w-full flex items-center justify-between p-3 bg-phg-primary text-white rounded-lg">
            <span class="flex items-center">
              <i class="fas fa-filter mr-2"></i>Filtri
            </span>
            <i class="fas fa-chevron-down transition-transform" 
               :class="{ 'rotate-180': filtersOpen }"></i>
          </button>
          
          <div x-show="filtersOpen" x-transition class="mt-4 space-y-3">
            <form method="GET" action="{{ url_for('index') }}">
              <div class="space-y-3">
                <input type="text" name="filtro_codice" value="{{ filtro_codice|default('') }}"
                       placeholder="Codice prodotto..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                
                <input type="text" name="filtro_nome" value="{{ filtro_nome|default('') }}"
                       placeholder="Nome prodotto..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                
                <select name="filtro_stato" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                  <option value="">-- Tutti gli stati --</option>
                  {% for st in stati_opzioni %}
                    <option value="{{ st }}" {% if filtro_stato == st %}selected{% endif %}>
                      {{ st|format_db_string }}
                    </option>
                  {% endfor %}
                </select>
                
                <div class="flex space-x-2">
                  <button type="button" onclick="window.location='{{ url_for('index') }}'"
                          class="flex-1 py-2 border border-gray-300 rounded-lg text-sm text-gray-700 bg-white">
                    Reset
                  </button>
                  <button type="submit" 
                          class="flex-1 py-2 bg-phg-primary text-white rounded-lg text-sm">
                    Applica
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Mobile Quick Actions -->
      <div class="md:hidden mb-4">
        <div class="flex space-x-2 overflow-x-auto pb-2 justify-center">
          <a href="{{ url_for('movimento') }}" 
             class="flex-shrink-0 bg-phg-primary text-white px-4 py-2 rounded-lg text-sm flex items-center">
            <i class="fas fa-plus-circle mr-2"></i>Movimento
          </a>
          <a href="{{ url_for('nuovo_prodotto') }}" 
             class="flex-shrink-0 bg-green-600 text-white px-4 py-2 rounded-lg text-sm flex items-center">
            <i class="fas fa-plus mr-2"></i>Prodotto
          </a>
          <a href="{{ url_for('carico_merci') }}" 
             class="flex-shrink-0 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm flex items-center">
            <i class="fas fa-arrow-up mr-2"></i>Carico
          </a>
        </div>
      </div>

      <!-- Desktop Filters and Actions -->
      <div class="hidden md:block mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center space-x-2">
            <button id="toggle-filters" class="filter-toggle active px-4 py-2 rounded-lg bg-phg-primary text-white text-sm font-medium flex items-center">
              <i class="fas fa-filter mr-2"></i> Filtri
            </button>
          </div>
          <div class="flex space-x-3">
            <form method="get" action="{{ url_for('esporta_magazzino') }}">
              <button type="submit" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 flex items-center">
                <i class="fas fa-file-export mr-2"></i> Esporta TXT
              </button>
            </form>
            <form method="get" action="{{ url_for('esporta_magazzino_xlsx') }}">
              <button type="submit" class="px-4 py-2 border border-green-300 rounded-lg text-sm font-medium text-green-700 bg-white hover:bg-green-50 flex items-center">
                <i class="fas fa-file-excel mr-2"></i> Esporta Excel
              </button>
            </form>
            <a href="{{ url_for('movimento') }}" class="floating-btn px-4 py-2 bg-phg-primary hover:bg-phg-dark text-white rounded-lg text-sm font-medium flex items-center">
              <i class="fas fa-plus-circle mr-2"></i> Nuovo Movimento
            </a>
            <a href="{{ url_for('nuovo_prodotto') }}" class="floating-btn px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium flex items-center">
              <i class="fas fa-plus mr-2"></i> Nuovo Prodotto
            </a>
          </div>
        </div>

        <!-- Filters Panel -->
        <div id="filters-container" class="mt-4 glass-card rounded-xl p-6">
          <form method="GET" action="{{ url_for('index') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Codice Prodotto -->
              <div>
                <label for="filtro_codice" class="block text-sm font-medium text-gray-700 mb-1">Codice Prodotto</label>
                <input type="text" id="filtro_codice" name="filtro_codice" value="{{ filtro_codice|default('') }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-phg-primary focus:border-phg-primary transition duration-300">
              </div>
              
              <!-- Nome Prodotto -->
              <div>
                <label for="filtro_nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto</label>
                <input type="text" id="filtro_nome" name="filtro_nome" value="{{ filtro_nome|default('') }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-phg-primary focus:border-phg-primary transition duration-300">
              </div>
              
              <!-- Magazzino -->
              <div>
                <label for="filtro_magazzino" class="block text-sm font-medium text-gray-700 mb-1">Magazzino</label>
                <select id="filtro_magazzino" name="filtro_magazzino"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-phg-primary focus:border-phg-primary transition duration-300">
                  <option value="">-- Tutti --</option>
                  {% for mag in magazzini_opzioni %}
                    <option value="{{ mag }}" {% if filtro_magazzino == mag %}selected{% endif %}>{{ mag|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Stato -->
              <div>
                <label for="filtro_stato" class="block text-sm font-medium text-gray-700 mb-1">Stato</label>
                <select id="filtro_stato" name="filtro_stato"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-phg-primary focus:border-phg-primary transition duration-300">
                  <option value="">-- Tutti --</option>
                  {% for st in stati_opzioni %}
                    <option value="{{ st }}" {% if filtro_stato == st %}selected{% endif %}>{{ st|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Ubicazione -->
              <div>
                <label for="filtro_ubicazione" class="block text-sm font-medium text-gray-700 mb-1">Ubicazione</label>
                <select id="filtro_ubicazione" name="filtro_ubicazione"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-phg-primary focus:border-phg-primary transition duration-300">
                  <option value="">-- Tutte --</option>
                  {% for ub in ubicazioni_opzioni %}
                    <option value="{{ ub }}" {% if filtro_ubicazione == ub %}selected{% endif %}>{{ ub|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Note -->
              <div>
                <label for="filtro_note" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                <input type="text" id="filtro_note" name="filtro_note" value="{{ filtro_note|default('') }}"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-phg-primary focus:border-phg-primary transition duration-300" />
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
              <button type="button" onclick="window.location='{{ url_for('index') }}'"
                      class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-phg-primary transition duration-300">
                <i class="fas fa-undo mr-2"></i>Reset
              </button>
              <button type="submit"
                      class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-phg-primary hover:bg-phg-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-phg-primary transition duration-300">
                <i class="fas fa-check mr-2"></i>Applica
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="desktop-table glass-card rounded-2xl overflow-x-auto">
        <div class="px-6 py-4 border-b border-gray-200 bg-phg-light rounded-t-2xl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold text-phg-primary">
              <i class="fas fa-boxes mr-2"></i>Stock Campospinoso
            </h2>
          </div>
        </div>

        {% if giacenze %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-phg-secondary">
                <tr>
                  {% macro sort_link(column, display_name) -%}
                    {%- set asc_order = column + '_asc' -%}
                    {%- set desc_order = column + '_desc' -%}
                    {%- if ordine == asc_order -%}
                      {%- set next_order = desc_order -%}
                      <th class="px-6 py-3 text-left text-xs font-medium text-phg-primary uppercase tracking-wider cursor-pointer hover:bg-phg-primary hover:bg-opacity-10 transition duration-300">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=next_order) }}" class="flex items-center">
                          {{ display_name }} <i class="fas fa-sort-up ml-1"></i>
                        </a>
                      </th>
                    {%- elif ordine == desc_order -%}
                      {%- set next_order = asc_order -%}
                      <th class="px-6 py-3 text-left text-xs font-medium text-phg-primary uppercase tracking-wider cursor-pointer hover:bg-phg-primary hover:bg-opacity-10 transition duration-300">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=next_order) }}" class="flex items-center">
                          {{ display_name }} <i class="fas fa-sort-down ml-1"></i>
                        </a>
                      </th>
                    {%- else -%}
                      <th class="px-6 py-3 text-left text-xs font-medium text-phg-primary uppercase tracking-wider cursor-pointer hover:bg-phg-primary hover:bg-opacity-10 transition duration-300">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=asc_order) }}" class="flex items-center">
                          {{ display_name }} <i class="fas fa-sort ml-1"></i>
                        </a>
                      </th>
                    {%- endif -%}
                  {%- endmacro %}

                  {{ sort_link('codice_prodotto', 'Codice') }}
                  {{ sort_link('nome_prodotto', 'Prodotto') }}
                  {{ sort_link('magazzino', 'Magazzino') }}
                  {{ sort_link('ubicazione', 'Ubicazione') }}
                  {{ sort_link('stato', 'Stato') }}
                  {{ sort_link('quantita', 'Quantità') }}
                  <th class="px-6 py-3 text-left text-xs font-medium text-phg-primary uppercase tracking-wider">Note</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-phg-primary uppercase tracking-wider">Azioni</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {% for g in giacenze %}
                <tr class="table-row-hover transition duration-300" id="row-{{ g.id }}">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ g.codice_prodotto }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ g.nome_prodotto|format_db_string }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ g.magazzino|format_db_string }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="ubicazione-{{ g.id }}">{{ g.ubicazione|format_db_string }}</td>
                  <td class="px-6 py-4 whitespace-nowrap" id="stato-{{ g.id }}">
                    {% if g.stato == 'ATTIVO' %}
                      <span class="badge status-active">{{ g.stato|format_db_string }}</span>
                    {% elif g.stato == 'IN_ARRIVO' %}
                      <span class="badge status-inactive">{{ g.stato|format_db_string }}</span>
                    {% else %}
                      <span class="badge status-warning">{{ g.stato|format_db_string }}</span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap" id="quantita-{{ g.id }}">
                    <div class="flex items-center">
                      <span class="text-sm font-medium text-gray-900 mr-2">{{ g.quantita }}</span>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" id="note-{{ g.id }}">{{ g.note|format_db_string }}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="flex space-x-1">
                      <button onclick="editRow({{ g.id }}, '{{ g.ubicazione|default('-') }}', '{{ g.stato }}', {{ g.quantita }}, '{{ g.note|default('') }}')" 
                              class="px-2 py-1 text-xs font-medium text-white bg-phg-primary hover:bg-phg-dark rounded transition duration-200" 
                              id="edit-btn-{{ g.id }}" title="Modifica">
                        <i class="fas fa-edit"></i>
                      </button>
                      <form method="POST" action="{{ url_for('elimina_giacenza', giacenza_id=g.id) }}" style="display:inline;" onsubmit="return confirm('Sei sicuro di voler eliminare questa giacenza?');">
                        <button type="submit" class="px-2 py-1 text-xs font-medium text-white bg-red-500 hover:bg-red-600 rounded transition duration-200" title="Elimina">
                          <i class="fas fa-trash"></i>
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                
                <!-- Form di modifica inline (nascosto di default) -->
                <tr class="edit-form bg-phg-light" id="edit-form-{{ g.id }}">
                  <td colspan="8" class="px-6 py-4">
                    <form id="edit-form-{{ g.id }}-form" class="space-y-4">
                      <input type="hidden" name="giacenza_id" value="{{ g.id }}">
                      <input type="hidden" name="quantita_originale" value="{{ g.quantita }}">
                      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                          <label class="block text-sm font-medium text-phg-primary mb-1">Ubicazione</label>
                          <input type="text" name="ubicazione" value="{{ g.ubicazione|default('') }}" 
                                 class="edit-input" placeholder="Ubicazione...">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-phg-primary mb-1">Stato</label>
                          <select name="stato" class="edit-input">
                            {% for stato in stati_opzioni %}
                              <option value="{{ stato }}" {% if g.stato == stato %}selected{% endif %}>{{ stato|format_db_string }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-phg-primary mb-1">Quantità</label>
                          <input type="number" name="quantita" value="{{ g.quantita }}" min="0" 
                                 class="edit-input" required>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-phg-primary mb-1">Note</label>
                          <input type="text" name="note" value="{{ g.note|default('') }}" 
                                 class="edit-input" placeholder="Note...">
                        </div>
                      </div>
                      <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" onclick="cancelEdit({{ g.id }})" 
                                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                          <i class="fas fa-times mr-1"></i>Annulla
                        </button>
                        <button type="button" onclick="submitEdit({{ g.id }})" 
                                class="px-4 py-2 bg-phg-primary hover:bg-phg-dark text-white rounded-lg text-sm font-medium">
                          <i class="fas fa-save mr-1"></i>Salva
                        </button>
                      </div>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      {% else %}
        <div class="px-6 py-12 text-center">
          <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
          <h3 class="text-lg font-medium text-gray-900">Nessuna giacenza disponibile</h3>
          <p class="mt-1 text-sm text-gray-500">Non ci sono prodotti corrispondenti ai filtri selezionati.</p>
          <button class="mt-4 px-4 py-2 bg-phg-primary hover:bg-phg-dark text-white rounded-lg text-sm font-medium">
            <i class="fas fa-plus-circle mr-2"></i> Aggiungi prodotto
          </button>
        </div>
      {% endif %}
    </div>

      <!-- Mobile Cards View - VISTA MOBILE CON MODIFICA -->
      <div class="mobile-view">
        {% if giacenze %}
          {% for g in giacenze %}
          <div class="mobile-table-card" id="mobile-card-{{ g.id }}">
            <!-- Vista normale mobile -->
            <div id="mobile-view-{{ g.id }}">
              <div class="mobile-table-header">
                {{ g.codice_prodotto }} - {{ g.nome_prodotto|format_db_string }}
              </div>
              
              <div class="mobile-table-content">
                <div class="mobile-table-item">
                  <span class="mobile-table-label">Magazzino</span>
                  <span class="mobile-table-value">{{ g.magazzino|format_db_string }}</span>
                </div>
                
                <div class="mobile-table-item">
                  <span class="mobile-table-label">Ubicazione</span>
                  <span class="mobile-table-value" id="mobile-ubicazione-{{ g.id }}">{{ g.ubicazione|format_db_string or '-' }}</span>
                </div>
                
                <div class="mobile-table-item">
                  <span class="mobile-table-label">Stato</span>
                  <span class="mobile-table-value" id="mobile-stato-{{ g.id }}">
                    <span class="badge {% if g.stato == 'ATTIVO' %}status-active{% elif g.stato == 'IN_ARRIVO' %}status-inactive{% else %}status-warning{% endif %}">
                      {{ g.stato|format_db_string }}
                    </span>
                  </span>
                </div>
                
                <div class="mobile-table-item">
                  <span class="mobile-table-label">Quantità</span>
                  <span class="mobile-table-value font-bold text-phg-primary" id="mobile-quantita-{{ g.id }}">{{ g.quantita }}</span>
                </div>
              </div>
              
              {% if g.note %}
              <div class="mt-2 text-sm text-gray-600" id="mobile-note-{{ g.id }}">
                <span class="mobile-table-label">Note:</span> {{ g.note|format_db_string }}
              </div>
              {% endif %}
              
              <div class="mobile-actions">
                <div class="flex space-x-2">
                  <button onclick="editMobileRow({{ g.id }}, '{{ g.ubicazione|default('') }}', '{{ g.stato }}', {{ g.quantita }}, '{{ g.note|default('') }}')" 
                          class="px-4 py-2 text-sm font-medium text-white bg-phg-primary hover:bg-phg-dark rounded-lg transition duration-200" id="mobile-edit-btn-{{ g.id }}">
                    Modifica
                  </button>
                  <form method="POST" action="{{ url_for('elimina_giacenza', giacenza_id=g.id) }}" style="display:inline;" 
                        onsubmit="return confirm('Eliminare questa giacenza?');">
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-500 hover:bg-red-600 rounded-lg transition duration-200">
                      Elimina
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <!-- Form di modifica mobile (nascosto di default) -->
            <div id="mobile-edit-{{ g.id }}" style="display: none;">
              <div class="mobile-table-header mb-4">
                <i class="fas fa-edit mr-2"></i>Modifica: {{ g.codice_prodotto }}
              </div>
              
              <form id="mobile-edit-form-{{ g.id }}" class="space-y-3">
                <input type="hidden" name="giacenza_id" value="{{ g.id }}">
                <input type="hidden" name="quantita_originale" value="{{ g.quantita }}">
                
                <div>
                  <label class="block text-xs font-medium text-phg-primary mb-1 uppercase">Ubicazione</label>
                  <input type="text" name="ubicazione" value="{{ g.ubicazione|default('') }}" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-phg-primary focus:border-phg-primary" 
                         placeholder="Ubicazione...">
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-phg-primary mb-1 uppercase">Stato</label>
                  <select name="stato" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-phg-primary focus:border-phg-primary">
                    {% for stato in stati_opzioni %}
                      <option value="{{ stato }}" {% if g.stato == stato %}selected{% endif %}>{{ stato|format_db_string }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-phg-primary mb-1 uppercase">Quantità</label>
                  <input type="number" name="quantita" value="{{ g.quantita }}" min="0" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-phg-primary focus:border-phg-primary" 
                         required>
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-phg-primary mb-1 uppercase">Note</label>
                  <input type="text" name="note" value="{{ g.note|default('') }}" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-phg-primary focus:border-phg-primary" 
                         placeholder="Note...">
                </div>
                
                <div class="flex space-x-2 pt-2">
                  <button type="button" onclick="cancelMobileEdit({{ g.id }})" 
                          class="flex-1 py-2 px-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-times mr-1"></i>Annulla
                  </button>
                  <button type="button" onclick="submitMobileEdit({{ g.id }})" 
                          class="flex-1 py-2 px-3 bg-phg-primary hover:bg-phg-dark text-white rounded-lg text-sm font-medium">
                    <i class="fas fa-save mr-1"></i>Salva
                  </button>
                </div>
              </form>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-12">
            <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">Nessuna giacenza</h3>
            <p class="text-sm text-gray-500 mb-4">Non ci sono prodotti corrispondenti ai filtri.</p>
            <a href="{{ url_for('nuovo_prodotto') }}" 
               class="inline-flex items-center px-4 py-2 bg-phg-primary text-white rounded-lg">
              <i class="fas fa-plus mr-2"></i>Aggiungi prodotto
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Modal per selezione ubicazione compensazione -->
  <div id="compensazione-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-phg-primary mb-2">
          <i class="fas fa-exchange-alt mr-2"></i>Compensazione Quantità
        </h3>
        <p id="compensazione-descrizione" class="text-gray-600"></p>
      </div>
      
      <div class="mb-6">
        <h4 class="text-md font-medium text-gray-700 mb-3">Seleziona ubicazione per la compensazione:</h4>
        <div id="ubicazioni-list" class="space-y-2">
          <!-- Popolato dinamicamente -->
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button onclick="closeCompensazioneModal()" 
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-times mr-1"></i>Annulla
        </button>
        <button id="conferma-compensazione" onclick="confermaCompensazione()" 
                class="px-4 py-2 bg-phg-primary hover:bg-phg-dark text-white rounded-lg text-sm font-medium" disabled>
          <i class="fas fa-check mr-1"></i>Conferma
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu (hidden by default) -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-10">
    <div class="flex justify-around">
      <a href="{{ url_for('index') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'index' %}text-phg-primary{% else %}text-gray-500{% endif %}">
        <i class="fas fa-boxes text-lg"></i>
        <span class="text-xs mt-1">Magazzino</span>
      </a>
      <a href="{{ url_for('movimento') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'movimento' %}text-phg-primary{% else %}text-gray-500{% endif %}">
        <i class="fas fa-exchange-alt text-lg"></i>
        <span class="text-xs mt-1">Movimento</span>
      </a>
      <a href="{{ url_for('carico_merci') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'carico_merci' %}text-phg-primary{% else %}text-gray-500{% endif %}">
        <i class="fas fa-arrow-up text-lg"></i>
        <span class="text-xs mt-1">Carico</span>
      </a>
      <a href="{{ url_for('scaricomerce') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'scaricomerce' %}text-phg-primary{% else %}text-gray-500{% endif %}">
        <i class="fas fa-arrow-down text-lg"></i>
        <span class="text-xs mt-1">Scarico</span>
      </a>
    </div>
  </div>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    // Toggle filters visibility
    document.getElementById('toggle-filters').addEventListener('click', function() {
      const filtersContainer = document.getElementById('filters-container');
      filtersContainer.classList.toggle('hidden');
      this.classList.toggle('active');
    });

    // Add animation to table rows
    document.querySelectorAll('.table-row-hover').forEach(row => {
      row.addEventListener('mouseenter', () => {
        row.classList.add('transition', 'duration-300');
      });
      row.addEventListener('mouseleave', () => {
        row.classList.remove('transition', 'duration-300');
      });
    });

    // Simulate loading for demo purposes
    setTimeout(() => {
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
      });
    }, 2000);

    // Funzione per attivare la modalità modifica
    function editRow(id, ubicazione, stato, quantita, note) {
      // Nascondi la riga normale e mostra il form di modifica
      document.getElementById(`row-${id}`).style.display = 'none';
      document.getElementById(`edit-form-${id}`).classList.add('active');
      
      // Disabilita tutti gli altri pulsanti di modifica
      document.querySelectorAll('[id^="edit-btn-"]').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });
    }
    
    // Funzione per annullare la modifica
    function cancelEdit(id) {
      // Mostra la riga normale e nascondi il form di modifica
      document.getElementById(`row-${id}`).style.display = 'table-row';
      document.getElementById(`edit-form-${id}`).classList.remove('active');
      
      // Riabilita tutti i pulsanti di modifica
      document.querySelectorAll('[id^="edit-btn-"]').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    
    // Gestisci l'escape per annullare la modifica
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const activeForm = document.querySelector('.edit-form.active');
        if (activeForm) {
          const id = activeForm.id.replace('edit-form-', '');
          cancelEdit(id);
        }
      }
    });

    let compensazioneData = null;
    let ubicazioneSelezionata = null;

    // Funzione per sottomettere la modifica
    function submitEdit(id) {
      const form = document.getElementById(`edit-form-${id}-form`);
      const formData = new FormData(form);
      
      const data = {
        ubicazione: formData.get('ubicazione'),
        stato: formData.get('stato'),
        quantita: formData.get('quantita'),
        note: formData.get('note')
      };
      
      // Invia richiesta di modifica
      fetch(`/modifica_giacenza/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      })
      .then(response => {
        if (response.headers.get('content-type')?.includes('application/json')) {
          return response.json();
        } else {
          // Redirect normale
          window.location.reload();
        }
      })
      .then(data => {
        if (data && data.need_compensation) {
          // Mostra modal di compensazione
          showCompensazioneModal(data);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la modifica');
      });
    }
    
    function showCompensazioneModal(data) {
      compensazioneData = data;
      ubicazioneSelezionata = null;
      
      const modal = document.getElementById('compensazione-modal');
      const descrizione = document.getElementById('compensazione-descrizione');
      const ubicazioniList = document.getElementById('ubicazioni-list');
      
      // Aggiorna descrizione
      const tipoOperazione = data.tipo === 'prelievo' ? 'prelevare' : 'restituire';
      const quantitaAbs = Math.abs(data.differenza);
      descrizione.textContent = `Devi ${tipoOperazione} ${quantitaAbs} unità di "${data.prodotto_nome}". Seleziona l'ubicazione:`;
      
      // Popola lista ubicazioni
      ubicazioniList.innerHTML = '';
      data.giacenze_disponibili.forEach(giacenza => {
        const div = document.createElement('div');
        div.className = 'ubicazione-option';
        div.dataset.giacenzaId = giacenza.id;
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium">${giacenza.ubicazione}</div>
              <div class="text-sm text-gray-500">${giacenza.magazzino}</div>
            </div>
            <div class="text-right">
              <div class="font-medium">Qtà: ${giacenza.quantita}</div>
              ${data.tipo === 'prelievo' && giacenza.quantita < quantitaAbs ? 
                '<div class="text-xs text-red-500">Insufficiente</div>' : ''}
            </div>
          </div>
        `;
        
        // Disabilita se quantità insufficiente
        if (data.tipo === 'prelievo' && giacenza.quantita < quantitaAbs) {
          div.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
          div.onclick = () => selectUbicazione(giacenza.id, div);
        }
        
        ubicazioniList.appendChild(div);
      });
      
      modal.style.display = 'flex';
    }
    
    function selectUbicazione(giacenzaId, element) {
      // Rimuovi selezione precedente
      document.querySelectorAll('.ubicazione-option').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Seleziona nuovo elemento
      element.classList.add('selected');
      ubicazioneSelezionata = giacenzaId;
      
      // Abilita pulsante conferma
      document.getElementById('conferma-compensazione').disabled = false;
    }
    
    function confermaCompensazione() {
      if (!ubicazioneSelezionata || !compensazioneData) return;
      
      const data = {
        giacenza_id: compensazioneData.giacenza_id,
        giacenza_compensazione_id: ubicazioneSelezionata,
        form_data: compensazioneData.form_data,
        differenza: compensazioneData.differenza
      };
      
      fetch('/conferma_modifica_giacenza', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          window.location.reload();
        } else {
          alert('Errore: ' + result.error);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la conferma');
      });
    }
    
    function closeCompensazioneModal() {
      document.getElementById('compensazione-modal').style.display = 'none';
      compensazioneData = null;
      ubicazioneSelezionata = null;
    }
    
    // Chiudi modal con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('compensazione-modal');
        if (modal.style.display === 'flex') {
          closeCompensazioneModal();
        } else {
          const activeForm = document.querySelector('.edit-form.active');
          if (activeForm) {
            const id = activeForm.id.replace('edit-form-', '');
            cancelEdit(id);
          }
        }
      }
    });
    
    // Mobile-specific improvements
    document.addEventListener('DOMContentLoaded', function() {
      // Close mobile sidebar when clicking on main content
      document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
          const sidebar = document.querySelector('.mobile-sidebar');
          const hamburger = document.querySelector('.hamburger-menu');
          
          if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            // Close sidebar using Alpine.js
            window.Alpine && window.Alpine.store && window.Alpine.store('sidebarOpen', false);
          }
        }
      });
      
      // Improve touch interactions on mobile
      if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
      }
    });

    // Funzioni per la modifica mobile
    function editMobileRow(id, ubicazione, stato, quantita, note) {
      // Nascondi la vista normale e mostra il form di modifica
      document.getElementById(`mobile-view-${id}`).style.display = 'none';
      document.getElementById(`mobile-edit-${id}`).style.display = 'block';
      
      // Disabilita tutti gli altri pulsanti di modifica mobile
      document.querySelectorAll('[id^="mobile-edit-btn-"]').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });
    }
    
    function cancelMobileEdit(id) {
      // Mostra la vista normale e nascondi il form di modifica
      document.getElementById(`mobile-view-${id}`).style.display = 'block';
      document.getElementById(`mobile-edit-${id}`).style.display = 'none';
      
      // Riabilita tutti i pulsanti di modifica mobile
      document.querySelectorAll('[id^="mobile-edit-btn-"]').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    
    function submitMobileEdit(id) {
      const form = document.getElementById(`mobile-edit-form-${id}`);
      const formData = new FormData(form);
      
      const data = {
        ubicazione: formData.get('ubicazione'),
        stato: formData.get('stato'),
        quantita: formData.get('quantita'),
        note: formData.get('note')
      };
      
      // Invia richiesta di modifica (usa la stessa logica del desktop)
      fetch(`/modifica_giacenza/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      })
      .then(response => {
        if (response.headers.get('content-type')?.includes('application/json')) {
          return response.json();
        } else {
          // Redirect normale
          window.location.reload();
        }
      })
      .then(data => {
        if (data && data.need_compensation) {
          // Mostra modal di compensazione
          showCompensazioneModal(data);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la modifica');
      });
    }

    // Gestisci l'escape per annullare la modifica anche su mobile
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
       

        const modal = document.getElementById('compensazione-modal');
        if (modal.style.display === 'flex') {
          closeCompensazioneModal();
        } else {
          // Controlla se c'è una modifica desktop attiva
          const activeForm = document.querySelector('.edit-form.active');
          if (activeForm) {
            const id = activeForm.id.replace('edit-form-', '');
            cancelEdit(id);
          } else {
            // Controlla se c'è una modifica mobile attiva
            const activeMobileEdit = document.querySelector('[id^="mobile-edit-"]:not([style*="display: none"])');
            if (activeMobileEdit) {
              const id = activeMobileEdit.id.replace('mobile-edit-', '');
              cancelMobileEdit(id);
            }
          }
        }
      }
    });
  </script>

  <script>
    // Fallback e debugging per il dark mode toggle (index.html)
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded index, localStorage darkMode:', localStorage.getItem('darkMode'));
      console.log('Body classes index:', document.body.classList.toString());
      console.log('DocumentElement classes index:', document.documentElement.classList.toString());
      
      const toggleButton = document.getElementById('dark-mode-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          console.log('Fallback click listener triggered (index)');
          // Verifica lo stato del localStorage dopo il click
          setTimeout(() => {
            const currentMode = localStorage.getItem('darkMode');
            const hasBodyDark = document.body.classList.contains('dark');
            const hasHtmlDark = document.documentElement.classList.contains('dark');
            console.log('Dopo click index - localStorage:', currentMode, 'body.dark:', hasBodyDark, 'html.dark:', hasHtmlDark);
            
            // Se c'è inconsistenza, correggi
            if (currentMode === 'true' && (!hasBodyDark || !hasHtmlDark)) {
              console.log('Correzione index: attivando dark mode');
              document.body.classList.add('dark');
              document.documentElement.classList.add('dark');
              document.body.style.backgroundColor = '#000000';
              document.documentElement.style.backgroundColor = '#000000';
            } else if (currentMode === 'false' && (hasBodyDark || hasHtmlDark)) {
              console.log('Correzione index: disattivando dark mode');
              document.body.classList.remove('dark');
              document.documentElement.classList.remove('dark');
              document.body.style.backgroundColor = '';
              document.documentElement.style.backgroundColor = '';
            }
          }, 50);
        });
      }
    });
  </script>
{% endblock %}
</body>
</html>
