{% extends "base.html" %}

{% block title %}Gestione Magazzino - Pharmagest{% endblock %}

{% block extra_css %}
<style>
/* Sistema AMOLED dark mode con colori blu come le altre pagine */
:root {
  --bg-primary: rgba(255, 255, 255, 0.95);
  --bg-secondary: rgba(243, 244, 246, 0.9);
  --border-light: rgba(150, 150, 150, 0.25);
  --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --accent-color: #0056a6;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
}

.dark {
  --bg-primary: rgba(0, 0, 0, 0.98);
  --bg-secondary: rgba(0, 0, 0, 0.95);
  --border-light: rgba(40, 40, 40, 0.8);
  --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
  --accent-color: #60a5fa;
  --text-primary: #ffffff;
  --text-secondary: #d1d5db;
}

/* Dashboard card icons */
.dashboard-card-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 4.5rem;
  height: 4.5rem;
  border-radius: 50%;
  background: linear-gradient(135deg, #e3f2fd 0%, #00a8e8 100%);
  color: #0056a6;
  font-size: 2.5rem;
  margin-bottom: 1.2rem;
  box-shadow: 0 2px 8px rgba(0,86,166,0.08);
  transition: all 0.2s ease;
}

.dark .dashboard-card-icon {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(37, 99, 235, 0.5) 100%);
  color: var(--accent-color);
  box-shadow: 0 4px 16px 0 rgba(96, 165, 250, 0.3);
}

/* Floating buttons */
.floating-btn {
  box-shadow: 0 10px 15px -3px rgba(0, 86, 166, 0.3), 0 4px 6px -2px rgba(0, 86, 166, 0.1);
  transition: all 0.3s ease;
}

.floating-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 25px -5px rgba(0, 86, 166, 0.3), 0 10px 10px -5px rgba(0, 86, 166, 0.1);
}

.dark .floating-btn {
  box-shadow: 0 4px 16px 0 rgba(37, 99, 235, 0.3);
}

.dark .floating-btn:hover {
  box-shadow: 0 4px 12px rgba(29, 78, 216, 0.4);
}

/* Filter toggle */
.filter-toggle {
  transition: all 0.3s ease;
}

.filter-toggle.active {
  background-color: var(--accent-color);
  color: white;
}

.dark .filter-toggle.active {
  background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
  box-shadow: 0 4px 16px 0 rgba(37, 99, 235, 0.3);
}

/* Table row hover */
.table-row-hover:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px -1px rgba(0, 86, 166, 0.1), 0 2px 4px -1px rgba(0, 86, 166, 0.06);
  background: #e3f2fd;
  border-radius: 1rem;
}

.dark .table-row-hover:hover {
  background: var(--bg-secondary);
  box-shadow: var(--shadow-light);
}

/* Badge styling */
.badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  transition: all 0.2s ease;
}

.status-active {
  background-color: #e3f2fd;
  color: #0056a6;
}

.dark .status-active {
  background-color: rgba(96, 165, 250, 0.2);
  color: var(--accent-color);
}

.status-inactive {
  background-color: #fef3c7;
  color: #92400e;
}

.dark .status-inactive {
  background-color: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
}

.status-warning {
  background-color: #fee2e2;
  color: #b91c1c;
}

.dark .status-warning {
  background-color: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

/* Edit forms */
.edit-form {
  display: none;
}

.edit-form.active {
  display: table-row;
}

.edit-input {
  width: 100%;
  padding: 0.375rem 0.75rem;
  border: 1px solid var(--border-light);
  border-radius: 0.375rem;
  font-size: 0.875rem;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: all 0.2s ease;
}

.edit-input:focus {
  outline: none;
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
}

.dark .edit-input {
  background: var(--bg-secondary);
  border-color: var(--border-light);
  color: var(--text-primary);
}

.dark .edit-input:focus {
  border-color: var(--accent-color);
  box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.3);
}

/* Mobile responsive */
@media (max-width: 768px) {
  .dashboard-card-icon {
    width: 32px;
    height: 32px;
    font-size: 16px;
    margin-bottom: 8px;
  }
}
</style>
{% endblock %}

{% block content %}
<div x-data="{ 
  sidebarOpen: false,
  filtersOpen: false,
  editingRow: null,
  compensazioneData: null,
  ubicazioneSelezionata: null
}">

<div class="px-2 md:px-6 pt-16 pb-4 md:pb-6 w-full">
  <!-- Mobile Stats Cards -->
  <div class="mobile-stats md:hidden">
    <div class="mobile-stat-card">
      <div class="mobile-stat-icon">
        <i class="fas fa-box-open"></i>
      </div>
      <div class="mobile-stat-value">{{ total_products }}</div>
      <div class="mobile-stat-label">Prodotti</div>
    </div>
    <div class="mobile-stat-card">
      <div class="mobile-stat-icon">
        <i class="fas fa-exchange-alt"></i>
      </div>
      <div class="mobile-stat-value">{{ movements_today }}</div>
      <div class="mobile-stat-label">Mov. Oggi</div>
    </div>
    <div class="mobile-stat-card">
      <div class="mobile-stat-icon" style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white;">
        <i class="fas fa-chart-line"></i>
      </div>
      <div class="mobile-stat-value">{{ giacenze|length if giacenze else 0 }}</div>
      <div class="mobile-stat-label">Giacenze</div>
    </div>
  </div>

  <!-- Desktop Stats Cards -->
  <div class="hidden md:flex flex-col md:flex-row gap-8 mb-8 w-full">
    <div class="glass-card flex-1 rounded-xl p-8 flex flex-col items-center justify-center">
      <div class="dashboard-card-icon">
        <i class="fas fa-box-open"></i>
      </div>
      <p class="text-base font-medium text-gray-500 dark:text-gray-400 text-center">Prodotti Totali</p>
      <p class="mt-2 text-4xl font-bold dark:text-blue-300 text-center" style="color: #2256a7;">{{ total_products }}</p>
    </div>
    <div class="glass-card flex-1 rounded-xl p-8 flex flex-col items-center justify-center">
      <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #e3f2fd 0%, #a7f3d0 100%); color: #059669;">
        <i class="fas fa-exchange-alt"></i>
      </div>
      <p class="text-base font-medium text-gray-500 dark:text-gray-400 text-center">Movimenti Oggi</p>
      <p class="mt-2 text-4xl font-bold dark:text-blue-300 text-center" style="color: #2256a7;">{{ movements_today }}</p>
    </div>
    <!-- Aggiungiamo una terza card per utilizzare meglio lo spazio -->
    <div class="glass-card flex-1 rounded-xl p-8 flex flex-col items-center justify-center">
      <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #e3f2fd 0%, #fef3c7 100%); color: #d97706;">
        <i class="fas fa-chart-line"></i>
      </div>
      <p class="text-base font-medium text-gray-500 dark:text-gray-400 text-center">Giacenze Attive</p>
      <p class="mt-2 text-4xl font-bold dark:text-blue-300 text-center" style="color: #2256a7;">{{ giacenze|length if giacenze else 0 }}</p>
    </div>
  </div>

      <!-- Mobile Filters -->
      <div class="md:hidden">
        <div class="mobile-filters">
          <button @click="filtersOpen = !filtersOpen" 
                  class="w-full flex items-center justify-between p-3 text-white rounded-lg" style="background-color: #2256a7;">
            <span class="flex items-center">
              <i class="fas fa-filter mr-2"></i>Filtri
            </span>
            <i class="fas fa-chevron-down" 
               :class="{ 'rotate-180': filtersOpen }"></i>
          </button>
          
          <div x-show="filtersOpen" x-transition class="mt-4 space-y-3">
            <form method="GET" action="{{ url_for('index') }}">
              <div class="space-y-3">
                <input type="text" name="filtro_codice" value="{{ filtro_codice|default('') }}"
                       placeholder="Codice prodotto..." 
                       class="w-full px-3 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-800 dark:border-blue-600 dark:text-white" style="border-color: rgba(34, 86, 167, 0.3);">
                
                <input type="text" name="filtro_nome" value="{{ filtro_nome|default('') }}"
                       placeholder="Nome prodotto..." 
                       class="w-full px-3 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-800 dark:border-blue-600 dark:text-white" style="border-color: rgba(34, 86, 167, 0.3);">
                
                <select name="filtro_stato" class="w-full px-3 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-800 dark:border-blue-600 dark:text-white" style="border-color: rgba(34, 86, 167, 0.3);">
                  <option value="">-- Tutti gli stati --</option>
                  {% for st in stati_opzioni %}
                    <option value="{{ st }}" {% if filtro_stato == st %}selected{% endif %}>
                      {{ st|format_db_string }}
                    </option>
                  {% endfor %}
                </select>
                
                <div class="flex space-x-2">
                  <button type="button" onclick="window.location='{{ url_for('index') }}'"
                          class="flex-1 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-700 dark:border-blue-600 dark:text-blue-300 hover:bg-blue-50 dark:hover:bg-gray-600" style="border-color: rgba(34, 86, 167, 0.3); color: #2256a7;">
                    Reset
                  </button>
                  <button type="submit" 
                          class="flex-1 py-2 text-white rounded-lg text-sm dark:bg-blue-700 dark:hover:bg-blue-800" style="background-color: #2256a7;">
                    Applica
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Mobile Quick Actions -->
      <div class="md:hidden mb-4">
        <div class="flex space-x-2 overflow-x-auto pb-2 justify-center">
          <a href="{{ url_for('movimento') }}" 
             class="flex-shrink-0 text-white px-4 py-2 rounded-lg text-sm flex items-center" style="background-color: #2256a7;">
            <i class="fas fa-plus-circle mr-2"></i>Movimento
          </a>
          <a href="{{ url_for('nuovo_prodotto') }}" 
             class="flex-shrink-0 bg-green-600 text-white px-4 py-2 rounded-lg text-sm flex items-center">
            <i class="fas fa-plus mr-2"></i>Prodotto
          </a>
          <a href="{{ url_for('carico_merci') }}" 
             class="flex-shrink-0 text-white px-4 py-2 rounded-lg text-sm flex items-center" style="background-color: #2256a7;">
            <i class="fas fa-arrow-up mr-2"></i>Carico
          </a>
        </div>
      </div>

      <!-- Desktop Filters and Actions -->
      <div class="hidden md:block mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center space-x-2">
            <button id="toggle-filters" class="filter-toggle px-4 py-2 rounded-lg dark:bg-blue-700 dark:hover:bg-blue-800 text-white text-sm font-medium flex items-center" style="background-color: #2256a7;">
              <i class="fas fa-filter mr-2"></i> Filtri
            </button>
          </div>
          <div class="flex space-x-3">
            <form method="get" action="{{ url_for('esporta_magazzino') }}">
              <button type="submit" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 flex items-center">
                <i class="fas fa-file-export mr-2"></i> Esporta TXT
              </button>
            </form>
            <form method="get" action="{{ url_for('esporta_magazzino_xlsx') }}">
              <button type="submit" class="px-4 py-2 border border-green-300 rounded-lg text-sm font-medium text-green-700 bg-white hover:bg-green-50 flex items-center">
                <i class="fas fa-file-excel mr-2"></i> Esporta Excel
              </button>
            </form>
            <a href="{{ url_for('movimento') }}" class="floating-btn px-4 py-2 text-white rounded-lg text-sm font-medium flex items-center" style="background-color: #2256a7;">
              <i class="fas fa-plus-circle mr-2"></i> Nuovo Movimento
            </a>
            <a href="{{ url_for('nuovo_prodotto') }}" class="floating-btn px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium flex items-center">
              <i class="fas fa-plus mr-2"></i> Nuovo Prodotto
            </a>
          </div>
        </div>

        <!-- Filters Panel -->
        <div id="filters-container" class="mt-4 glass-card rounded-xl p-6 w-full">
          <form method="GET" action="{{ url_for('index') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
              <!-- Codice Prodotto -->
              <div>
                <label for="filtro_codice" class="block text-sm font-medium text-gray-700 mb-1">Codice Prodotto</label>
                <input type="text" id="filtro_codice" name="filtro_codice" value="{{ filtro_codice|default('') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" style="focus:ring-color: #2256a7; focus:border-color: #2256a7;">
              </div>
              
              <!-- Nome Prodotto -->
              <div>
                <label for="filtro_nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto</label>
                <input type="text" id="filtro_nome" name="filtro_nome" value="{{ filtro_nome|default('') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" style="focus:ring-color: #2256a7; focus:border-color: #2256a7;">
              </div>
              
              <!-- Magazzino -->
              <div>
                <label for="filtro_magazzino" class="block text-sm font-medium text-gray-700 mb-1">Magazzino</label>
                <select id="filtro_magazzino" name="filtro_magazzino"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" style="focus:ring-color: #2256a7; focus:border-color: #2256a7;">
                  <option value="">-- Tutti --</option>
                  {% for mag in magazzini_opzioni %}
                    <option value="{{ mag }}" {% if filtro_magazzino == mag %}selected{% endif %}>{{ mag|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Stato -->
              <div>
                <label for="filtro_stato" class="block text-sm font-medium text-gray-700 mb-1">Stato</label>
                <select id="filtro_stato" name="filtro_stato"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" style="focus:ring-color: #2256a7; focus:border-color: #2256a7;">
                  <option value="">-- Tutti --</option>
                  {% for st in stati_opzioni %}
                    <option value="{{ st }}" {% if filtro_stato == st %}selected{% endif %}>{{ st|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Ubicazione -->
              <div>
                <label for="filtro_ubicazione" class="block text-sm font-medium text-gray-700 mb-1">Ubicazione</label>
                <select id="filtro_ubicazione" name="filtro_ubicazione"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" style="focus:ring-color: #2256a7; focus:border-color: #2256a7;">
                  <option value="">-- Tutte --</option>
                  {% for ub in ubicazioni_opzioni %}
                    <option value="{{ ub }}" {% if filtro_ubicazione == ub %}selected{% endif %}>{{ ub|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Note -->
              <div>
                <label for="filtro_note" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                <input type="text" id="filtro_note" name="filtro_note" value="{{ filtro_note|default('') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm" style="focus:ring-color: #2256a7; focus:border-color: #2256a7;" />
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
              <button type="button" onclick="window.location='{{ url_for('index') }}'"
                      class="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2" style="focus:ring-color: #2256a7;">
                <i class="fas fa-undo mr-2"></i>Reset
              </button>
              <button type="submit"
                      class="px-6 py-2 border border-transparent rounded-lg text-sm font-medium text-white focus:outline-none focus:ring-2 focus:ring-offset-2" style="background-color: #2256a7; focus:ring-color: #2256a7;">
                <i class="fas fa-check mr-2"></i>Applica
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="desktop-table glass-card rounded-2xl overflow-x-auto w-full hidden md:block">
        <div class="px-6 py-4 border-b bg-blue-25 dark:bg-gray-800 dark:border-blue-600 rounded-t-2xl" style="border-color: rgba(34, 86, 167, 0.2);">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold dark:text-blue-300" style="color: #2256a7;">
              <i class="fas fa-boxes mr-2"></i>Stock Campospinoso - Giacenze
            </h2>
            <div class="text-sm dark:text-blue-400" style="color: #2256a7;">
              Visualizza tutti i prodotti in magazzino
            </div>
          </div>
        </div>

        {% if giacenze %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
              <thead class="bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-800 dark:to-gray-700">
                <tr>
                  {% macro sort_link(column, display_name) -%}
                    {%- set asc_order = column + '_asc' -%}
                    {%- set desc_order = column + '_desc' -%}
                    {%- if ordine == asc_order -%}
                      {%- set next_order = desc_order -%}
                      <th class="px-6 py-4 text-left text-xs font-semibold dark:text-blue-300 uppercase tracking-wider cursor-pointer hover:bg-blue-100 dark:hover:bg-gray-600 transition-colors duration-200" style="color: #2256a7;">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=next_order) }}" class="flex items-center group">
                          {{ display_name }} <i class="fas fa-sort-up ml-2 text-blue-500 group-hover:text-blue-600"></i>
                        </a>
                      </th>
                    {%- elif ordine == desc_order -%}
                      {%- set next_order = asc_order -%}
                      <th class="px-6 py-4 text-left text-xs font-semibold dark:text-blue-300 uppercase tracking-wider cursor-pointer hover:bg-blue-100 dark:hover:bg-gray-600 transition-colors duration-200" style="color: #2256a7;">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=next_order) }}" class="flex items-center group">
                          {{ display_name }} <i class="fas fa-sort-down ml-2 text-blue-500 group-hover:text-blue-600"></i>
                        </a>
                      </th>
                    {%- else -%}
                      <th class="px-6 py-4 text-left text-xs font-semibold dark:text-blue-300 uppercase tracking-wider cursor-pointer hover:bg-blue-100 dark:hover:bg-gray-600 transition-colors duration-200" style="color: #2256a7;">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=asc_order) }}" class="flex items-center group">
                          {{ display_name }} <i class="fas fa-sort ml-2 text-gray-400 group-hover:text-blue-500"></i>
                        </a>
                      </th>
                    {%- endif -%}
                  {%- endmacro %}

                  {{ sort_link('codice_prodotto', 'Codice') }}
                  {{ sort_link('nome_prodotto', 'Prodotto') }}
                  {{ sort_link('magazzino', 'Magazzino') }}
                  {{ sort_link('ubicazione', 'Ubicazione') }}
                  {{ sort_link('stato', 'Stato') }}
                  {{ sort_link('quantita', 'Quantità') }}
                  <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider" style="color: #2256a7;">Note</th>
                  <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider" style="color: #2256a7;">Azioni</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-700">
                {% for g in giacenze %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150" id="row-{{ g.id }}">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ g.codice_prodotto }}</span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ g.nome_prodotto|format_db_string }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                      {{ g.magazzino|format_db_string }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400" id="ubicazione-{{ g.id }}">
                    <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>{{ g.ubicazione|format_db_string }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap" id="stato-{{ g.id }}">
                    {% if g.stato == 'ATTIVO' %}
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        {{ g.stato|format_db_string }}
                      </span>
                    {% elif g.stato == 'IN_ARRIVO' %}
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                        {{ g.stato|format_db_string }}
                      </span>
                    {% else %}
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">
                        <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                        {{ g.stato|format_db_string }}
                      </span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap" id="quantita-{{ g.id }}">
                    <span class="text-sm font-bold" style="color: #2256a7;">{{ g.quantita }}</span>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs" id="note-{{ g.id }}">
                    <div class="truncate" title="{{ g.note|format_db_string }}">
                      {% if g.note %}
                        <i class="fas fa-sticky-note mr-2 text-gray-400"></i>{{ g.note|format_db_string }}
                      {% else %}
                        <span class="text-gray-300 dark:text-gray-600 italic">Nessuna nota</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <div class="flex space-x-2">
                      <button class="edit-btn inline-flex items-center px-3 py-2 text-xs font-medium rounded-lg text-white transition-all duration-200 hover:shadow-md transform hover:scale-105" 
                              style="background: linear-gradient(135deg, #2256a7, #1e4d96);"
                              data-id="{{ g.id }}" 
                              data-ubicazione="{{ g.ubicazione|default('') }}" 
                              data-stato="{{ g.stato }}" 
                              data-quantita="{{ g.quantita }}" 
                              data-note="{{ g.note|default('') }}"
                              id="edit-btn-{{ g.id }}" title="Modifica giacenza">
                        <i class="fas fa-edit mr-1"></i>Modifica
                      </button>
                      <form method="POST" action="{{ url_for('elimina_giacenza', giacenza_id=g.id) }}" style="display:inline;" onsubmit="return confirm('Sei sicuro di voler eliminare questa giacenza?');">
                        <button type="submit" class="inline-flex items-center px-3 py-2 text-xs font-medium rounded-lg text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 transition-all duration-200 hover:shadow-md transform hover:scale-105" title="Elimina giacenza">
                          <i class="fas fa-trash mr-1"></i>Elimina
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                
                <!-- Form di modifica inline (nascosto di default) -->
                <tr class="edit-form bg-blue-25 dark:bg-gray-800" id="edit-form-{{ g.id }}">
                  <td colspan="8" class="px-6 py-4">
                    <form id="edit-form-{{ g.id }}-form" class="space-y-4">
                      <input type="hidden" name="giacenza_id" value="{{ g.id }}">
                      <input type="hidden" name="quantita_originale" value="{{ g.quantita }}">
                      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Ubicazione</label>
                          <input type="text" name="ubicazione" value="{{ g.ubicazione|default('') }}" 
                                 class="edit-input" placeholder="Ubicazione...">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Stato</label>
                          <select name="stato" class="edit-input">
                            {% for stato in stati_opzioni %}
                              <option value="{{ stato }}" {% if g.stato == stato %}selected{% endif %}>{{ stato|format_db_string }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Quantità</label>
                          <input type="number" name="quantita" value="{{ g.quantita }}" min="0" 
                                 class="edit-input" required>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Note</label>
                          <input type="text" name="note" value="{{ g.note|default('') }}" 
                                 class="edit-input" placeholder="Note...">
                        </div>
                      </div>
                      <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" class="cancel-edit-btn px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" data-id="{{ g.id }}">
                          <i class="fas fa-times mr-1"></i>Annulla
                        </button>
                        <button type="button" class="submit-edit-btn px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium" data-id="{{ g.id }}">
                          <i class="fas fa-save mr-1"></i>Salva
                        </button>
                      </div>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      {% else %}
        <div class="px-6 py-12 text-center">
          <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
          <h3 class="text-lg font-medium text-gray-900">Nessuna giacenza disponibile</h3>
          <p class="mt-1 text-sm text-gray-500">Non ci sono prodotti corrispondenti ai filtri selezionati.</p>
          <button class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-plus-circle mr-2"></i> Aggiungi prodotto
          </button>
        </div>
      {% endif %}
    </div>

      <!-- Mobile Cards View - VISTA MOBILE CON MODIFICA -->
      <div class="mobile-view block md:hidden">
        {% if giacenze %}
          {% for g in giacenze %}
          <div class="mobile-giacenza-item" id="mobile-card-{{ g.id }}">
            <!-- Vista normale mobile -->
            <div id="mobile-view-{{ g.id }}">
              <!-- Header con codice e nome prodotto -->
              <div class="mobile-giacenza-header">
                <div class="mobile-giacenza-title">{{ g.nome_prodotto|format_db_string }}</div>
                <div class="mobile-giacenza-code">{{ g.codice_prodotto }}</div>
              </div>
              
              <!-- Dettagli in griglia -->
              <div class="mobile-giacenza-details">
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Magazzino</div>
                  <div class="mobile-giacenza-detail-value">{{ g.magazzino|format_db_string }}</div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Ubicazione</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-ubicazione-{{ g.id }}">{{ g.ubicazione|format_db_string or '-' }}</div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Stato</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-stato-{{ g.id }}">
                    <span class="badge {% if g.stato == 'ATTIVO' %}status-active{% elif g.stato == 'IN_ARRIVO' %}status-inactive{% else %}status-warning{% endif %}">
                      {{ g.stato|format_db_string }}
                    </span>
                  </div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Quantità</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-quantita-{{ g.id }}">
                    <span class="font-bold text-blue-500">{{ g.quantita }}</span>
                  </div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Note</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-note-display-{{ g.id }}">
                    {{ g.note|format_db_string or '-' }}
                  </div>
                </div>
              </div>
              
              <!-- Azioni rapide mobile -->
              <div class="mobile-giacenza-actions">
                <!-- Pulsante per modifica -->
                <button class="edit-mobile-btn mobile-action-btn" 
                        data-id="{{ g.id }}" 
                        data-ubicazione="{{ g.ubicazione|default('') }}" 
                        data-stato="{{ g.stato }}" 
                        data-quantita="{{ g.quantita }}" 
                        data-note="{{ g.note|default('') }}"
                        style="background: linear-gradient(120deg, #e3f2fd 0%, #f0f8ff 100%); color: #0056a6; border: 1px solid rgba(0, 86, 166, 0.2);">
                  <i class="fas fa-edit mr-1"></i>Modifica
                </button>
                
                <!-- Menu a tendina per azioni -->
                <div class="relative">
                  <button class="toggle-mobile-action-menu mobile-action-btn" 
                          data-id="{{ g.id }}"
                          style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white;">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  
                  <!-- Menu azioni nascosto -->
                  <div id="mobile-action-menu-{{ g.id }}" class="mobile-action-menu" style="display: none;">
                    <button class="edit-mobile-row-btn mobile-menu-item"
                            data-id="{{ g.id }}" 
                            data-ubicazione="{{ g.ubicazione|default('') }}" 
                            data-stato="{{ g.stato }}" 
                            data-quantita="{{ g.quantita }}" 
                            data-note="{{ g.note|default('') }}">
                      <i class="fas fa-cog mr-2"></i>Modifica avanzata
                    </button>
                    <button class="confirm-mobile-delete-btn mobile-menu-item mobile-menu-item-danger"
                            data-id="{{ g.id }}" 
                            data-product-name="{{ g.nome_prodotto|format_db_string }}">
                      <i class="fas fa-trash mr-2"></i>Elimina
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Modifica rapida quantità (nascosta di default) -->
              <div id="mobile-quick-edit-{{ g.id }}" class="mobile-quick-edit" style="display: none;">
                <div class="flex items-center gap-2 mt-3 p-3 bg-gray-50 rounded-lg">
                  <span class="text-sm font-medium text-gray-600">Quantità:</span>
                  <div class="flex items-center gap-1">
                    <button class="adjust-mobile-quantity-btn quick-qty-btn"
                            data-id="{{ g.id }}" data-delta="-1">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="mobile-qty-{{ g.id }}" value="{{ g.quantita }}" 
                           class="quick-qty-input" min="0">
                    <button class="adjust-mobile-quantity-btn quick-qty-btn"
                            data-id="{{ g.id }}" data-delta="1">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  <div class="flex gap-1 ml-auto">
                    <button class="save-mobile-quick-edit-btn quick-save-btn" data-id="{{ g.id }}">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="cancel-mobile-quick-edit-btn quick-cancel-btn" data-id="{{ g.id }}">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form di modifica mobile (nascosto di default) -->
            <div id="mobile-edit-{{ g.id }}" style="display: none;">
              <div class="mobile-table-header mb-4">
                <i class="fas fa-edit mr-2"></i>Modifica: {{ g.codice_prodotto }}
              </div>
              
              <form id="mobile-edit-form-{{ g.id }}" class="space-y-3">
                <input type="hidden" name="giacenza_id" value="{{ g.id }}">
                <input type="hidden" name="quantita_originale" value="{{ g.quantita }}">
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Ubicazione</label>
                  <input type="text" name="ubicazione" value="{{ g.ubicazione|default('') }}" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" 
                         placeholder="Ubicazione...">
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Stato</label>
                  <select name="stato" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
                    {% for stato in stati_opzioni %}
                      <option value="{{ stato }}" {% if g.stato == stato %}selected{% endif %}>{{ stato|format_db_string }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Quantità</label>
                  <input type="number" name="quantita" value="{{ g.quantita }}" min="0" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" 
                         required>
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Note</label>
                  <input type="text" name="note" value="{{ g.note|default('') }}" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" 
                         placeholder="Note...">
                </div>
                
                <div class="flex space-x-2 pt-2">
                  <button type="button" class="cancel-mobile-edit-btn flex-1 py-2 px-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" data-id="{{ g.id }}">
                    <i class="fas fa-times mr-1"></i>Annulla
                  </button>
                  <button type="button" class="submit-mobile-edit-btn flex-1 py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium" data-id="{{ g.id }}">
                    <i class="fas fa-save mr-1"></i>Salva
                  </button>
                </div>
              </form>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-12">
            <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">Nessuna giacenza</h3>
            <p class="text-sm text-gray-500 mb-4">Non ci sono prodotti corrispondenti ai filtri.</p>
            <a href="{{ url_for('nuovo_prodotto') }}" 
               class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">
              <i class="fas fa-plus mr-2"></i>Aggiungi prodotto
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Modal per selezione ubicazione compensazione -->
  <div id="compensazione-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-300 mb-2">
          <i class="fas fa-exchange-alt mr-2"></i>Compensazione Quantità
        </h3>
        <p id="compensazione-descrizione" class="text-gray-600"></p>
      </div>
      
      <div class="mb-6">
        <h4 class="text-md font-medium text-gray-700 mb-3">Seleziona ubicazione per la compensazione:</h4>
        <div id="ubicazioni-list" class="space-y-2">
          <!-- Popolato dinamicamente -->
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button onclick="closeCompensazioneModal()" 
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-times mr-1"></i>Annulla
        </button>
        <button id="conferma-compensazione" onclick="confermaCompensazione()" 
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium" disabled>
          <i class="fas fa-check mr-1"></i>Conferma
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu (hidden by default) -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-10">
    <div class="flex justify-around">
      <a href="{{ url_for('index') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'index' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-boxes text-lg"></i>
        <span class="text-xs mt-1">Magazzino</span>
      </a>
      <a href="{{ url_for('movimento') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'movimento' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-exchange-alt text-lg"></i>
        <span class="text-xs mt-1">Movimento</span>
      </a>
      <a href="{{ url_for('carico_merci') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'carico_merci' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-arrow-up text-lg"></i>
        <span class="text-xs mt-1">Carico</span>
      </a>
      <a href="{{ url_for('scaricomerce') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'scaricomerce' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-arrow-down text-lg"></i>
        <span class="text-xs mt-1">Scarico</span>
      </a>
    </div>
  </div>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    // Toggle filters visibility
    document.getElementById('toggle-filters').addEventListener('click', function() {
      const filtersContainer = document.getElementById('filters-container');
      filtersContainer.classList.toggle('hidden');
      // Rimuoviamo il toggle della classe 'active' che non serve più
    });

    // Add animation to table rows (disabilitato per performance)
    document.querySelectorAll('.table-row-hover').forEach(row => {
      // Hover effects disabilitati per migliorare performance dark mode
    });

    // Simulate loading for demo purposes
    setTimeout(() => {
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
      });
    }, 2000);

    // Funzione per attivare la modalità modifica
    function editRow(id, ubicazione, stato, quantita, note) {
      // Nascondi la riga normale e mostra il form di modifica
      document.getElementById(`row-${id}`).style.display = 'none';
      document.getElementById(`edit-form-${id}`).classList.add('active');
      
      // Disabilita tutti gli altri pulsanti di modifica
      document.querySelectorAll('[id^="edit-btn-"]').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });
    }
    
    // Funzione per annullare la modifica
    function cancelEdit(id) {
      // Mostra la riga normale e nascondi il form di modifica
      document.getElementById(`row-${id}`).style.display = 'table-row';
      document.getElementById(`edit-form-${id}`).classList.remove('active');
      
      // Riabilita tutti i pulsanti di modifica
      document.querySelectorAll('[id^="edit-btn-"]').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    
    // Gestisci l'escape per annullare la modifica
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const activeForm = document.querySelector('.edit-form.active');
        if (activeForm) {
          const id = activeForm.id.replace('edit-form-', '');
          cancelEdit(id);
        }
      }
    });

    let compensazioneData = null;
    let ubicazioneSelezionata = null;

    // Funzione per sottomettere la modifica
    function submitEdit(id) {
      const form = document.getElementById(`edit-form-${id}-form`);
      const formData = new FormData(form);
      
      const data = {
        ubicazione: formData.get('ubicazione'),
        stato: formData.get('stato'),
        quantita: formData.get('quantita'),
        note: formData.get('note')
      };
      
      // Invia richiesta di modifica
      fetch(`/modifica_giacenza/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      })
      .then(response => {
        if (response.headers.get('content-type')?.includes('application/json')) {
          return response.json();
        } else {
          // Redirect normale
          window.location.reload();
        }
      })
      .then(data => {
        if (data && data.need_compensation) {
          // Mostra modal di compensazione
          showCompensazioneModal(data);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la modifica');
      });
    }
    
    function showCompensazioneModal(data) {
      compensazioneData = data;
      ubicazioneSelezionata = null;
      
      const modal = document.getElementById('compensazione-modal');
      const descrizione = document.getElementById('compensazione-descrizione');
      const ubicazioniList = document.getElementById('ubicazioni-list');
      
      // Aggiorna descrizione
      const tipoOperazione = data.tipo === 'prelievo' ? 'prelevare' : 'restituire';
      const quantitaAbs = Math.abs(data.differenza);
      descrizione.textContent = `Devi ${tipoOperazione} ${quantitaAbs} unità di "${data.prodotto_nome}". Seleziona l'ubicazione:`;
      
      // Popola lista ubicazioni
      ubicazioniList.innerHTML = '';
      data.giacenze_disponibili.forEach(giacenza => {
        const div = document.createElement('div');
        div.className = 'ubicazione-option';
        div.dataset.giacenzaId = giacenza.id;
        div.dataset.ubicazione = giacenza.ubicazione;
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium">${giacenza.ubicazione}</div>
              <div class="text-sm text-gray-500">
                ${giacenza.magazzino}
                ${giacenza.tipo_ubicazione === 'nuova' ? 
                  '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded ml-2">Nuova ubicazione</span>' : ''}
              </div>
            </div>
            <div class="text-right">
              <div class="font-medium">
                ${giacenza.tipo_ubicazione === 'nuova' ? 
                  'Vuota' : 
                  `Qtà: ${giacenza.quantita}`}
              </div>
              ${data.tipo === 'prelievo' && giacenza.quantita < quantitaAbs ? 
                '<div class="text-xs text-red-500">Insufficiente</div>' : ''}
            </div>
          </div>
        `;
        
        // Disabilita se quantità insufficiente per prelievi
        if (data.tipo === 'prelievo' && giacenza.tipo_ubicazione === 'nuova') {
          div.classList.add('opacity-50', 'cursor-not-allowed');
          div.title = 'Non puoi prelevare da una ubicazione vuota';
        } else if (data.tipo === 'prelievo' && giacenza.quantita < quantitaAbs) {
          div.classList.add('opacity-50', 'cursor-not-allowed');
          div.title = 'Quantità insufficiente';
        } else {
          div.onclick = () => selectUbicazione(giacenza.id, div, giacenza.ubicazione);
        }
        
        ubicazioniList.appendChild(div);
      });
      
      modal.style.display = 'flex';
    }
    
    let ubicazioneDestinazioneSelezionata = null;
    
    function selectUbicazione(giacenzaId, element, ubicazione) {
      // Rimuovi selezione precedente
      document.querySelectorAll('.ubicazione-option').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Seleziona nuovo elemento
      element.classList.add('selected');
      ubicazioneSelezionata = giacenzaId;
      ubicazioneDestinazioneSelezionata = ubicazione;
      
      // Abilita pulsante conferma
      document.getElementById('conferma-compensazione').disabled = false;
    }
    
    function confermaCompensazione() {
      if (!ubicazioneSelezionata || !compensazioneData) return;
      
      const data = {
        giacenza_id: compensazioneData.giacenza_id,
        giacenza_compensazione_id: ubicazioneSelezionata,
        form_data: compensazioneData.form_data,
        differenza: compensazioneData.differenza
      };
      
      // Aggiungi ubicazione destinazione se stiamo creando una nuova ubicazione
      if (ubicazioneSelezionata === -1) {
        data.ubicazione_destinazione = ubicazioneDestinazioneSelezionata;
      }
      
      fetch('/conferma_modifica_giacenza', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          window.location.reload();
        } else {
          alert('Errore: ' + result.error);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la conferma');
      });
    }
    
    function closeCompensazioneModal() {
      document.getElementById('compensazione-modal').style.display = 'none';
      compensazioneData = null;
      ubicazioneSelezionata = null;
      ubicazioneDestinazioneSelezionata = null;
    }
    
    // Chiudi modal con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('compensazione-modal');
        if (modal.style.display === 'flex') {
          closeCompensazioneModal();
        } else {
          const activeForm = document.querySelector('.edit-form.active');
          if (activeForm) {
            const id = activeForm.id.replace('edit-form-', '');
            cancelEdit(id);
          }
        }
      }
    });
    
    // Mobile-specific improvements
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM caricato, inizializzo event listeners...');
      
      // Event listeners per pulsanti di modifica desktop
      document.addEventListener('click', function(e) {
        console.log('Click rilevato su:', e.target);
        
        if (e.target.closest('.edit-btn')) {
          console.log('Click su edit-btn rilevato');
          const btn = e.target.closest('.edit-btn');
          const id = btn.dataset.id;
          const ubicazione = btn.dataset.ubicazione;
          const stato = btn.dataset.stato;
          const quantita = btn.dataset.quantita;
          const note = btn.dataset.note;
          console.log('Dati button:', {id, ubicazione, stato, quantita, note});
          editRow(id, ubicazione, stato, quantita, note);
        }
        
        if (e.target.closest('.edit-mobile-btn')) {
          console.log('Click su edit-mobile-btn rilevato');
          const btn = e.target.closest('.edit-mobile-btn');
          const id = btn.dataset.id;
          const ubicazione = btn.dataset.ubicazione;
          const stato = btn.dataset.stato;
          const quantita = btn.dataset.quantita;
          const note = btn.dataset.note;
          console.log('Dati mobile button:', {id, ubicazione, stato, quantita, note});
          editMobileRow(id, ubicazione, stato, quantita, note);
        }
        
        if (e.target.closest('.submit-edit-btn')) {
          console.log('Click su submit-edit-btn rilevato');
          const btn = e.target.closest('.submit-edit-btn');
          const id = btn.dataset.id;
          console.log('Submit edit per ID:', id);
          submitEdit(id);
        }
        
        if (e.target.closest('.submit-mobile-edit-btn')) {
          console.log('Click su submit-mobile-edit-btn rilevato');
          const btn = e.target.closest('.submit-mobile-edit-btn');
          const id = btn.dataset.id;
          console.log('Submit mobile edit per ID:', id);
          submitMobileEdit(id);
        }
        
        if (e.target.closest('.cancel-edit-btn')) {
          console.log('Click su cancel-edit-btn rilevato');
          const btn = e.target.closest('.cancel-edit-btn');
          const id = btn.dataset.id;
          console.log('Cancel edit per ID:', id);
          cancelEdit(id);
        }
        
        if (e.target.closest('.cancel-mobile-edit-btn')) {
          console.log('Click su cancel-mobile-edit-btn rilevato');
          const btn = e.target.closest('.cancel-mobile-edit-btn');
          const id = btn.dataset.id;
          console.log('Cancel mobile edit per ID:', id);
          cancelMobileEdit(id);
        }
        
        if (e.target.closest('.toggle-mobile-action-menu')) {
          const btn = e.target.closest('.toggle-mobile-action-menu');
          const id = btn.dataset.id;
          toggleMobileActionMenu(id);
        }
        
        if (e.target.closest('.edit-mobile-row-btn')) {
          const btn = e.target.closest('.edit-mobile-row-btn');
          const id = btn.dataset.id;
          const ubicazione = btn.dataset.ubicazione;
          const stato = btn.dataset.stato;
          const quantita = btn.dataset.quantita;
          const note = btn.dataset.note;
          editMobileRow(id, ubicazione, stato, quantita, note);
        }
        
        if (e.target.closest('.confirm-mobile-delete-btn')) {
          const btn = e.target.closest('.confirm-mobile-delete-btn');
          const id = btn.dataset.id;
          const productName = btn.dataset.productName;
          confirmMobileDelete(id, productName);
        }
        
        if (e.target.closest('.adjust-mobile-quantity-btn')) {
          const btn = e.target.closest('.adjust-mobile-quantity-btn');
          const id = btn.dataset.id;
          const delta = parseInt(btn.dataset.delta);
          adjustMobileQuantity(id, delta);
        }
        
        if (e.target.closest('.save-mobile-quick-edit-btn')) {
          const btn = e.target.closest('.save-mobile-quick-edit-btn');
          const id = btn.dataset.id;
          saveMobileQuickEdit(id);
        }
        
        if (e.target.closest('.cancel-mobile-quick-edit-btn')) {
          const btn = e.target.closest('.cancel-mobile-quick-edit-btn');
          const id = btn.dataset.id;
          cancelMobileQuickEdit(id);
        }
      });
      
      // Close mobile sidebar when clicking on main content
      document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
          const sidebar = document.querySelector('.mobile-sidebar');
          const hamburger = document.querySelector('.hamburger-menu');
          
          if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            // Close sidebar using Alpine.js
            window.Alpine && window.Alpine.store && window.Alpine.store('sidebarOpen', false);
          }
        }
      });
      
      // Improve touch interactions on mobile
      if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
      }
    });

    // Funzioni per la modifica mobile
    function editMobileRow(id, ubicazione, stato, quantita, note) {
      // Nascondi la vista normale e mostra il form di modifica
      document.getElementById(`mobile-view-${id}`).style.display = 'none';
      document.getElementById(`mobile-edit-${id}`).style.display = 'block';
      
      // Disabilita tutti gli altri pulsanti di modifica mobile
      document.querySelectorAll('[id^="mobile-edit-btn-"]').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });
    }
    
    function cancelMobileEdit(id) {
      // Mostra la vista normale e nascondi il form di modifica
      document.getElementById(`mobile-view-${id}`).style.display = 'block';
      document.getElementById(`mobile-edit-${id}`).style.display = 'none';
      
      // Riabilita tutti i pulsanti di modifica mobile
      document.querySelectorAll('[id^="mobile-edit-btn-"]').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    
    function submitMobileEdit(id) {
      const form = document.getElementById(`mobile-edit-form-${id}`);
      const formData = new FormData(form);
      
      const data = {
        ubicazione: formData.get('ubicazione'),
        stato: formData.get('stato'),
        quantita: formData.get('quantita'),
        note: formData.get('note')
      };
      
      // Invia richiesta di modifica (usa la stessa logica del desktop)
      fetch(`/modifica_giacenza/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      })
      .then(response => {
        if (response.headers.get('content-type')?.includes('application/json')) {
          return response.json();
        } else {
          // Se non è JSON, significa che la modifica è andata a buon fine senza compensazione
          // Aggiorna i valori nella vista mobile
          document.getElementById(`mobile-ubicazione-${id}`).textContent = data.ubicazione || '-';
          
          // Aggiorna il badge dello stato
          const statoElement = document.getElementById(`mobile-stato-${id}`);
          const badgeClass = data.stato === 'ATTIVO' ? 'status-active' : 
                            data.stato === 'IN_ARRIVO' ? 'status-inactive' : 'status-warning';
          statoElement.innerHTML = `<span class="badge ${badgeClass}">${data.stato}</span>`;
          
          // Aggiorna quantità
          document.getElementById(`mobile-quantita-${id}`).innerHTML = 
            `<span class="font-bold text-phg-primary">${data.quantita}</span>`;
          
          // Aggiorna note
          document.getElementById(`mobile-note-display-${id}`).textContent = data.note || '-';
          
          cancelMobileEdit(id);
          showMobileToast('Giacenza modificata!', 'success');
          
          // Ricarica la pagina dopo un breve delay per sincronizzare con il server
          setTimeout(() => window.location.reload(), 1500);
          return;
        }
      })
      .then(responseData => {
        if (responseData && responseData.need_compensation) {
          // Mostra modal di compensazione
          showCompensazioneModal(responseData);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        showMobileToast('Errore durante la modifica', 'error');
      });
    }

    // Gestisci l'escape per annullare la modifica anche su mobile
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('compensazione-modal');
        if (modal.style.display === 'flex') {
          closeCompensazioneModal();
        } else {
          // Controlla se c'è una modifica desktop attiva
          const activeForm = document.querySelector('.edit-form.active');
          if (activeForm) {
            const id = activeForm.id.replace('edit-form-', '');
            cancelEdit(id);
          } else {
            // Controlla se c'è una modifica mobile attiva
            const activeMobileEdit = document.querySelector('[id^="mobile-edit-"]:not([style*="display: none"])');
            if (activeMobileEdit) {
              const id = activeMobileEdit.id.replace('mobile-edit-', '');
              cancelMobileEdit(id);
            }
          }
        }
      }
    });
    
    // Nuove funzioni per azioni mobile rapide
    function toggleMobileQuickEdit(id) {
      const quickEdit = document.getElementById(`mobile-quick-edit-${id}`);
      const isVisible = quickEdit.style.display !== 'none';
      
      // Chiudi tutti gli altri quick edit aperti
      document.querySelectorAll('[id^="mobile-quick-edit-"]').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="mobile-action-menu-"]').forEach(el => {
        el.style.display = 'none';
      });
      
      // Toggle del quick edit corrente
      quickEdit.style.display = isVisible ? 'none' : 'block';
    }
    
    function toggleMobileActionMenu(id) {
      const menu = document.getElementById(`mobile-action-menu-${id}`);
      const isVisible = menu.style.display !== 'none';
      
      // Chiudi tutti gli altri menu aperti
      document.querySelectorAll('[id^="mobile-action-menu-"]').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="mobile-quick-edit-"]').forEach(el => {
        el.style.display = 'none';
      });
      
      // Toggle del menu corrente
      menu.style.display = isVisible ? 'none' : 'block';
    }
    
    function adjustMobileQuantity(id, delta) {
      const input = document.getElementById(`mobile-qty-${id}`);
      const currentValue = parseInt(input.value) || 0;
      const newValue = Math.max(0, currentValue + delta);
      input.value = newValue;
    }
    
    function saveMobileQuickEdit(id) {
      const input = document.getElementById(`mobile-qty-${id}`);
      const newQuantity = parseInt(input.value) || 0;
      
      // Effettua la richiesta AJAX per salvare la nuova quantità
      fetch(`/aggiorna_giacenza_rapida/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          quantita: newQuantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Aggiorna la visualizzazione della quantità
          document.getElementById(`mobile-quantita-${id}`).innerHTML = 
            `<span class="font-bold text-phg-primary">${newQuantity}</span>`;
          cancelMobileQuickEdit(id);
          
          // Mostra feedback positivo
          showMobileToast('Quantità aggiornata!', 'success');
        } else {
          showMobileToast('Errore durante l\'aggiornamento', 'error');
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        showMobileToast('Errore di connessione', 'error');
      });
    }
    
    function cancelMobileQuickEdit(id) {
      document.getElementById(`mobile-quick-edit-${id}`).style.display = 'none';
    }
    
    function confirmMobileDelete(id, productName) {
      if (confirm(`Eliminare la giacenza di "${productName}"?`)) {
        // Invia richiesta di eliminazione
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/elimina_giacenza/${id}`;
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function showMobileToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Chiudi menu quando si clicca fuori
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.mobile-action-menu') && !e.target.closest('[onclick*="toggleMobileActionMenu"]')) {
        document.querySelectorAll('[id^="mobile-action-menu-"]').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      if (!e.target.closest('.mobile-quick-edit') && !e.target.closest('[onclick*="toggleMobileQuickEdit"]')) {
        document.querySelectorAll('[id^="mobile-quick-edit-"]').forEach(el => {
          el.style.display = 'none';
        });
      }
    });
  </script>

  <script>
    // Fallback per il dark mode toggle (index.html) - versione ottimizzata senza transizioni
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded index, localStorage darkMode:', localStorage.getItem('darkMode'));
      console.log('Body classes index:', document.body.classList.toString());
      console.log('DocumentElement classes index:', document.documentElement.classList.toString());
      
      const toggleButton = document.getElementById('dark-mode-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          console.log('Click listener triggered (index)');
          // Verifica lo stato del localStorage dopo il click
          setTimeout(() => {
            const currentMode = localStorage.getItem('darkMode');
            const hasBodyDark = document.body.classList.contains('dark');
            const hasHtmlDark = document.documentElement.classList.contains('dark');
            console.log('Dopo click index - localStorage:', currentMode, 'body.dark:', hasBodyDark, 'html.dark:', hasHtmlDark);
            
            // Se c'è inconsistenza, correggi immediatamente senza transizioni
            if (currentMode === 'true' && (!hasBodyDark || !hasHtmlDark)) {
              console.log('Correzione index: attivando dark mode');
              document.body.classList.add('dark');
              document.documentElement.classList.add('dark');
              document.body.style.backgroundColor = '#000000';
              document.documentElement.style.backgroundColor = '#000000';
            } else if (currentMode === 'false' && (hasBodyDark || hasHtmlDark)) {
              console.log('Correzione index: disattivando dark mode');
              document.body.classList.remove('dark');
              document.documentElement.classList.remove('dark');
              document.body.style.backgroundColor = '';
              document.documentElement.style.backgroundColor = '';
            }
          }, 10);
        });
      }
    });
  </script>
{% endblock %}
