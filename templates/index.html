{% extends "base.html" %}

{% block title %}Gestione Magazzino - Pharmagest{% endblock %}

{% block extra_css %}
<style>
/* Sistema AMOLED dark mode con colori blu come le altre pagine */
:root {
  --bg-primary: rgba(255, 255, 255, 0.95);
  --bg-secondary: rgba(243, 244, 246, 0.9);
  --border-light: rgba(150, 150, 150, 0.25);
  --shadow-light: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
  --accent-color: #0056a6;
  --text-primary: #1e293b;
  --text-secondary: #64748b;
}

.dark {
  --bg-primary: rgba(0, 0, 0, 0.98);
  --bg-secondary: rgba(0, 0, 0, 0.95);
  --border-light: rgba(40, 40, 40, 0.8);
  --shadow-light: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
  --accent-color: #60a5fa;
  --text-primary: #ffffff;
  --text-secondary: #d1d5db;
}

/* Dashboard card icons - ottimizzato con effetti GPU-friendly */
.dashboard-card-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 4.5rem;
  height: 4.5rem;
  border-radius: 50%;
  background: linear-gradient(135deg, #e3f2fd 0%, #00a8e8 100%);
  color: #0056a6;
  font-size: 2.5rem;
  margin-bottom: 1.2rem;
  transition: transform 0.15s ease, opacity 0.15s ease;
  will-change: transform;
}

.glass-card:hover .dashboard-card-icon {
  transform: scale(1.05);
  opacity: 0.9;
}

.dark .dashboard-card-icon {
  background: linear-gradient(135deg, rgba(96, 165, 250, 0.3) 0%, rgba(37, 99, 235, 0.5) 100%);
  color: var(--accent-color);
}

/* Floating buttons - con effetto scale GPU-friendly */
.floating-btn {
  box-shadow: 0 2px 4px rgba(0, 86, 166, 0.2);
  transition: transform 0.15s ease, box-shadow 0.15s ease;
  will-change: transform;
}

.floating-btn:hover {
  box-shadow: 0 4px 8px rgba(0, 86, 166, 0.3);
  transform: translateY(-1px) scale(1.02);
}

.floating-btn:active {
  transform: translateY(0) scale(0.98);
}

.dark .floating-btn {
  box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
  border: 1px solid rgba(96, 165, 250, 0.3);
}

.dark .floating-btn:hover {
  box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
  border-color: rgba(96, 165, 250, 0.5);
}

/* Filter toggle - ottimizzato per performance */
.filter-toggle.active {
  background-color: var(--accent-color);
  color: white;
}

.dark .filter-toggle.active {
  background: linear-gradient(90deg, #1e40af 0%, #2563eb 100%);
}

/* Table row hover - ottimizzato con accenti colorati */
tbody tr {
  transition: background-color 0.15s ease, border-left 0.15s ease;
  border-left: 3px solid transparent;
}

.table-row-hover:hover {
  background: #f0f8ff;
  border-left-color: #0056a6;
}

.dark .table-row-hover:hover {
  background: rgba(0, 0, 0, 0.95);
  border-left-color: #60a5fa;
}

/* Badge styling - con animazione leggera */
.badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 9999px;
  transition: transform 0.15s ease;
}

.badge:hover {
  transform: scale(1.05);
}

@keyframes subtle-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.85; }
}

.status-active .badge:before {
  content: '';
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  margin-right: 4px;
  animation: subtle-pulse 2s ease-in-out infinite;
}

.status-active {
  background-color: #e3f2fd;
  color: #0056a6;
}

.dark .status-active {
  background-color: rgba(96, 165, 250, 0.2);
  color: var(--accent-color);
}

.status-inactive {
  background-color: #fef3c7;
  color: #92400e;
}

.dark .status-inactive {
  background-color: rgba(251, 191, 36, 0.2);
  color: #fbbf24;
}

.status-warning {
  background-color: #fee2e2;
  color: #b91c1c;
}

.dark .status-warning {
  background-color: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

/* Edit forms con animazione */
@keyframes slideDownFadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.edit-form {
  display: none;
}

.edit-form.active {
  display: table-row;
  animation: slideDownFadeIn 0.3s ease forwards;
}

.edit-form.active td {
  animation: slideDownFadeIn 0.3s ease forwards;
}

.edit-input {
  width: 100%;
  padding: 0.375rem 0.75rem;
  border: 1px solid var(--border-light);
  border-radius: 0.375rem;
  font-size: 0.875rem;
  background: var(--bg-primary);
  color: var(--text-primary);
}

.edit-input:focus {
  outline: none;
  border-color: var(--accent-color);
}

.dark .edit-input {
  background: var(--bg-secondary);
  border-color: var(--border-light);
  color: var(--text-primary);
}

.dark .edit-input:focus {
  border-color: var(--accent-color);
}

/* Spazio sotto la topbar (uniforma con altre pagine) */
.main-content-area > .sticky + [x-data] > .px-2.w-full:first-child { padding-top:1.75rem !important; }
@media (max-width: 767px) {
  .main-content-area > .sticky + [x-data] > .px-2.w-full:first-child { padding-top:1.1rem !important; }
}

/* Modal compensazione: stili locali alla pagina */
.modal-overlay {
  position: fixed;
  inset: 0;
  background-color: rgba(0,0,0,0.5);
  display: none; /* default hidden, mostrato via JS */
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
.modal-content {
  background: #ffffff;
  color: #111827;
  border-radius: 12px;
  padding: 24px;
  max-width: 520px;
  width: 92%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 25px rgba(0,0,0,0.2);
}
.ubicazione-option {
  padding: 12px;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  cursor: pointer;
}
.ubicazione-option:hover { border-color: #0056a6; background-color: #f0f8ff; }
.ubicazione-option.selected { border-color: #0056a6; background-color: #e3f2fd; }
.dark .modal-overlay { background-color: rgba(0,0,0,0.7); }
.dark .modal-content { background:#0a0a0a; color:#ffffff; border:1px solid #2a2a2a; box-shadow: 0 12px 28px rgba(0,0,0,0.6); }
.dark #compensazione-descrizione { color: #d1d5db; }
.dark .ubicazione-option { border-color:#2a2a2a; }
.dark .ubicazione-option:hover { background-color:#0f172a; border-color:#2563eb; }
.dark .ubicazione-option.selected { background-color: rgba(37,99,235,0.15); border-color:#3b82f6; }
@supports (padding: max(0px)) { .modal-content { padding-bottom: max(24px, env(safe-area-inset-bottom)); } }

/* Edit form - nascosto di default */
tr.edit-form {
  display: none;
}

tr.edit-form.active {
  display: table-row;
}

/* Mobile responsive */
@media (max-width: 768px) {
  .dashboard-card-icon {
    width: 32px;
    height: 32px;
    font-size: 16px;
    margin-bottom: 8px;
}

/* Mobile responsive - design pulito e coerente */
@media (max-width: 768px) {
  .dashboard-card-icon {
    width: 32px;
    height: 32px;
    font-size: 16px;
    margin-bottom: 8px;
  }
  
  /* Spazio per navbar mobile fissa */
  .px-2.md\\:px-6 {
    padding-bottom: 5rem !important;
  }

  /* Glass cards responsive su mobile - mantengono lo stesso stile pulito */
  .glass-card {
    padding: 1.5rem;
  }

  /* Tabelle responsive su mobile */
  .table-container {
    overflow-x: auto;
  }

  /* Mobile filters styling - coerente con il design */
  .mobile-filters {
    margin-bottom: 2rem; /* Aggiungo spazio dopo i filtri */
  }
  
  .mobile-filters button {
    background: linear-gradient(135deg, #2256a7 0%, #1e4a8c 100%);
    transition: transform 0.15s ease, opacity 0.15s ease;
  }
  
  .mobile-filters button:active {
    transform: scale(0.98);
    opacity: 0.9;
  }
  
  .mobile-filters button:hover {
    background-color: #1e4a8c;
  }

  /* Stats cards su mobile - layout compatto orizzontale */
  .flex.flex-col.md\\:flex-row {
    flex-direction: row !important; /* Forza orizzontale anche su mobile */
    gap: 0.5rem !important; /* Spazio minimo tra cards */
  }

  /* Container stats con override più specifico */
  @media (max-width: 768px) {
    .flex.flex-col.md\\:flex-row.gap-8 {
      flex-direction: row !important;
      gap: 0.5rem !important;
      margin-bottom: 1rem !important;
    }
  }

  /* Stats cards compatte su mobile */
  .glass-card {
    padding: 0.75rem 0.5rem !important; /* Padding molto ridotto */
    text-align: center;
  }

  .dashboard-card-icon {
    width: 24px !important; /* Icone molto piccole */
    height: 24px !important;
    font-size: 12px !important;
    margin: 0 auto 0.25rem auto !important; /* Centrato con margine minimo */
  }

  /* Testo compatto nelle stats */
  .glass-card p {
    font-size: 0.75rem !important; /* Testo molto piccolo */
    margin-bottom: 0.125rem !important;
    line-height: 1.2 !important;
  }

  .glass-card p.text-4xl {
    font-size: 1.5rem !important; /* Numeri più piccoli */
    margin-top: 0.25rem !important;
    font-weight: 700 !important;
  }

  /* Mobile giacenze styling - design pulito e coerente */
  .mobile-giacenza-item {
    background: rgba(255, 255, 255, 0.95);
    border: 1px solid rgba(34, 86, 167, 0.15);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1rem;
  }

  .mobile-giacenza-item:hover {
    border-color: rgba(34, 86, 167, 0.25);
  }

  /* Animazione apertura form mobile */
  @keyframes expandIn {
    from {
      opacity: 0;
      max-height: 0;
      transform: scaleY(0.9);
    }
    to {
      opacity: 1;
      max-height: 500px;
      transform: scaleY(1);
    }
  }

  .mobile-edit-opening {
    animation: expandIn 0.3s ease forwards;
    transform-origin: top;
  }

  .dark .mobile-giacenza-item {
    background: rgba(0, 0, 0, 0.8);
    border-color: rgba(96, 165, 250, 0.15);
  }

  .mobile-giacenza-header {
    border-bottom: 1px solid rgba(34, 86, 167, 0.1);
    padding-bottom: 1rem;
    margin-bottom: 1rem;
  }

  .dark .mobile-giacenza-header {
    border-bottom-color: rgba(96, 165, 250, 0.15);
  }

  .mobile-giacenza-title {
    font-size: 1.125rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
    line-height: 1.3;
  }

  .dark .mobile-giacenza-title {
    color: #f8fafc;
  }

  .mobile-giacenza-code {
    font-size: 0.875rem;
    color: #64748b;
    font-family: 'Monaco', 'Menlo', monospace;
    background: rgba(34, 86, 167, 0.08);
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    display: inline-block;
    font-weight: 600;
  }

  .dark .mobile-giacenza-code {
    color: #94a3b8;
    background: rgba(96, 165, 250, 0.12);
  }

  .mobile-giacenza-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.75rem;
  }

  .mobile-giacenza-detail {
    display: flex;
    flex-direction: column;
  }

  .mobile-giacenza-detail-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: #64748b;
    margin-bottom: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .dark .mobile-giacenza-detail-label {
    color: #94a3b8;
  }

  .mobile-giacenza-detail-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: #1e293b;
  }

  .dark .mobile-giacenza-detail-value {
    color: #f8fafc;
  }

  /* Mobile actions per giacenze */
  .mobile-giacenza-actions {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(34, 86, 167, 0.1);
    display: flex;
    gap: 0.75rem;
  }

  .dark .mobile-giacenza-actions {
    border-top-color: rgba(96, 165, 250, 0.15);
  }

  .mobile-action-btn {
    flex: 1;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.375rem;
  }

  .edit-mobile-btn {
    background: rgba(34, 86, 167, 0.08);
    color: #2256a7;
    border-color: rgba(34, 86, 167, 0.2);
  }

  .edit-mobile-btn:hover {
    background: rgba(34, 86, 167, 0.15);
  }

  .dark .edit-mobile-btn {
    background: rgba(96, 165, 250, 0.15);
    color: #60a5fa;
    border-color: rgba(96, 165, 250, 0.3);
  }

  .mobile-action-btn.delete {
    background: rgba(220, 38, 38, 0.08);
    color: #dc2626;
    border-color: rgba(220, 38, 38, 0.2);
  }

  .mobile-action-btn.delete:hover {
    background: rgba(220, 38, 38, 0.15);
  }

  .dark .mobile-action-btn.delete {
    background: rgba(248, 113, 113, 0.15);
    color: #f87171;
    border-color: rgba(248, 113, 113, 0.3);
  }

  /* Menu a 3 puntini su mobile giacenze */
  .toggle-mobile-action-menu {
    background: rgba(107, 114, 128, 0.8) !important;
    color: white !important;
    border: 1px solid rgba(107, 114, 128, 0.3);
    padding: 0.5rem !important;
    width: 2.5rem;
    height: 2.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .toggle-mobile-action-menu:hover {
    background: rgba(75, 85, 99, 0.9) !important;
  }

  .dark .toggle-mobile-action-menu {
    background: rgba(156, 163, 175, 0.8) !important;
    border-color: rgba(156, 163, 175, 0.3);
  }

  .mobile-action-menu {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid rgba(34, 86, 167, 0.15);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 180px;
    margin-top: 0.25rem;
  }

  .dark .mobile-action-menu {
    background: #1e293b;
    border-color: rgba(96, 165, 250, 0.2);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .mobile-menu-item {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 0.75rem 1rem;
    text-align: left;
    font-size: 0.875rem;
    color: #374151;
    border: none;
    background: none;
  }

  .mobile-menu-item:hover {
    background: rgba(34, 86, 167, 0.08);
    color: #2256a7;
  }

  .mobile-menu-item:first-child {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
  }

  .mobile-menu-item:last-child {
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
  }

  .mobile-menu-item-danger {
    color: #dc2626;
  }

  .mobile-menu-item-danger:hover {
    background: rgba(220, 38, 38, 0.08);
    color: #dc2626;
  }

  .dark .mobile-menu-item {
    color: #d1d5db;
  }

  .dark .mobile-menu-item:hover {
    background: rgba(96, 165, 250, 0.15);
    color: #60a5fa;
  }

  .dark .mobile-menu-item-danger {
    color: #f87171;
  }

  .dark .mobile-menu-item-danger:hover {
    background: rgba(248, 113, 113, 0.15);
    color: #f87171;
  }
}




</style>
{% endblock %}

{% block content %}
<div x-data="{ 
  sidebarOpen: false,
  filtersOpen: false,
  editingRow: null,
  compensazioneData: null,
  ubicazioneSelezionata: null
}">

<div class="px-2 md:px-6 pt-0 pb-4 md:pb-6 w-full page-content index-page">
  <!-- Desktop Stats Cards -->
  <div class="flex flex-col md:flex-row gap-8 mb-8 w-full">
    <div class="glass-card flex-1 rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer hover:scale-[1.02] transition-transform" onclick="openProductsModal()">
      <div class="dashboard-card-icon">
        <i class="fas fa-box-open"></i>
      </div>
      <p class="text-base font-medium text-gray-500 dark:text-gray-400 text-center">Prodotti Totali</p>
      <p class="mt-2 text-4xl font-bold dark:text-blue-300 text-center" style="color: #2256a7;">{{ total_products }}</p>
    </div>
    <a href="{{ url_for('logmovimenti') }}?data_da={{ today_date }}&data_a={{ today_date }}" class="glass-card flex-1 rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer hover:scale-[1.02] transition-transform no-underline">
      <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #e3f2fd 0%, #a7f3d0 100%); color: #059669;">
        <i class="fas fa-exchange-alt"></i>
      </div>
      <p class="text-base font-medium text-gray-500 dark:text-gray-400 text-center">Movimenti Oggi</p>
      <p class="mt-2 text-4xl font-bold dark:text-blue-300 text-center" style="color: #2256a7;">{{ movements_today }}</p>
    </a>
    <!-- Aggiungiamo una terza card per utilizzare meglio lo spazio -->
    <div class="glass-card flex-1 rounded-xl p-8 flex flex-col items-center justify-center cursor-pointer hover:scale-[1.02] transition-transform" onclick="scrollToGiacenze()">
      <div class="dashboard-card-icon" style="background: linear-gradient(135deg, #e3f2fd 0%, #fef3c7 100%); color: #d97706;">
        <i class="fas fa-chart-line"></i>
      </div>
      <p class="text-base font-medium text-gray-500 dark:text-gray-400 text-center">Giacenze Attive</p>
      <p class="mt-2 text-4xl font-bold dark:text-blue-300 text-center" style="color: #2256a7;">{{ giacenze|length if giacenze else 0 }}</p>
    </div>
  </div>

      <!-- Mobile Filters -->
      <div class="md:hidden">
        <div class="mobile-filters">
          <button @click="filtersOpen = !filtersOpen" 
                  class="w-full flex items-center justify-between p-3 text-white rounded-lg" style="background-color: #2256a7;">
            <span class="flex items-center">
              <i class="fas fa-filter mr-2"></i>Filtri
            </span>
            <i class="fas fa-chevron-down" 
               :class="{ 'rotate-180': filtersOpen }"></i>
          </button>
          
          <div x-show="filtersOpen" x-transition class="mt-4 space-y-3">
            <form method="GET" action="{{ url_for('index') }}">
              <div class="space-y-3">
                <input type="text" name="filtro_codice" value="{{ filtro_codice|default('') }}"
                       placeholder="Codice prodotto..." 
                       class="w-full px-3 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-800 dark:border-blue-600 dark:text-white" style="border-color: rgba(34, 86, 167, 0.3);">
                
                <input type="text" name="filtro_nome" value="{{ filtro_nome|default('') }}"
                       placeholder="Nome prodotto..." 
                       class="w-full px-3 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-800 dark:border-blue-600 dark:text-white" style="border-color: rgba(34, 86, 167, 0.3);">
                
                <select name="filtro_stato" class="w-full px-3 py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-800 dark:border-blue-600 dark:text-white" style="border-color: rgba(34, 86, 167, 0.3);">
                  <option value="">-- Tutti gli stati --</option>
                  {% for st in stati_opzioni %}
                    <option value="{{ st }}" {% if filtro_stato == st %}selected{% endif %}>
                      {{ st|format_db_string }}
                    </option>
                  {% endfor %}
                </select>
                
                <div class="flex justify-center">
                  <button type="button" onclick="window.location='{{ url_for('index') }}'"
                          class="w-full py-2 border rounded-lg text-sm bg-blue-25 dark:bg-gray-700 dark:border-blue-600 dark:text-blue-300 hover:bg-blue-50 dark:hover:bg-gray-600" style="border-color: rgba(34, 86, 167, 0.3); color: #2256a7;">
                    <i class="fas fa-undo mr-2"></i>Reset Filtri
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Mobile Quick Actions -->
      <div class="md:hidden mb-4">
        <div class="flex space-x-2 overflow-x-auto pb-2 justify-center">
          <a href="{{ url_for('movimento') }}" 
             class="flex-shrink-0 text-white px-4 py-2 rounded-lg text-sm flex items-center" style="background-color: #2256a7;">
            <i class="fas fa-plus-circle mr-2"></i>Movimento
          </a>
          <a href="{{ url_for('nuovo_prodotto') }}" 
             class="flex-shrink-0 bg-green-600 text-white px-4 py-2 rounded-lg text-sm flex items-center">
            <i class="fas fa-plus mr-2"></i>Prodotto
          </a>
          <a href="{{ url_for('carico_merci') }}" 
             class="flex-shrink-0 text-white px-4 py-2 rounded-lg text-sm flex items-center" style="background-color: #2256a7;">
            <i class="fas fa-arrow-up mr-2"></i>Carico
          </a>
        </div>
      </div>

      <!-- Desktop Filters and Actions -->
      <div class="hidden md:block mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center space-x-2">
            <button id="toggle-filters" class="filter-toggle px-4 py-2 rounded-lg dark:bg-blue-700 dark:hover:bg-blue-800 text-white text-sm font-medium flex items-center" style="background-color: #2256a7;">
              <i class="fas fa-filter mr-2"></i> Filtri
            </button>
          </div>
          <div class="flex space-x-3">
            <form method="get" action="{{ url_for('esporta_magazzino') }}">
              <button type="submit" class="floating-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                <i class="fas fa-file-export mr-2"></i> Esporta TXT
              </button>
            </form>
            <form method="get" action="{{ url_for('esporta_magazzino_xlsx') }}">
              <button type="submit" class="floating-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center">
                <i class="fas fa-file-excel mr-2"></i> Esporta Excel
              </button>
            </form>
            <a href="{{ url_for('nuovo_prodotto') }}" class="floating-btn px-4 py-2 rounded-lg text-sm font-medium flex items-center">
              <i class="fas fa-plus mr-2"></i> Nuovo Prodotto
            </a>
          </div>
        </div>

        <!-- Filters Panel -->
        <div id="filters-container" class="mt-4 glass-card rounded-xl p-6 w-full">
          <form method="GET" action="{{ url_for('index') }}">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-4">
              <!-- Codice Prodotto -->
              <div>
                <label for="filtro_codice" class="block text-sm font-medium text-gray-700 mb-1">Codice Prodotto</label>
                <input type="text" id="filtro_codice" name="filtro_codice" value="{{ filtro_codice|default('') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
              </div>
              
              <!-- Nome Prodotto -->
              <div>
                <label for="filtro_nome" class="block text-sm font-medium text-gray-700 mb-1">Nome Prodotto</label>
                <input type="text" id="filtro_nome" name="filtro_nome" value="{{ filtro_nome|default('') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
              </div>
              
              <!-- Magazzino -->
              <div>
                <label for="filtro_magazzino" class="block text-sm font-medium text-gray-700 mb-1">Magazzino</label>
                <select id="filtro_magazzino" name="filtro_magazzino"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
                  <option value="">-- Tutti --</option>
                  {% for mag in magazzini_opzioni %}
                    <option value="{{ mag }}" {% if filtro_magazzino == mag %}selected{% endif %}>{{ mag|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Stato -->
              <div>
                <label for="filtro_stato" class="block text-sm font-medium text-gray-700 mb-1">Stato</label>
                <select id="filtro_stato" name="filtro_stato"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
                  <option value="">-- Tutti --</option>
                  {% for st in stati_opzioni %}
                    <option value="{{ st }}" {% if filtro_stato == st %}selected{% endif %}>{{ st|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <!-- Ubicazione -->
              <div>
                <label for="filtro_ubicazione" class="block text-sm font-medium text-gray-700 mb-1">Ubicazione</label>
                <select id="filtro_ubicazione" name="filtro_ubicazione"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
                  <option value="">-- Tutte --</option>
                  {% for ub in ubicazioni_opzioni %}
                    <option value="{{ ub }}" {% if filtro_ubicazione == ub %}selected{% endif %}>{{ ub|format_db_string }}</option>
                  {% endfor %}
                </select>
              </div>

              <!-- Note -->
              <div>
                <label for="filtro_note" class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                <input type="text" id="filtro_note" name="filtro_note" value="{{ filtro_note|default('') }}"
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" />
              </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6">
              <button type="button" onclick="window.location='{{ url_for('index') }}'"
                      class="px-6 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2">
                <i class="fas fa-undo mr-2"></i>Reset Filtri
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="desktop-table glass-card rounded-2xl overflow-x-auto w-full hidden md:block">
        <div class="px-6 py-4 border-b dark:bg-gray-800 rounded-t-2xl">
          <div class="flex items-center justify-between">
            <h2 class="text-xl font-semibold">
              <i class="fas fa-boxes mr-2"></i>Stock Campospinoso - Giacenze
            </h2>
            <div class="text-sm text-gray-600 dark:text-gray-400">
              Visualizza tutti i prodotti in magazzino
            </div>
          </div>
        </div>

        {% if giacenze %}
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
              <thead class="bg-gradient-to-r from-gray-50 to-blue-50 dark:from-gray-800 dark:to-gray-700">
                <tr>
                  {% macro sort_link(column, display_name) -%}
                    {%- set asc_order = column + '_asc' -%}
                    {%- set desc_order = column + '_desc' -%}
                    {%- if ordine == asc_order -%}
                      {%- set next_order = desc_order -%}
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer transition-colors duration-200">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=next_order) }}" class="flex items-center group">
                          {{ display_name }} <i class="fas fa-sort-up ml-2"></i>
                        </a>
                      </th>
                    {%- elif ordine == desc_order -%}
                      {%- set next_order = asc_order -%}
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer transition-colors duration-200">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=next_order) }}" class="flex items-center group">
                          {{ display_name }} <i class="fas fa-sort-down ml-2"></i>
                        </a>
                      </th>
                    {%- else -%}
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider cursor-pointer transition-colors duration-200">
                        <a href="{{ url_for('index', filtro_codice=filtro_codice, filtro_nome=filtro_nome, filtro_magazzino=filtro_magazzino, filtro_stato=filtro_stato, filtro_ubicazione=filtro_ubicazione, ordine=asc_order) }}" class="flex items-center group">
                          {{ display_name }} <i class="fas fa-sort ml-2"></i>
                        </a>
                      </th>
                    {%- endif -%}
                  {%- endmacro %}

                  {{ sort_link('codice_prodotto', 'Codice') }}
                  {{ sort_link('nome_prodotto', 'Prodotto') }}
                  {{ sort_link('magazzino', 'Magazzino') }}
                  {{ sort_link('ubicazione', 'Ubicazione') }}
                  {{ sort_link('stato', 'Stato') }}
                  {{ sort_link('quantita', 'Quantità') }}
                  <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Note</th>
                  <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Azioni</th>
                </tr>
              </thead>
              <tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-100 dark:divide-gray-700">
                {% for g in giacenze %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors duration-150" id="row-{{ g.id }}">
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="text-sm font-semibold text-gray-900 dark:text-white">{{ g.codice_prodotto }}</span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">{{ g.nome_prodotto|format_db_string }}</div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                      {{ g.magazzino|format_db_string }}
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400" id="ubicazione-{{ g.id }}">
                    <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>{{ g.ubicazione|format_db_string }}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap" id="stato-{{ g.id }}">
                    {% if g.stato == 'ATTIVO' %}
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" data-state-raw="{{ g.stato|lower }}">
                        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                        {{ g.stato|format_db_string }}
                      </span>
                    {% elif g.stato == 'IN_ARRIVO' %}
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" data-state-raw="{{ g.stato|lower }}">
                        <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                        {{ g.stato|format_db_string }}
                      </span>
                    {% else %}
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" data-state-raw="{{ g.stato|lower }}">
                        <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                        {{ g.stato|format_db_string }}
                      </span>
                    {% endif %}
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap" id="quantita-{{ g.id }}">
                    <span class="text-sm font-bold" style="color: #2256a7;">{{ g.quantita }}</span>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs" id="note-{{ g.id }}">
                    <div class="truncate" title="{{ g.note|format_db_string }}">
                      {% if g.note %}
                        <i class="fas fa-sticky-note mr-2 text-gray-400"></i>{{ g.note|format_db_string }}
                      {% else %}
                        <span class="text-gray-300 dark:text-gray-600 italic">Nessuna nota</span>
                      {% endif %}
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm">
                    <div class="flex space-x-2">
                      <button class="edit-btn inline-flex items-center px-3 py-2 text-xs font-medium rounded-lg text-white transition-all duration-200 hover:shadow-md transform hover:scale-105" 
                              style="background: linear-gradient(135deg, #2256a7, #1e4d96);"
                              data-id="{{ g.id }}" 
                              data-ubicazione="{{ g.ubicazione|default('') }}" 
                              data-stato="{{ g.stato }}" 
                              data-quantita="{{ g.quantita }}" 
                              data-note="{{ g.note|default('') }}"
                              id="edit-btn-{{ g.id }}" title="Modifica giacenza">
                        <i class="fas fa-edit mr-1"></i>Modifica
                      </button>
                      <form method="POST" action="{{ url_for('elimina_giacenza', giacenza_id=g.id) }}" style="display:inline;" onsubmit="return confirm('Sei sicuro di voler eliminare questa giacenza?');">
                        <button type="submit" class="inline-flex items-center px-3 py-2 text-xs font-medium rounded-lg text-white bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 transition-all duration-200 hover:shadow-md transform hover:scale-105" title="Elimina giacenza">
                          <i class="fas fa-trash mr-1"></i>Elimina
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                
                <!-- Form di modifica inline (nascosto di default) -->
                <tr class="edit-form bg-gray-50 dark:bg-gray-800" id="edit-form-{{ g.id }}">
                  <td colspan="8" class="px-6 py-4">
                    <form id="edit-form-{{ g.id }}-form" class="space-y-4">
                      <input type="hidden" name="giacenza_id" value="{{ g.id }}">
                      <input type="hidden" name="quantita_originale" value="{{ g.quantita }}">
                      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Ubicazione</label>
                          <input type="text" name="ubicazione" value="{{ g.ubicazione|default('') }}" 
                                 class="edit-input" placeholder="Ubicazione...">
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Stato</label>
                          <select name="stato" class="edit-input">
                            {% for stato in stati_opzioni %}
                              <option value="{{ stato }}" {% if g.stato == stato %}selected{% endif %}>{{ stato|format_db_string }}</option>
                            {% endfor %}
                          </select>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Quantità</label>
                          <input type="number" name="quantita" value="{{ g.quantita }}" min="0" 
                                 class="edit-input" required>
                        </div>
                        <div>
                          <label class="block text-sm font-medium text-blue-600 dark:text-blue-300 mb-1">Note</label>
                          <input type="text" name="note" value="{{ g.note|default('') }}" 
                                 class="edit-input" placeholder="Note...">
                        </div>
                      </div>
                      <div class="flex justify-end space-x-3 mt-4">
                        <button type="button" class="cancel-edit-btn px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600" data-id="{{ g.id }}">
                          <i class="fas fa-times mr-1"></i>Annulla
                        </button>
                        <button type="button" class="submit-edit-btn px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium" data-id="{{ g.id }}">
                          <i class="fas fa-save mr-1"></i>Salva
                        </button>
                      </div>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
      {% else %}
        <div class="px-6 py-12 text-center">
          <i class="fas fa-box-open text-5xl text-gray-300 mb-4"></i>
          <h3 class="text-lg font-medium text-gray-900">Nessuna giacenza disponibile</h3>
          <p class="mt-1 text-sm text-gray-500">Non ci sono prodotti corrispondenti ai filtri selezionati.</p>
          <button class="mt-4 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium">
            <i class="fas fa-plus-circle mr-2"></i> Aggiungi prodotto
          </button>
        </div>
      {% endif %}
    </div>

      <!-- Mobile Cards View - VISTA MOBILE CON MODIFICA -->
      <div class="mobile-view block md:hidden">
        {% if giacenze %}
          {% for g in giacenze %}
          <div class="mobile-giacenza-item" id="mobile-card-{{ g.id }}">
            <!-- Vista normale mobile -->
            <div id="mobile-view-{{ g.id }}">
              <!-- Header con codice e nome prodotto -->
              <div class="mobile-giacenza-header">
                <div class="mobile-giacenza-title">{{ g.nome_prodotto|format_db_string }}</div>
                <div class="mobile-giacenza-code">{{ g.codice_prodotto }}</div>
              </div>
              
              <!-- Dettagli in griglia -->
              <div class="mobile-giacenza-details">
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Magazzino</div>
                  <div class="mobile-giacenza-detail-value">{{ g.magazzino|format_db_string }}</div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Ubicazione</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-ubicazione-{{ g.id }}">{{ g.ubicazione|format_db_string or '-' }}</div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Stato</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-stato-{{ g.id }}">
                    <span class="badge {% if g.stato == 'ATTIVO' %}status-active{% elif g.stato == 'IN_ARRIVO' %}status-inactive{% else %}status-warning{% endif %}" data-state-raw="{{ g.stato|lower }}">
                      {{ g.stato|format_db_string }}
                    </span>
                  </div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Quantità</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-quantita-{{ g.id }}">
                    <span class="font-bold text-blue-500">{{ g.quantita }}</span>
                  </div>
                </div>
                
                <div class="mobile-giacenza-detail">
                  <div class="mobile-giacenza-detail-label">Note</div>
                  <div class="mobile-giacenza-detail-value" id="mobile-note-display-{{ g.id }}">
                    {{ g.note|format_db_string or '-' }}
                  </div>
                </div>
              </div>
              
              <!-- Azioni rapide mobile -->
              <div class="mobile-giacenza-actions">
                <!-- Pulsante per modifica -->
                <button class="edit-mobile-btn mobile-action-btn" 
                        data-id="{{ g.id }}" 
                        data-ubicazione="{{ g.ubicazione|default('') }}" 
                        data-stato="{{ g.stato }}" 
                        data-quantita="{{ g.quantita }}" 
                        data-note="{{ g.note|default('') }}">
                  <i class="fas fa-edit mr-1"></i>Modifica
                </button>
                
                <!-- Menu a tendina per azioni -->
                <div class="relative">
                  <button class="toggle-mobile-action-menu mobile-action-btn" 
                          data-id="{{ g.id }}"
                          style="background: linear-gradient(135deg, #6b7280, #4b5563); color: white;">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  
                  <!-- Menu azioni nascosto -->
                  <div id="mobile-action-menu-{{ g.id }}" class="mobile-action-menu" style="display: none;">
                    <button class="confirm-mobile-delete-btn mobile-menu-item mobile-menu-item-danger"
                            data-id="{{ g.id }}" 
                            data-product-name="{{ g.nome_prodotto|format_db_string }}">
                      <i class="fas fa-trash mr-2"></i>Elimina
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Modifica rapida quantità (nascosta di default) -->
              <div id="mobile-quick-edit-{{ g.id }}" class="mobile-quick-edit" style="display: none;">
                <div class="flex items-center gap-2 mt-3 p-3 bg-gray-50 rounded-lg">
                  <span class="text-sm font-medium text-gray-600">Quantità:</span>
                  <div class="flex items-center gap-1">
                    <button class="adjust-mobile-quantity-btn quick-qty-btn"
                            data-id="{{ g.id }}" data-delta="-1">
                      <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" id="mobile-qty-{{ g.id }}" value="{{ g.quantita }}" 
                           class="quick-qty-input" min="0">
                    <button class="adjust-mobile-quantity-btn quick-qty-btn"
                            data-id="{{ g.id }}" data-delta="1">
                      <i class="fas fa-plus"></i>
                    </button>
                  </div>
                  <div class="flex gap-1 ml-auto">
                    <button class="save-mobile-quick-edit-btn quick-save-btn" data-id="{{ g.id }}">
                      <i class="fas fa-check"></i>
                    </button>
                    <button class="cancel-mobile-quick-edit-btn quick-cancel-btn" data-id="{{ g.id }}">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Form di modifica mobile (nascosto di default) -->
            <div id="mobile-edit-{{ g.id }}" style="display: none;">
              <div class="mobile-table-header mb-4">
                <i class="fas fa-edit mr-2"></i>Modifica: {{ g.codice_prodotto }}
              </div>
              
              <form id="mobile-edit-form-{{ g.id }}" class="space-y-3">
                <input type="hidden" name="giacenza_id" value="{{ g.id }}">
                <input type="hidden" name="quantita_originale" value="{{ g.quantita }}">
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Ubicazione</label>
                  <input type="text" name="ubicazione" value="{{ g.ubicazione|default('') }}" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" 
                         placeholder="Ubicazione...">
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Stato</label>
                  <select name="stato" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400">
                    {% for stato in stati_opzioni %}
                      <option value="{{ stato }}" {% if g.stato == stato %}selected{% endif %}>{{ stato|format_db_string }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Quantità</label>
                  <input type="number" name="quantita" value="{{ g.quantita }}" min="0" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" 
                         required>
                </div>
                
                <div>
                  <label class="block text-xs font-medium text-blue-600 dark:text-blue-300 mb-1 uppercase">Note</label>
                  <input type="text" name="note" value="{{ g.note|default('') }}" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-blue-400 focus:border-blue-400" 
                         placeholder="Note...">
                </div>
                
                <div class="flex space-x-2 pt-2">
                  <button type="button" class="cancel-mobile-edit-btn flex-1 py-2 px-3 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" data-id="{{ g.id }}">
                    <i class="fas fa-times mr-1"></i>Annulla
                  </button>
                  <button type="button" class="submit-mobile-edit-btn flex-1 py-2 px-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium" data-id="{{ g.id }}">
                    <i class="fas fa-save mr-1"></i>Salva
                  </button>
                </div>
              </form>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-12">
            <i class="fas fa-box-open text-4xl text-gray-300 mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900">Nessuna giacenza</h3>
            <p class="text-sm text-gray-500 mb-4">Non ci sono prodotti corrispondenti ai filtri.</p>
            <a href="{{ url_for('nuovo_prodotto') }}" 
               class="inline-flex items-center px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg">
              <i class="fas fa-plus mr-2"></i>Aggiungi prodotto
            </a>
          </div>
        {% endif %}
      </div>
      
      <!-- Contatore totale giacenze -->
      <div class="mt-4 glass-card rounded-xl p-4 w-full">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900">
              <i class="fas fa-calculator text-blue-600 dark:text-blue-300"></i>
            </div>
            <div>
              <h3 class="text-sm font-medium text-gray-900 dark:text-white">Totale Giacenze Visualizzate</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">Quantità totale dei prodotti filtrati</p>
            </div>
          </div>
          <div class="text-right">
            <div id="total-counter" class="text-2xl font-bold text-blue-600 dark:text-blue-300">0</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">unità</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal per visualizzare tutti i prodotti -->
  <div id="products-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px; max-height: 85vh;">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-300 flex items-center gap-2">
          <i class="fas fa-boxes"></i>
          Prodotti in Magazzino
          <span class="text-sm font-normal text-gray-500 dark:text-gray-400">({{ total_products }})</span>
        </h3>
        <button onclick="closeProductsModal()" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 text-xl">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Barra di ricerca -->
      <div class="mb-4">
        <input type="text" id="modal_search_prodotti" placeholder="Cerca prodotto per nome o codice..." 
               class="w-full px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
               oninput="filterModalProducts()" />
      </div>
      
      <!-- Lista prodotti scrollabile -->
      <div class="overflow-y-auto space-y-2 mb-4" style="max-height: 50vh;" id="modal_prodotti_lista">
        {% if prodotti and prodotti|length > 0 %}
          {% for prodotto in prodotti %}
          <div class="modal-prodotto-item flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border border-gray-200 dark:border-gray-700"
               data-nome="{{ prodotto.nome_prodotto|lower }}" data-codice="{{ prodotto.codice_prodotto|lower }}">
            <div class="flex-1 min-w-0">
              <div class="font-medium text-gray-900 dark:text-white text-sm">{{ prodotto.nome_prodotto|format_db_string }}</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">{{ prodotto.codice_prodotto }}</div>
            </div>
            <div class="ml-3 px-3 py-1 rounded-full text-xs font-bold {% if prodotto.quantita_totale > 0 %}bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300{% else %}bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300{% endif %}">
              {{ prodotto.quantita_totale }} pz
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center text-gray-500 dark:text-gray-400 py-8">
            <i class="fas fa-inbox text-3xl mb-2 opacity-50"></i>
            <p class="text-sm">Nessun prodotto registrato</p>
          </div>
        {% endif %}
      </div>
      
      <!-- Pulsante per andare a nuovo prodotto -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
        <a href="{{ url_for('nuovo_prodotto') }}" 
           class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
          <i class="fas fa-plus"></i>
          Aggiungi Nuovo Prodotto
        </a>
      </div>
    </div>
  </div>

  <!-- Modal per selezione ubicazione compensazione -->
  <div id="compensazione-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-blue-600 dark:text-blue-300 mb-2">
          <i class="fas fa-exchange-alt mr-2"></i>Compensazione Quantità
        </h3>
        <p id="compensazione-descrizione" class="text-gray-600"></p>
      </div>
      
      <div class="mb-6">
        <h4 class="text-md font-medium text-gray-700 mb-3">Seleziona ubicazione per la compensazione:</h4>
        <div id="ubicazioni-list" class="space-y-2">
          <!-- Popolato dinamicamente -->
        </div>
      </div>
      
      <div class="flex justify-end space-x-3">
        <button onclick="closeCompensazioneModal()" 
                class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
          <i class="fas fa-times mr-1"></i>Annulla
        </button>
        <button id="conferma-compensazione" onclick="confermaCompensazione()" 
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium" disabled>
          <i class="fas fa-check mr-1"></i>Conferma
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu (hidden by default) -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white shadow-lg z-10">
    <div class="flex justify-around">
      <a href="{{ url_for('index') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'index' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-boxes text-lg"></i>
        <span class="text-xs mt-1">Magazzino</span>
      </a>
      <a href="{{ url_for('movimento') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'movimento' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-exchange-alt text-lg"></i>
        <span class="text-xs mt-1">Movimento</span>
      </a>
      <a href="{{ url_for('carico_merci') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'carico_merci' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-arrow-up text-lg"></i>
        <span class="text-xs mt-1">Carico</span>
      </a>
      <a href="{{ url_for('scaricomerce') }}" class="flex flex-col items-center p-3 {% if request.endpoint == 'scaricomerce' %}text-blue-500{% else %}text-gray-500{% endif %}">
        <i class="fas fa-arrow-down text-lg"></i>
        <span class="text-xs mt-1">Scarico</span>
      </a>
    </div>
  </div>

  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script>
    // === Funzioni per le card statistiche cliccabili ===
    
    // Apri modal prodotti
    function openProductsModal() {
      const modal = document.getElementById('products-modal');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      // Focus sulla barra di ricerca
      setTimeout(() => {
        document.getElementById('modal_search_prodotti').focus();
      }, 100);
    }
    
    // Chiudi modal prodotti
    function closeProductsModal() {
      const modal = document.getElementById('products-modal');
      modal.style.display = 'none';
      document.body.style.overflow = '';
      // Reset ricerca
      document.getElementById('modal_search_prodotti').value = '';
      filterModalProducts();
    }
    
    // Filtra prodotti nel modal
    function filterModalProducts() {
      const searchTerm = document.getElementById('modal_search_prodotti').value.toLowerCase();
      const items = document.querySelectorAll('.modal-prodotto-item');
      
      items.forEach(item => {
        const nome = item.getAttribute('data-nome') || '';
        const codice = item.getAttribute('data-codice') || '';
        
        if (nome.includes(searchTerm) || codice.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    // Scroll alla sezione giacenze
    function scrollToGiacenze() {
      const giacenzeTable = document.querySelector('.desktop-table');
      if (giacenzeTable) {
        giacenzeTable.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    // Chiudi modal cliccando fuori dal contenuto
    document.addEventListener('click', function(e) {
      const productsModal = document.getElementById('products-modal');
      if (e.target === productsModal) {
        closeProductsModal();
      }
    });
    
    // Chiudi modal con Escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeProductsModal();
      }
    });

    // Toggle filters visibility
    document.getElementById('toggle-filters').addEventListener('click', function() {
      const filtersContainer = document.getElementById('filters-container');
      filtersContainer.classList.toggle('hidden');
      // Rimuoviamo il toggle della classe 'active' che non serve più
    });

    // Add animation to table rows (disabilitato per performance)
    document.querySelectorAll('.table-row-hover').forEach(row => {
      // Hover effects disabilitati per migliorare performance dark mode
    });

    // Aggiungi effetto di entrata alle stats cards
    document.addEventListener('DOMContentLoaded', () => {
      const cards = document.querySelectorAll('.glass-card');
      cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(10px)';
        setTimeout(() => {
          card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
          card.style.opacity = '1';
          card.style.transform = 'translateY(0)';
        }, 50 * index);
      });
    });

    // Simulate loading for demo purposes
    setTimeout(() => {
      document.querySelectorAll('.animate-pulse').forEach(el => {
        el.classList.remove('animate-pulse');
      });
      // Calcola il totale iniziale dopo il caricamento
      updateTotalCounter();
    }, 2000);

    // Funzione per calcolare e aggiornare il contatore totale
    function updateTotalCounter() {
      let total = 0;
      
      // Calcola solo per la vista desktop (con classi Tailwind hidden/block)
      const desktopTable = document.querySelector('.desktop-table');
      if (desktopTable && window.getComputedStyle(desktopTable).display !== 'none') {
        const desktopRows = document.querySelectorAll('.desktop-table tbody tr[id^="row-"]');
        desktopRows.forEach(row => {
          // Controlla se la riga è visibile (non nascosta dai filtri)
          if (window.getComputedStyle(row).display !== 'none') {
            const quantitaCell = row.querySelector('td[id^="quantita-"] span');
            if (quantitaCell) {
              const quantita = parseInt(quantitaCell.textContent.trim()) || 0;
              total += quantita;
            }
          }
        });
      }
      
      // Calcola solo per la vista mobile (con classi Tailwind hidden/block)  
      const mobileView = document.querySelector('.mobile-view');
      if (mobileView && window.getComputedStyle(mobileView).display !== 'none') {
        const mobileCards = document.querySelectorAll('.mobile-giacenza-item');
        mobileCards.forEach(card => {
          // Controlla se la card è visibile (non nascosta dai filtri)
          if (window.getComputedStyle(card).display !== 'none') {
            const quantitaElement = card.querySelector('div[id^="mobile-quantita-"] span.font-bold');
            if (quantitaElement) {
              const quantita = parseInt(quantitaElement.textContent.trim()) || 0;
              total += quantita;
            }
          }
        });
      }
      
      // Aggiorna il contatore
      const counter = document.getElementById('total-counter');
      if (counter) {
        counter.textContent = total.toLocaleString('it-IT');
      }
    }

    // Osserva i cambiamenti nella tabella per aggiornare il contatore
    function observeTableChanges() {
      const tableContainer = document.querySelector('.desktop-table');
      const mobileContainer = document.querySelector('.mobile-view');
      
      if (tableContainer || mobileContainer) {
        // Usa MutationObserver per rilevare cambiamenti nel DOM
        const observer = new MutationObserver(() => {
          updateTotalCounter();
        });
        
        // Osserva cambiamenti nei contenitori delle giacenze
        if (tableContainer) {
          observer.observe(tableContainer, { 
            childList: true, 
            subtree: true, 
            attributes: true, 
            attributeFilter: ['style'] 
          });
        }
        
        if (mobileContainer) {
          observer.observe(mobileContainer, { 
            childList: true, 
            subtree: true, 
            attributes: true, 
            attributeFilter: ['style'] 
          });
        }
      }
    }

    // Funzione per filtrare la tabella in tempo reale
    function filterTable() {
      const filtroCodice = document.getElementById('filtro_codice')?.value.toLowerCase().trim() || '';
      const filtroNome = document.getElementById('filtro_nome')?.value.toLowerCase().trim() || '';
      const filtroMagazzino = document.getElementById('filtro_magazzino')?.value.toLowerCase().trim() || '';
      const filtroStato = document.getElementById('filtro_stato')?.value.toLowerCase().trim() || '';
      const filtroUbicazione = document.getElementById('filtro_ubicazione')?.value.toLowerCase().trim() || '';
      const filtroNote = document.getElementById('filtro_note')?.value.toLowerCase().trim() || '';
      
      // Filtra righe desktop
      const desktopRows = document.querySelectorAll('.desktop-table tbody tr[id^="row-"]');
      const normalizedFiltroStato = filtroStato.replace(/\s+/g, '_');
      desktopRows.forEach(row => {
        const codice = row.querySelector('td:nth-child(1) span')?.textContent.toLowerCase() || '';
        const nome = row.querySelector('td:nth-child(2) div')?.textContent.toLowerCase() || '';
        const magazzino = row.querySelector('td:nth-child(3) span')?.textContent.toLowerCase() || '';
        const ubicazione = row.querySelector('td:nth-child(4)')?.textContent.toLowerCase() || '';
        const statoElement = row.querySelector('td:nth-child(5) span');
        const statoRaw = statoElement?.dataset.stateRaw || '';
        const statoDisplay = statoElement?.textContent.toLowerCase() || '';
        const stato = statoRaw ? statoRaw.toLowerCase() : statoDisplay;
        const note = row.querySelector('td:nth-child(7) div')?.textContent.toLowerCase() || '';
        
        const matchCodice = !filtroCodice || codice.includes(filtroCodice);
        const matchNome = !filtroNome || nome.includes(filtroNome);
        const matchMagazzino = !filtroMagazzino || magazzino.includes(filtroMagazzino);
        const matchStato = !normalizedFiltroStato || stato.includes(normalizedFiltroStato);
        const matchUbicazione = !filtroUbicazione || ubicazione.includes(filtroUbicazione);
        const matchNote = !filtroNote || note.includes(filtroNote);
        
        const editForm = document.getElementById('edit-form-' + row.id.replace('row-', ''));
        
        if (matchCodice && matchNome && matchMagazzino && matchStato && matchUbicazione && matchNote) {
          row.style.display = '';
          // Mostra anche il form di edit se è attivo
          if (editForm && editForm.classList.contains('active')) {
            editForm.style.display = '';
          }
        } else {
          // Se la riga non matcha il filtro, nascondi sia riga che form
          row.style.display = 'none';
          if (editForm) {
            editForm.style.display = 'none';
            // Se il form era attivo, chiudilo
            if (editForm.classList.contains('active')) {
              const rowId = row.id.replace('row-', '');
              cancelEdit(rowId);
            }
          }
        }
      });
      
      // Filtra card mobile
      const mobileCards = document.querySelectorAll('.mobile-giacenza-item');
      mobileCards.forEach(card => {
        const cardId = card.id.replace('mobile-card-', '');
        const codice = card.querySelector('.mobile-giacenza-code')?.textContent.toLowerCase() || '';
        const nome = card.querySelector('.mobile-giacenza-title')?.textContent.toLowerCase() || '';
        const magazzino = card.querySelector('.mobile-giacenza-detail-value')?.textContent.toLowerCase() || '';
        const ubicazione = document.getElementById('mobile-ubicazione-' + cardId)?.textContent.toLowerCase() || '';
        const statoElement = document.getElementById('mobile-stato-' + cardId)?.querySelector('span');
        const statoRaw = statoElement?.dataset.stateRaw || '';
        const statoDisplay = statoElement?.textContent.toLowerCase() || '';
        const stato = statoRaw ? statoRaw.toLowerCase() : statoDisplay;
        const note = document.getElementById('mobile-note-display-' + cardId)?.textContent.toLowerCase() || '';
        
        const matchCodice = !filtroCodice || codice.includes(filtroCodice);
        const matchNome = !filtroNome || nome.includes(filtroNome);
        const matchMagazzino = !filtroMagazzino || magazzino.includes(filtroMagazzino);
        const matchStato = !normalizedFiltroStato || stato.includes(normalizedFiltroStato);
        const matchUbicazione = !filtroUbicazione || ubicazione.includes(filtroUbicazione);
        const matchNote = !filtroNote || note.includes(filtroNote);
        
        if (matchCodice && matchNome && matchMagazzino && matchStato && matchUbicazione && matchNote) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
      
      // Aggiorna il contatore dopo il filtro
      updateTotalCounter();
    }

    // Aggiungi event listeners ai campi filtro per filtraggio real-time
    document.addEventListener('DOMContentLoaded', () => {
      // Desktop filters
      const desktopFilters = ['filtro_codice', 'filtro_nome', 'filtro_magazzino', 'filtro_stato', 'filtro_ubicazione', 'filtro_note'];
      desktopFilters.forEach(filterId => {
        const filterElement = document.getElementById(filterId);
        if (filterElement) {
          if (filterElement.tagName === 'SELECT') {
            filterElement.addEventListener('change', filterTable);
          } else {
            filterElement.addEventListener('input', filterTable);
          }
        }
      });
      
      // Mobile filters - trova i campi nel form mobile
      const mobileForm = document.querySelector('.mobile-filters form');
      if (mobileForm) {
        const mobileInputs = mobileForm.querySelectorAll('input[name^="filtro_"], select[name^="filtro_"]');
        mobileInputs.forEach(input => {
          if (input.tagName === 'SELECT') {
            input.addEventListener('change', () => {
              // Sincronizza con desktop e filtra
              const name = input.name;
              const desktopInput = document.getElementById(name);
              if (desktopInput) {
                desktopInput.value = input.value;
              }
              filterTable();
            });
          } else {
            input.addEventListener('input', () => {
              // Sincronizza con desktop e filtra
              const name = input.name;
              const desktopInput = document.getElementById(name);
              if (desktopInput) {
                desktopInput.value = input.value;
              }
              filterTable();
            });
          }
        });
      }
    });

    // Inizializza l'osservatore quando la pagina è caricata
    document.addEventListener('DOMContentLoaded', () => {
      updateTotalCounter();
      observeTableChanges();
    });

    // Aggiorna il contatore anche al resize della finestra (cambio desktop/mobile)
    window.addEventListener('resize', () => {
      setTimeout(updateTotalCounter, 100);
    });

    // Aggiorna il contatore anche quando vengono applicati i filtri
    // (intercetta le submit del form filtri)
    const filterForm = document.querySelector('form[method="GET"]');
    if (filterForm) {
      filterForm.addEventListener('submit', () => {
        // Aggiungi un piccolo ritardo per permettere al DOM di aggiornarsi
        setTimeout(updateTotalCounter, 100);
      });
    }

    // Funzione per attivare la modalità modifica con animazione
    function editRow(id, ubicazione, stato, quantita, note) {
      const row = document.getElementById(`row-${id}`);
      const editForm = document.getElementById(`edit-form-${id}`);
      
      // Fade out della riga normale
      row.style.transition = 'opacity 0.15s ease';
      row.style.opacity = '0';
      
      setTimeout(() => {
        // Nascondi la riga normale e mostra il form di modifica
        row.style.display = 'none';
        editForm.classList.add('active');
        editForm.style.display = ''; // Forza visualizzazione anche con filtri attivi
        
        // Scroll smooth verso il form
        setTimeout(() => {
          editForm.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }, 150);
      
      // Disabilita tutti gli altri pulsanti di modifica
      document.querySelectorAll('[id^="edit-btn-"]').forEach(btn => {
        btn.disabled = true;
        btn.classList.add('opacity-50', 'cursor-not-allowed');
      });
    }
    
    // Funzione per annullare la modifica con animazione
    function cancelEdit(id) {
      const row = document.getElementById(`row-${id}`);
      const editForm = document.getElementById(`edit-form-${id}`);
      
      // Fade out del form
      editForm.style.transition = 'opacity 0.15s ease';
      editForm.style.opacity = '0';
      
      setTimeout(() => {
        // Nascondi il form e mostra la riga normale
        editForm.classList.remove('active');
        editForm.style.opacity = '';
        editForm.style.transition = '';
        
        row.style.display = 'table-row';
        row.style.opacity = '0';
        row.style.transition = 'opacity 0.2s ease';
        
        setTimeout(() => {
          row.style.opacity = '1';
        }, 10);
      }, 150);
      
      // Riabilita tutti i pulsanti di modifica
      document.querySelectorAll('[id^="edit-btn-"]').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    
    // Gestisci l'escape per annullare la modifica
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const activeForm = document.querySelector('.edit-form.active');
        if (activeForm) {
          const id = activeForm.id.replace('edit-form-', '');
          cancelEdit(id);
        }
      }
    });

    let compensazioneData = null;
    let ubicazioneSelezionata = null;

    // Funzione per sottomettere la modifica
    function submitEdit(id) {
      console.log('submitEdit chiamato con id:', id);
      const form = document.getElementById(`edit-form-${id}-form`);
      console.log('Form trovato:', form);
      if (!form) {
        console.error('Form non trovato! ID cercato: edit-form-' + id + '-form');
        alert('Errore: form di modifica non trovato');
        return;
      }
      const formData = new FormData(form);
      
      const data = {
        ubicazione: formData.get('ubicazione'),
        stato: formData.get('stato'),
        quantita: formData.get('quantita'),
        note: formData.get('note')
      };
      console.log('Dati da inviare:', data);
      
      // Invia richiesta di modifica
      fetch(`/modifica_giacenza/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      })
      .then(response => {
        console.log('Response status:', response.status);
        const contentType = response.headers.get('content-type');
        console.log('Content-Type:', contentType);
        
        return response.text().then(text => {
          console.log('Response body preview:', text.substring(0, 200));
          
          if (contentType?.includes('application/json')) {
            return JSON.parse(text);
          } else {
            // Redirect normale - ricarica la pagina
            window.location.reload();
            return null;
          }
        });
      })
      .then(data => {
        console.log('Data ricevuta:', data);
        if (data && data.error) {
          // Errore dal server - mostra messaggio e NON refreshare
          alert(data.message);
        } else if (data && data.need_compensation) {
          // Mostra modal di compensazione
          showCompensazioneModal(data);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la modifica');
      });
    }
    
    function showCompensazioneModal(data) {
      compensazioneData = data;
      ubicazioneSelezionata = null;
      
      const modal = document.getElementById('compensazione-modal');
      const descrizione = document.getElementById('compensazione-descrizione');
      const ubicazioniList = document.getElementById('ubicazioni-list');
      
      // Aggiorna descrizione
      const tipoOperazione = data.tipo === 'prelievo' ? 'prelevare' : 'restituire';
      const quantitaAbs = Math.abs(data.differenza);
      descrizione.textContent = `Devi ${tipoOperazione} ${quantitaAbs} unità di "${data.prodotto_nome}". Seleziona l'ubicazione:`;
      
      // Popola lista ubicazioni
      ubicazioniList.innerHTML = '';
      data.giacenze_disponibili.forEach(giacenza => {
        const div = document.createElement('div');
        div.className = 'ubicazione-option';
        div.dataset.giacenzaId = giacenza.id;
        div.dataset.ubicazione = giacenza.ubicazione;
        div.innerHTML = `
          <div class="flex justify-between items-center">
            <div>
              <div class="font-medium">${giacenza.ubicazione}</div>
              <div class="text-sm text-gray-500">
                ${giacenza.magazzino}
                ${giacenza.tipo_ubicazione === 'nuova' ? 
                  '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded ml-2">Nuova ubicazione</span>' : ''}
              </div>
            </div>
            <div class="text-right">
              <div class="font-medium">
                ${giacenza.tipo_ubicazione === 'nuova' ? 
                  'Vuota' : 
                  `Qtà: ${giacenza.quantita}`}
              </div>
              ${data.tipo === 'prelievo' && giacenza.quantita < quantitaAbs ? 
                '<div class="text-xs text-red-500">Insufficiente</div>' : ''}
            </div>
          </div>
        `;
        
        // Disabilita se quantità insufficiente per prelievi
        if (data.tipo === 'prelievo' && giacenza.tipo_ubicazione === 'nuova') {
          div.classList.add('opacity-50', 'cursor-not-allowed');
          div.title = 'Non puoi prelevare da una ubicazione vuota';
        } else if (data.tipo === 'prelievo' && giacenza.quantita < quantitaAbs) {
          div.classList.add('opacity-50', 'cursor-not-allowed');
          div.title = 'Quantità insufficiente';
        } else {
          div.onclick = () => selectUbicazione(giacenza.id, div, giacenza.ubicazione);
        }
        
        ubicazioniList.appendChild(div);
      });
      
      modal.style.display = 'flex';
    }
    
    let ubicazioneDestinazioneSelezionata = null;
    
    function selectUbicazione(giacenzaId, element, ubicazione) {
      // Rimuovi selezione precedente
      document.querySelectorAll('.ubicazione-option').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Seleziona nuovo elemento
      element.classList.add('selected');
      ubicazioneSelezionata = giacenzaId;
      ubicazioneDestinazioneSelezionata = ubicazione;
      
      // Abilita pulsante conferma
      document.getElementById('conferma-compensazione').disabled = false;
    }
    
    function confermaCompensazione() {
      if (!ubicazioneSelezionata || !compensazioneData) return;
      
      const data = {
        giacenza_id: compensazioneData.giacenza_id,
        giacenza_compensazione_id: ubicazioneSelezionata,
        form_data: compensazioneData.form_data,
        differenza: compensazioneData.differenza
      };
      
      // Aggiungi ubicazione destinazione se stiamo creando una nuova ubicazione
      if (ubicazioneSelezionata === -1) {
        data.ubicazione_destinazione = ubicazioneDestinazioneSelezionata;
      }
      
      fetch('/conferma_modifica_giacenza', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          window.location.reload();
        } else {
          alert('Errore: ' + result.error);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        alert('Errore durante la conferma');
      });
    }
    
    function closeCompensazioneModal() {
      document.getElementById('compensazione-modal').style.display = 'none';
      compensazioneData = null;
      ubicazioneSelezionata = null;
      ubicazioneDestinazioneSelezionata = null;
    }
    
    // Chiudi modal con ESC
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('compensazione-modal');
        if (modal.style.display === 'flex') {
          closeCompensazioneModal();
        } else {
          const activeForm = document.querySelector('.edit-form.active');
          if (activeForm) {
            const id = activeForm.id.replace('edit-form-', '');
            cancelEdit(id);
          }
        }
      }
    });
    
    // Mobile-specific improvements
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM caricato, inizializzo event listeners...');
      
      // Event listeners per pulsanti di modifica desktop
      document.addEventListener('click', function(e) {
        console.log('Click rilevato su:', e.target);
        
        if (e.target.closest('.edit-btn')) {
          console.log('Click su edit-btn rilevato');
          const btn = e.target.closest('.edit-btn');
          const id = btn.dataset.id;
          const ubicazione = btn.dataset.ubicazione;
          const stato = btn.dataset.stato;
          const quantita = btn.dataset.quantita;
          const note = btn.dataset.note;
          console.log('Dati button:', {id, ubicazione, stato, quantita, note});
          editRow(id, ubicazione, stato, quantita, note);
        }
        
        if (e.target.closest('.edit-mobile-btn')) {
          console.log('Click su edit-mobile-btn rilevato');
          const btn = e.target.closest('.edit-mobile-btn');
          const id = btn.dataset.id;
          const ubicazione = btn.dataset.ubicazione;
          const stato = btn.dataset.stato;
          const quantita = btn.dataset.quantita;
          const note = btn.dataset.note;
          console.log('Dati mobile button:', {id, ubicazione, stato, quantita, note});
          editMobileRow(id, ubicazione, stato, quantita, note);
        }
        
        if (e.target.closest('.submit-edit-btn')) {
          console.log('Click su submit-edit-btn rilevato');
          const btn = e.target.closest('.submit-edit-btn');
          const id = btn.dataset.id;
          console.log('Submit edit per ID:', id);
          submitEdit(id);
        }
        
        if (e.target.closest('.submit-mobile-edit-btn')) {
          console.log('Click su submit-mobile-edit-btn rilevato');
          const btn = e.target.closest('.submit-mobile-edit-btn');
          const id = btn.dataset.id;
          console.log('Submit mobile edit per ID:', id);
          submitMobileEdit(id);
        }
        
        if (e.target.closest('.cancel-edit-btn')) {
          console.log('Click su cancel-edit-btn rilevato');
          const btn = e.target.closest('.cancel-edit-btn');
          const id = btn.dataset.id;
          console.log('Cancel edit per ID:', id);
          cancelEdit(id);
        }
        
        if (e.target.closest('.cancel-mobile-edit-btn')) {
          console.log('Click su cancel-mobile-edit-btn rilevato');
          const btn = e.target.closest('.cancel-mobile-edit-btn');
          const id = btn.dataset.id;
          console.log('Cancel mobile edit per ID:', id);
          cancelMobileEdit(id);
        }
        
        if (e.target.closest('.toggle-mobile-action-menu')) {
          const btn = e.target.closest('.toggle-mobile-action-menu');
          const id = btn.dataset.id;
          toggleMobileActionMenu(id);
        }
        
        if (e.target.closest('.confirm-mobile-delete-btn')) {
          const btn = e.target.closest('.confirm-mobile-delete-btn');
          const id = btn.dataset.id;
          const productName = btn.dataset.productName;
          confirmMobileDelete(id, productName);
        }
        
        if (e.target.closest('.adjust-mobile-quantity-btn')) {
          const btn = e.target.closest('.adjust-mobile-quantity-btn');
          const id = btn.dataset.id;
          const delta = parseInt(btn.dataset.delta);
          adjustMobileQuantity(id, delta);
        }
        
        if (e.target.closest('.save-mobile-quick-edit-btn')) {
          const btn = e.target.closest('.save-mobile-quick-edit-btn');
          const id = btn.dataset.id;
          saveMobileQuickEdit(id);
        }
        
        if (e.target.closest('.cancel-mobile-quick-edit-btn')) {
          const btn = e.target.closest('.cancel-mobile-quick-edit-btn');
          const id = btn.dataset.id;
          cancelMobileQuickEdit(id);
        }
      });
      
      // Close mobile sidebar when clicking on main content
      document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
          const sidebar = document.querySelector('.mobile-sidebar');
          const hamburger = document.querySelector('.hamburger-menu');
          
          if (!sidebar.contains(e.target) && !hamburger.contains(e.target)) {
            // Close sidebar using Alpine.js
            window.Alpine && window.Alpine.store && window.Alpine.store('sidebarOpen', false);
          }
        }
      });
      
      // Improve touch interactions on mobile
      if ('ontouchstart' in window) {
        document.body.classList.add('touch-device');
      }
    });

    // Funzione helper per animare apertura mobile
    function editMobileRow(id, ubicazione, stato, quantita, note) {
      const viewElement = document.getElementById(`mobile-view-${id}`);
      const editElement = document.getElementById(`mobile-edit-${id}`);
      
      // Fade out vista normale
      viewElement.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
      viewElement.style.opacity = '0';
      viewElement.style.transform = 'translateX(-10px)';
      
      setTimeout(() => {
        viewElement.style.display = 'none';
        editElement.style.display = 'block';
        editElement.classList.add('mobile-edit-opening');
        
        // Scroll smooth verso il form
        setTimeout(() => {
          editElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }, 150);
    }
    
    // Funzioni per la modifica mobile
    function cancelMobileEdit(id) {
      const viewElement = document.getElementById(`mobile-view-${id}`);
      const editElement = document.getElementById(`mobile-edit-${id}`);
      
      // Fade out form
      editElement.style.transition = 'opacity 0.15s ease, transform 0.15s ease';
      editElement.style.opacity = '0';
      editElement.style.transform = 'translateX(10px)';
      
      setTimeout(() => {
        editElement.style.display = 'none';
        editElement.classList.remove('mobile-edit-opening');
        editElement.style.opacity = '';
        editElement.style.transform = '';
        editElement.style.transition = '';
        
        viewElement.style.display = 'block';
        viewElement.style.opacity = '0';
        viewElement.style.transform = 'translateX(10px)';
        
        setTimeout(() => {
          viewElement.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
          viewElement.style.opacity = '1';
          viewElement.style.transform = 'translateX(0)';
        }, 10);
      }, 150);
      
      // Riabilita tutti i pulsanti di modifica mobile
      document.querySelectorAll('[id^="mobile-edit-btn-"]').forEach(btn => {
        btn.disabled = false;
        btn.classList.remove('opacity-50', 'cursor-not-allowed');
      });
    }
    
    function submitMobileEdit(id) {
      const form = document.getElementById(`mobile-edit-form-${id}`);
      const formData = new FormData(form);
      
      const data = {
        ubicazione: formData.get('ubicazione'),
        stato: formData.get('stato'),
        quantita: formData.get('quantita'),
        note: formData.get('note')
      };
      
      // Invia richiesta di modifica (usa la stessa logica del desktop)
      fetch(`/modifica_giacenza/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(data)
      })
      .then(response => {
        if (response.headers.get('content-type')?.includes('application/json')) {
          return response.json();
        } else {
          // Se non è JSON, significa che la modifica è andata a buon fine senza compensazione
          // Aggiorna i valori nella vista mobile
          document.getElementById(`mobile-ubicazione-${id}`).textContent = data.ubicazione || '-';
          
          // Aggiorna il badge dello stato
          const statoElement = document.getElementById(`mobile-stato-${id}`);
          const badgeClass = data.stato === 'ATTIVO' ? 'status-active' : 
                            data.stato === 'IN_ARRIVO' ? 'status-inactive' : 'status-warning';
          statoElement.innerHTML = `<span class="badge ${badgeClass}">${data.stato}</span>`;
          
          // Aggiorna quantità
          document.getElementById(`mobile-quantita-${id}`).innerHTML = 
            `<span class="font-bold text-phg-primary">${data.quantita}</span>`;
          
          // Aggiorna note
          document.getElementById(`mobile-note-display-${id}`).textContent = data.note || '-';
          
          cancelMobileEdit(id);
          showMobileToast('Giacenza modificata!', 'success');
          
          // Ricarica la pagina dopo un breve delay per sincronizzare con il server
          setTimeout(() => window.location.reload(), 1500);
          return;
        }
      })
      .then(responseData => {
        if (responseData && responseData.error) {
          // Errore dal server
          showMobileToast(responseData.message, 'error');
        } else if (responseData && responseData.need_compensation) {
          // Mostra modal di compensazione
          showCompensazioneModal(responseData);
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        showMobileToast('Errore durante la modifica', 'error');
      });
    }

    // Gestisci l'escape per annullare la modifica anche su mobile
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('compensazione-modal');
        if (modal.style.display === 'flex') {
          closeCompensazioneModal();
        } else {
          // Controlla se c'è una modifica desktop attiva
          const activeForm = document.querySelector('.edit-form.active');
          if (activeForm) {
            const id = activeForm.id.replace('edit-form-', '');
            cancelEdit(id);
          } else {
            // Controlla se c'è una modifica mobile attiva
            const activeMobileEdit = document.querySelector('[id^="mobile-edit-"]:not([style*="display: none"])');
            if (activeMobileEdit) {
              const id = activeMobileEdit.id.replace('mobile-edit-', '');
              cancelMobileEdit(id);
            }
          }
        }
      }
    });
    
    // Nuove funzioni per azioni mobile rapide
    function toggleMobileQuickEdit(id) {
      const quickEdit = document.getElementById(`mobile-quick-edit-${id}`);
      const isVisible = quickEdit.style.display !== 'none';
      
      // Chiudi tutti gli altri quick edit aperti
      document.querySelectorAll('[id^="mobile-quick-edit-"]').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="mobile-action-menu-"]').forEach(el => {
        el.style.display = 'none';
      });
      
      // Toggle del quick edit corrente
      quickEdit.style.display = isVisible ? 'none' : 'block';
    }
    
    function toggleMobileActionMenu(id) {
      const menu = document.getElementById(`mobile-action-menu-${id}`);
      const isVisible = menu.style.display !== 'none';
      
      // Chiudi tutti gli altri menu aperti
      document.querySelectorAll('[id^="mobile-action-menu-"]').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="mobile-quick-edit-"]').forEach(el => {
        el.style.display = 'none';
      });
      
      // Toggle del menu corrente
      menu.style.display = isVisible ? 'none' : 'block';
    }
    
    function adjustMobileQuantity(id, delta) {
      const input = document.getElementById(`mobile-qty-${id}`);
      const currentValue = parseInt(input.value) || 0;
      const newValue = Math.max(0, currentValue + delta);
      input.value = newValue;
    }
    
    function saveMobileQuickEdit(id) {
      const input = document.getElementById(`mobile-qty-${id}`);
      const newQuantity = parseInt(input.value) || 0;
      
      // Effettua la richiesta AJAX per salvare la nuova quantità
      fetch(`/aggiorna_giacenza_rapida/${id}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          quantita: newQuantity
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Aggiorna la visualizzazione della quantità
          document.getElementById(`mobile-quantita-${id}`).innerHTML = 
            `<span class="font-bold text-phg-primary">${newQuantity}</span>`;
          cancelMobileQuickEdit(id);
          
          // Mostra feedback positivo
          showMobileToast('Quantità aggiornata!', 'success');
        } else {
          showMobileToast('Errore durante l\'aggiornamento', 'error');
        }
      })
      .catch(error => {
        console.error('Errore:', error);
        showMobileToast('Errore di connessione', 'error');
      });
    }
    
    function cancelMobileQuickEdit(id) {
      document.getElementById(`mobile-quick-edit-${id}`).style.display = 'none';
    }
    
    function confirmMobileDelete(id, productName) {
      if (confirm(`Eliminare la giacenza di "${productName}"?`)) {
        // Invia richiesta di eliminazione
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/elimina_giacenza/${id}`;
        document.body.appendChild(form);
        form.submit();
      }
    }
    
    function showMobileToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white text-sm font-medium ${
        type === 'success' ? 'bg-green-500' : 
        type === 'error' ? 'bg-red-500' : 'bg-blue-500'
      }`;
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Chiudi menu quando si clicca fuori
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.mobile-action-menu') && !e.target.closest('[onclick*="toggleMobileActionMenu"]')) {
        document.querySelectorAll('[id^="mobile-action-menu-"]').forEach(el => {
          el.style.display = 'none';
        });
      }
      
      if (!e.target.closest('.mobile-quick-edit') && !e.target.closest('[onclick*="toggleMobileQuickEdit"]')) {
        document.querySelectorAll('[id^="mobile-quick-edit-"]').forEach(el => {
          el.style.display = 'none';
        });
      }
    });
  </script>

  <script>
    // Fallback per il dark mode toggle (index.html) - versione ottimizzata senza transizioni
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded index, localStorage darkMode:', localStorage.getItem('darkMode'));
      console.log('Body classes index:', document.body.classList.toString());
      console.log('DocumentElement classes index:', document.documentElement.classList.toString());
      
      const toggleButton = document.getElementById('dark-mode-toggle');
      if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
          console.log('Click listener triggered (index)');
          // Verifica lo stato del localStorage dopo il click
          setTimeout(() => {
            const currentMode = localStorage.getItem('darkMode');
            const hasBodyDark = document.body.classList.contains('dark');
            const hasHtmlDark = document.documentElement.classList.contains('dark');
            console.log('Dopo click index - localStorage:', currentMode, 'body.dark:', hasBodyDark, 'html.dark:', hasHtmlDark);
            
            // Se c'è inconsistenza, correggi immediatamente senza transizioni
            if (currentMode === 'true' && (!hasBodyDark || !hasHtmlDark)) {
              console.log('Correzione index: attivando dark mode');
              document.body.classList.add('dark');
              document.documentElement.classList.add('dark');
              document.body.style.backgroundColor = '#000000';
              document.documentElement.style.backgroundColor = '#000000';
            } else if (currentMode === 'false' && (hasBodyDark || hasHtmlDark)) {
              console.log('Correzione index: disattivando dark mode');
              document.body.classList.remove('dark');
              document.documentElement.classList.remove('dark');
              document.body.style.backgroundColor = '';
              document.documentElement.style.backgroundColor = '';
            }
          }, 10);
        });
      }
    });
  </script>
{% endblock %}
